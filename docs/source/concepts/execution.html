<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>gdalcubes â€“ execution</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <img src="../../source/gdalcubes_logo_mini.png" alt="">
    <span class="navbar-title">gdalcubes</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../source/getstarted.html">Get started</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../source/introduction/why.html" aria-current="page">Overview</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../source/tutorials/index.html">Tutorials</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../source/reference/index.html">Reference</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false">Help</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R"><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R/issues"><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../source/introduction/faq.html"><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">FAQ</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../source/about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/appelmar/gdalcubes_R"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">(Untitled)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Overview</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/why.html" class="sidebar-item-text sidebar-link">Why gdalcubes?</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/components.html" class="sidebar-item-text sidebar-link">Components</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/installation.html" class="sidebar-item-text sidebar-link">Installation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/faq.html" class="sidebar-item-text sidebar-link">FAQ</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/license.html" class="sidebar-item-text sidebar-link">License</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/credits.html" class="sidebar-item-text sidebar-link">Credits</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Basic concepts</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/image_collections.html" class="sidebar-item-text sidebar-link">Image collections</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/collection_formats.html" class="sidebar-item-text sidebar-link">Image collection formats</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/datacubes.html" class="sidebar-item-text sidebar-link">Data cubes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/operations.html" class="sidebar-item-text sidebar-link">Data cube operations</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/execution.html" class="sidebar-item-text sidebar-link active">Execution and parallelization</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/udfs.html" class="sidebar-item-text sidebar-link">User-defined functions (UDFs)</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#execution-and-parallelization" id="toc-execution-and-parallelization" class="nav-link active" data-scroll-target="#execution-and-parallelization">Execution and parallelization</a>
  <ul class="collapse">
  <li><a href="#lazy-evaluation" id="toc-lazy-evaluation" class="nav-link" data-scroll-target="#lazy-evaluation">Lazy evaluation</a></li>
  <li><a href="#chunking" id="toc-chunking" class="nav-link" data-scroll-target="#chunking">Multidimensional chunking</a>
  <ul class="collapse">
  <li><a href="#defining-custom-chunk-sizes-in-r" id="toc-defining-custom-chunk-sizes-in-r" class="nav-link" data-scroll-target="#defining-custom-chunk-sizes-in-r">Defining custom chunk sizes in R</a></li>
  </ul></li>
  <li><a href="#parallel-execution" id="toc-parallel-execution" class="nav-link" data-scroll-target="#parallel-execution">Parallel execution</a></li>
  <li><a href="#practical-considerations" id="toc-practical-considerations" class="nav-link" data-scroll-target="#practical-considerations">Practical considerations</a></li>
  <li><a href="#gdaloptions" id="toc-gdaloptions" class="nav-link" data-scroll-target="#gdaloptions">Performance-related GDAL configuration options</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="execution-and-parallelization" class="level1">
<h1>Execution and parallelization</h1>
<section id="lazy-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="lazy-evaluation">Lazy evaluation</h2>
<p>Creating data cubes from image collections or deriving data cubes from existing data cubes using the <a href="../../source/concepts/operations.html">built-in operations</a> is computationally cheap because no pixel values will be read and no complex computations will be started. Instead, gdalcubes uses <em>proxy objects</em> that simply know the shape of a data cube, what operations they refer to, and where the data comes from. Actual computations are started when users explicitly read pixels from a data cube, e.g., by calling <a href="../../source/reference/ref/plot.cube.html"><code>plot</code></a>, <a href="../../source/reference/ref/write_ncdf.html"><code>write_ncdf</code></a>, <a href="../../source/reference/ref/write_tif.html"><code>write_tif</code></a>, <a href="../../source/reference/ref/as_array.html"><code>as_array</code></a>, or similar operations.</p>
<p>This concept is sometimes referred to as <em>lazy evaluation</em> and allows for a few optimizations when operations on data cubes are chained. For example, when plotting RGB bands only, it is possible to avoid reading any files that relate to other bands.</p>
<p>Chaining data cube operations will create a so called <em>process graph</em> that can be converted to a JSON format. The format is not particularly important for users but it allows to save virtual data cube objects (no pixel data) to disk (see <a href="operations.Rmd#savejson">here</a>).</p>
<p>Below you can find an example process graph for computing the median NDVI of pixel time series over some area in the Brazilian Amazon forest.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource {json} number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1"><a href="#cb1-1"></a>{</span>
<span id="cb1-2"><a href="#cb1-2"></a>  "cube_type": "reduce_time",</span>
<span id="cb1-3"><a href="#cb1-3"></a>  "in_cube": {</span>
<span id="cb1-4"><a href="#cb1-4"></a>      "band_names": [</span>
<span id="cb1-5"><a href="#cb1-5"></a>      "NDVI"</span>
<span id="cb1-6"><a href="#cb1-6"></a>      ],</span>
<span id="cb1-7"><a href="#cb1-7"></a>      "cube_type": "apply_pixel",</span>
<span id="cb1-8"><a href="#cb1-8"></a>      "expr": [</span>
<span id="cb1-9"><a href="#cb1-9"></a>      "(b05-b04)/(b05+b04)"</span>
<span id="cb1-10"><a href="#cb1-10"></a>      ],</span>
<span id="cb1-11"><a href="#cb1-11"></a>      "in_cube": {</span>
<span id="cb1-12"><a href="#cb1-12"></a>      "bands": [</span>
<span id="cb1-13"><a href="#cb1-13"></a>          "B04",</span>
<span id="cb1-14"><a href="#cb1-14"></a>          "B05"</span>
<span id="cb1-15"><a href="#cb1-15"></a>      ],</span>
<span id="cb1-16"><a href="#cb1-16"></a>      "cube_type": "select_bands",</span>
<span id="cb1-17"><a href="#cb1-17"></a>      "in_cube": {</span>
<span id="cb1-18"><a href="#cb1-18"></a>          "chunk_size": [</span>
<span id="cb1-19"><a href="#cb1-19"></a>          1,</span>
<span id="cb1-20"><a href="#cb1-20"></a>          256,</span>
<span id="cb1-21"><a href="#cb1-21"></a>          256</span>
<span id="cb1-22"><a href="#cb1-22"></a>          ],</span>
<span id="cb1-23"><a href="#cb1-23"></a>          "cube_type": "image_collection",</span>
<span id="cb1-24"><a href="#cb1-24"></a>          "file": "/tmp/RtmpacmRAy/file11af57b771e8.sqlite",</span>
<span id="cb1-25"><a href="#cb1-25"></a>          "view": {</span>
<span id="cb1-26"><a href="#cb1-26"></a>          "aggregation": "median",</span>
<span id="cb1-27"><a href="#cb1-27"></a>          "resampling": "bilinear",</span>
<span id="cb1-28"><a href="#cb1-28"></a>          "space": {</span>
<span id="cb1-29"><a href="#cb1-29"></a>              "bottom": -550000.0,</span>
<span id="cb1-30"><a href="#cb1-30"></a>              "left": -6180000.0,</span>
<span id="cb1-31"><a href="#cb1-31"></a>              "nx": 2000,</span>
<span id="cb1-32"><a href="#cb1-32"></a>              "ny": 2000,</span>
<span id="cb1-33"><a href="#cb1-33"></a>              "right": -6080000.0,</span>
<span id="cb1-34"><a href="#cb1-34"></a>              "srs": "EPSG:3857",</span>
<span id="cb1-35"><a href="#cb1-35"></a>              "top": -450000.0</span>
<span id="cb1-36"><a href="#cb1-36"></a>          },</span>
<span id="cb1-37"><a href="#cb1-37"></a>          "time": {</span>
<span id="cb1-38"><a href="#cb1-38"></a>              "dt": "P1Y",</span>
<span id="cb1-39"><a href="#cb1-39"></a>              "t0": "2014",</span>
<span id="cb1-40"><a href="#cb1-40"></a>              "t1": "2018"</span>
<span id="cb1-41"><a href="#cb1-41"></a>          }</span>
<span id="cb1-42"><a href="#cb1-42"></a>          },</span>
<span id="cb1-43"><a href="#cb1-43"></a>          "warp_args": []</span>
<span id="cb1-44"><a href="#cb1-44"></a>      }</span>
<span id="cb1-45"><a href="#cb1-45"></a>      },</span>
<span id="cb1-46"><a href="#cb1-46"></a>      "keep_bands": false</span>
<span id="cb1-47"><a href="#cb1-47"></a>  },</span>
<span id="cb1-48"><a href="#cb1-48"></a>  "reducer_bands": [</span>
<span id="cb1-49"><a href="#cb1-49"></a>      [</span>
<span id="cb1-50"><a href="#cb1-50"></a>      "median",</span>
<span id="cb1-51"><a href="#cb1-51"></a>      "NDVI"</span>
<span id="cb1-52"><a href="#cb1-52"></a>      ]</span>
<span id="cb1-53"><a href="#cb1-53"></a>  ]</span>
<span id="cb1-54"><a href="#cb1-54"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="chunking" class="level2">
<h2 class="anchored" data-anchor-id="chunking">Multidimensional chunking</h2>
<p>To avoid running out of memory and to allow for parallel processing, gdalcubes divides data cubes into smaller chunks. A chunk is defined by its size in the temporal and spatial dimensions and contains all bands / variables. Internally, a chunk is simply stored as a four dimensional numeric (double-precision floating-point number) array.</p>
<p><em>Empty chunks</em> that do not contain any data in most cases do not consume any memory. Data cubes in many case contain quite a large number of empty chunks for example when there is simply no satellite image available in a collection that intersects with the spatiotemporal extent of the chunk. Most data cube operations propagate empty chunks, i.e., they check if a chunk of the input cube is empty and simply forward the chunk without doing expensive computations. As a result, the data model can be seen as a <em>semi-sparse</em> array. One important consequence is that in many cases, using a higher temporal resolution (e.g.&nbsp;daily in case of Sentinel-2 data with 5 days revisit time) does not cause computations to take significantly longer.</p>
<p>While a data cube is being processed, gdalcubes simply iterates over its chunks. If the cube is the result from chained operations, the process graph is automatically traversed backwards and each chunk knows which chunks from the input cubes must be read or which images must be read.</p>
<section id="defining-custom-chunk-sizes-in-r" class="level3">
<h3 class="anchored" data-anchor-id="defining-custom-chunk-sizes-in-r">Defining custom chunk sizes in R</h3>
<p>A custom chunk size of data cubes can be set either as an additional argument <code>chunking</code> to the <code>raster_cube()</code> function, or as a global package default variable using <code>gdalcubes_options()</code>. Sizes are defined as an integer vector with 3 elements, representing the size in t, y, and x dimensions (in this order). For <code>gdalcubes_options()</code>, it is also possible to define a function that calculates the chunk size based on the size of the input cube.</p>
<p>The following examples show how to define a custom chunk size either for a specific cube, or as a global package variable.</p>
<div class="sourceCode" id="cb2" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>L8.col <span class="ot">=</span> <span class="fu">image_collection</span>(<span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">"L8.db"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>L8.col, <span class="at">srs=</span><span class="st">"EPSG:32618"</span>, <span class="at">nx =</span> <span class="dv">497</span>, <span class="at">ny=</span><span class="dv">526</span>, <span class="at">dt=</span><span class="st">"P1M"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">raster_cube</span>(L8.col, v, <span class="at">chunking =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">512</span>,<span class="dv">512</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_options</span>(<span class="at">default_chunksize =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">512</span>, <span class="dv">512</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="parallel-execution" class="level2">
<h2 class="anchored" data-anchor-id="parallel-execution">Parallel execution</h2>
<p>gdalcubes has built-in support for processing data cubes in parallel using multiple CPU cores. Users can define the maximum number of <em>worker processes</em> as a global package variable (see below). Chunks of the data cube will then be distributed among the worker processes.</p>
<div class="sourceCode" id="cb4" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="practical-considerations" class="level2">
<h2 class="anchored" data-anchor-id="practical-considerations">Practical considerations</h2>
<p>The size of data cube chunks has a strong effect on computation times and memory consumption. There is no golden rule to find an optimal chunk size, because it depends on</p>
<ul>
<li>available hardware,</li>
<li>input imagery (data format, tiling), and</li>
<li>particular analysis (how the data is accessed).</li>
</ul>
<p>By default, gdalcubes tries to find an appropriate size considering the size of the cube and the number of worker processes. However, below are some practical considerations that might be helpful to find a better chunk size:</p>
<ol type="1">
<li><p>The larger the chunks and the more parallel processes are being used, the more memory is consumed. If you run into out-of-memory issues / swapping, try decreasing one or both.</p></li>
<li><p>If you find that the number of true processes used is lower than set, the data cube might have less chunks than worker processes. You can try to decrease the chunk size to improve parallelization.</p></li>
<li><p>If the computations are I/O-bound (most time is required for disk reads / writes or downloads), try to find out the block size of the image data (e.g., with the <code>gdalinfo</code> utility) and use this as a chunk size. You also might want to try out different <a href="#gdaloptions">GDAL configuration options</a> to define how downloads and/or memory blocks are being cached.</p></li>
<li><p>There are only very few cases where chunks with temporal size greater than one improve computation times, so there is likely no need to change this.</p></li>
</ol>
</section>
<section id="gdaloptions" class="level2">
<h2 class="anchored" data-anchor-id="gdaloptions">Performance-related GDAL configuration options</h2>
<p>gdalcubes heavily relies on GDAL to read image data. GDAL itself comes with a lot of <a href="https://gdal.org/user/configoptions.html">configuration options</a> that can be set to improve computation times and I/O or network transfer performance. Below, you find the most options for gdalcubes with a brief description. Please refer to the <a href="https://gdal.org/user/configoptions.html">original documentation</a> for details.</p>
<table class="table">
<colgroup>
<col style="width: 29%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Configuration option</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>GDAL_CACHEMAX</code></td>
<td style="text-align: left;">Size of the default block cache, can be set in byte, MB, or as a percentage of available main, memory. Defaults to 256 MB</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>GDAL_DISABLE_READDIR_ON_OPEN</code></td>
<td style="text-align: left;">Set to <code>TRUE</code> or <code>EMPTY_DIR</code> to avoid listing all files in the directory once a single file is opened (<em>this is <strong>highly</strong> recommended</em>). Defaults to <code>TRUE</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>GDAL_NUM_THREADS</code></td>
<td style="text-align: left;">Number of threads GDAL can use for block reads and (de)compression, set to <code>ALL_CPUS</code> to use all available cores. Defaults to 1.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>VSI_CACHE</code></td>
<td style="text-align: left;">Enable / disable <em>per-file</em> caching by setting to <code>TRUE</code> or <code>FALSE</code>. Default is <code>FALSE</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>VSI_CACHE_SIZE</code></td>
<td style="text-align: left;"><em>Per-file</em> cache size in bytes, defaults to 25 MB.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>CPL_VSIL_CURL_CACHE_SIZE</code></td>
<td style="text-align: left;">Global cache size for downloads in bytes, defaults to 16 MB.</td>
</tr>
</tbody>
</table>
<!-- | `GTIFF_DIRECT_IO`      | | -->
<!-- | `GDAL_INGESTED_BYTES_AT_OPEN`      | | -->
<p>Please consider that settings apply for each gdalcubes worker process and you should calculate memory limits such as cache sizes accordingly. To set a configuration option, you can use <code>gdalcubes_set_gdal_config()</code> as in the following examples.</p>
<div class="sourceCode" id="cb5" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"GDAL_NUM_THREADS"</span>, <span class="st">"ALL_CPUS"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"VSI_CACHE"</span>, <span class="st">"TRUE"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"VSI_CACHE_SIZE"</span>, <span class="fu">as.character</span>(<span class="dv">5</span><span class="sc">*</span><span class="dv">1000</span><span class="sc">*</span><span class="dv">1000</span>)) <span class="co"># 5 MB per file</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"GDAL_CACHEMAX"</span>, <span class="st">"2%"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- ### AWS  -->
<!-- | Configuration option | Description                                        | -->
<!-- |:-------------------- | -------------------------------------------------- | -->
<!-- | `AWS_REQUEST_PAYER`      | Set to "requester" to allow accessing requester pays buckets on AWS  -->
<!-- | `AWS_ACCESS_KEY_ID`      | Access key | -->
<!-- | `AWS_SECRET_ACCESS_KEY`  | Secret access key | -->
<!-- | `CPL_AWS_CREDENTIALS_FILE` | Path to an AWS credentials file | -->
<!-- | `AWS_CONFIG_FILE`      | Path to an AWS config file | -->
<!-- For more details, please refer to the (GDAL /vsis3/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsis3-aws-s3-files]. -->
<!-- ### Azure  -->
<!-- | Configuration option | Description                                        | -->
<!-- |:-------------------- | -------------------------------------------------- | -->
<!-- | `AZURE_STORAGE_CONNECTION_STRING`      | String containing account name and secret key | -->
<!-- | `AZURE_STORAGE_ACCOUNT`      | Account name | -->
<!-- | `AZURE_STORAGE_ACCESS_TOKEN`      | Access token | -->
<!-- | `AZURE_STORAGE_ACCESS_KEY`      | Secret key | -->
<!-- | `AZURE_STORAGE_SAS_TOKEN` and `AZURE_SAS` |  Shared access signature that is appended to URLs |  -->
<!-- For more details, please refer to the (GDAL /vsiaz/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsiaz-microsoft-azure-blob-files]. -->
<!-- ### Google cloud  -->
<!-- | `GS_ACCESS_KEY_ID`      | Access key | -->
<!-- | `GS_SECRET_ACCESS_KEY`      | Secret access key | -->
<!-- | `GOOGLE_APPLICATION_CREDENTIALS`      | Path to a JSON file containing OAuth2 user credentials | -->
<!-- | `CPL_GS_CREDENTIALS_FILE`      | Path to a credentials file | -->
<!-- For more details, please refer to the (GDAL /vsigs/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsigs-google-cloud-storage-files]. -->


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb6" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu"># Execution and parallelization</span></span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="fu">## Lazy evaluation</span></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>Creating data cubes from image collections or deriving data cubes from existing data cubes using the <span class="co">[</span><span class="ot">built-in operations</span><span class="co">](operations.qmd)</span> is computationally cheap because no pixel values will be read and no complex computations will be started. Instead, gdalcubes uses _proxy objects_ that simply know the shape of a data cube, what operations they refer to, and where the data comes from. Actual computations are started when users explicitly read pixels from a data cube, e.g., by calling <span class="co">[</span><span class="ot">`plot`</span><span class="co">](../reference/ref/plot.cube.Rmd)</span>, <span class="co">[</span><span class="ot">`write_ncdf`</span><span class="co">](../reference/ref/write_ncdf.Rmd)</span>, <span class="co">[</span><span class="ot">`write_tif`</span><span class="co">](../reference/ref/write_tif.Rmd)</span>, <span class="co">[</span><span class="ot">`as_array`</span><span class="co">](../reference/ref/as_array.Rmd)</span>, or similar operations.</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>This concept is sometimes referred to as _lazy evaluation_ and allows for a few optimizations when operations on data cubes are chained. For example, when plotting RGB bands only, it is possible to avoid reading any files that relate to other bands. </span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>Chaining data cube operations will create a so called _process graph_ that can be converted to a JSON format.</span>
<span id="cb6-10"><a href="#cb6-10"></a>The format is not particularly important for users but it allows to save virtual data cube objects (no pixel data) to disk (see <span class="co">[</span><span class="ot">here</span><span class="co">](operations.Rmd#savejson)</span>). </span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>Below you can find an example process graph for computing the median NDVI of pixel time series over some area in the Brazilian Amazon forest.</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="in">```{json}</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>{</span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="st">"cube_type"</span><span class="op">:</span> <span class="st">"reduce_time"</span><span class="op">,</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="st">"in_cube"</span><span class="op">:</span> {</span>
<span id="cb6-20"><a href="#cb6-20"></a>      <span class="st">"band_names"</span><span class="op">:</span> [</span>
<span id="cb6-21"><a href="#cb6-21"></a>      <span class="st">"NDVI"</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>      ]<span class="op">,</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>      <span class="st">"cube_type"</span><span class="op">:</span> <span class="st">"apply_pixel"</span><span class="op">,</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>      <span class="st">"expr"</span><span class="op">:</span> [</span>
<span id="cb6-25"><a href="#cb6-25"></a>      <span class="st">"(b05-b04)/(b05+b04)"</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>      ]<span class="op">,</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>      <span class="st">"in_cube"</span><span class="op">:</span> {</span>
<span id="cb6-28"><a href="#cb6-28"></a>      <span class="st">"bands"</span><span class="op">:</span> [</span>
<span id="cb6-29"><a href="#cb6-29"></a>          <span class="st">"B04"</span><span class="op">,</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>          <span class="st">"B05"</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>      ]<span class="op">,</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>      <span class="st">"cube_type"</span><span class="op">:</span> <span class="st">"select_bands"</span><span class="op">,</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>      <span class="st">"in_cube"</span><span class="op">:</span> {</span>
<span id="cb6-34"><a href="#cb6-34"></a>          <span class="st">"chunk_size"</span><span class="op">:</span> [</span>
<span id="cb6-35"><a href="#cb6-35"></a>          <span class="dv">1</span><span class="op">,</span></span>
<span id="cb6-36"><a href="#cb6-36"></a>          <span class="dv">256</span><span class="op">,</span></span>
<span id="cb6-37"><a href="#cb6-37"></a>          <span class="dv">256</span></span>
<span id="cb6-38"><a href="#cb6-38"></a>          ]<span class="op">,</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>          <span class="st">"cube_type"</span><span class="op">:</span> <span class="st">"image_collection"</span><span class="op">,</span></span>
<span id="cb6-40"><a href="#cb6-40"></a>          <span class="st">"file"</span><span class="op">:</span> <span class="st">"/tmp/RtmpacmRAy/file11af57b771e8.sqlite"</span><span class="op">,</span></span>
<span id="cb6-41"><a href="#cb6-41"></a>          <span class="st">"view"</span><span class="op">:</span> {</span>
<span id="cb6-42"><a href="#cb6-42"></a>          <span class="st">"aggregation"</span><span class="op">:</span> <span class="st">"median"</span><span class="op">,</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>          <span class="st">"resampling"</span><span class="op">:</span> <span class="st">"bilinear"</span><span class="op">,</span></span>
<span id="cb6-44"><a href="#cb6-44"></a>          <span class="st">"space"</span><span class="op">:</span> {</span>
<span id="cb6-45"><a href="#cb6-45"></a>              <span class="st">"bottom"</span><span class="op">:</span> <span class="op">-</span><span class="fl">550000.0</span><span class="op">,</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>              <span class="st">"left"</span><span class="op">:</span> <span class="op">-</span><span class="fl">6180000.0</span><span class="op">,</span></span>
<span id="cb6-47"><a href="#cb6-47"></a>              <span class="st">"nx"</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb6-48"><a href="#cb6-48"></a>              <span class="st">"ny"</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb6-49"><a href="#cb6-49"></a>              <span class="st">"right"</span><span class="op">:</span> <span class="op">-</span><span class="fl">6080000.0</span><span class="op">,</span></span>
<span id="cb6-50"><a href="#cb6-50"></a>              <span class="st">"srs"</span><span class="op">:</span> <span class="st">"EPSG:3857"</span><span class="op">,</span></span>
<span id="cb6-51"><a href="#cb6-51"></a>              <span class="st">"top"</span><span class="op">:</span> <span class="op">-</span><span class="fl">450000.0</span></span>
<span id="cb6-52"><a href="#cb6-52"></a>          }<span class="op">,</span></span>
<span id="cb6-53"><a href="#cb6-53"></a>          <span class="st">"time"</span><span class="op">:</span> {</span>
<span id="cb6-54"><a href="#cb6-54"></a>              <span class="st">"dt"</span><span class="op">:</span> <span class="st">"P1Y"</span><span class="op">,</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>              <span class="st">"t0"</span><span class="op">:</span> <span class="st">"2014"</span><span class="op">,</span></span>
<span id="cb6-56"><a href="#cb6-56"></a>              <span class="st">"t1"</span><span class="op">:</span> <span class="st">"2018"</span></span>
<span id="cb6-57"><a href="#cb6-57"></a>          }</span>
<span id="cb6-58"><a href="#cb6-58"></a>          }<span class="op">,</span></span>
<span id="cb6-59"><a href="#cb6-59"></a>          <span class="st">"warp_args"</span><span class="op">:</span> []</span>
<span id="cb6-60"><a href="#cb6-60"></a>      }</span>
<span id="cb6-61"><a href="#cb6-61"></a>      }<span class="op">,</span></span>
<span id="cb6-62"><a href="#cb6-62"></a>      <span class="st">"keep_bands"</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb6-63"><a href="#cb6-63"></a>  }<span class="op">,</span></span>
<span id="cb6-64"><a href="#cb6-64"></a>  <span class="st">"reducer_bands"</span><span class="op">:</span> [</span>
<span id="cb6-65"><a href="#cb6-65"></a>      [</span>
<span id="cb6-66"><a href="#cb6-66"></a>      <span class="st">"median"</span><span class="op">,</span></span>
<span id="cb6-67"><a href="#cb6-67"></a>      <span class="st">"NDVI"</span></span>
<span id="cb6-68"><a href="#cb6-68"></a>      ]</span>
<span id="cb6-69"><a href="#cb6-69"></a>  ]</span>
<span id="cb6-70"><a href="#cb6-70"></a>}</span>
<span id="cb6-71"><a href="#cb6-71"></a><span class="vs">```</span></span>
<span id="cb6-72"><a href="#cb6-72"></a></span>
<span id="cb6-73"><a href="#cb6-73"></a></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="vs">## Multidimensional chunking {#chunking}</span></span>
<span id="cb6-75"><a href="#cb6-75"></a></span>
<span id="cb6-76"><a href="#cb6-76"></a><span class="vs">To avoid running out of memory and to allow for parallel processing, gdalcubes divides data cubes into smaller chunks. A chunk is defined by its size in the temporal and spatial dimensions and contains all bands / variables. Internally, a chunk is simply stored as a four dimensional numeric (double-precision floating-point number) array. </span></span>
<span id="cb6-77"><a href="#cb6-77"></a></span>
<span id="cb6-78"><a href="#cb6-78"></a><span class="vs">_Empty chunks_ that do not contain any data in most cases do not consume any memory. Data cubes in many case contain quite a large number of empty chunks for example when there is simply no satellite image available in a collection that intersects with the spatiotemporal extent of the chunk. Most data cube operations propagate empty chunks, i.e., they check if a chunk of the input cube is empty and simply forward the chunk without doing expensive computations. As a result, the data model can be seen as a _semi-sparse_ array. One important consequence is that in many cases, using a higher temporal resolution (e.g. daily in case of Sentinel-2 data with 5 days revisit time) does not cause computations to take significantly longer. </span></span>
<span id="cb6-79"><a href="#cb6-79"></a></span>
<span id="cb6-80"><a href="#cb6-80"></a></span>
<span id="cb6-81"><a href="#cb6-81"></a><span class="vs">While a data cube is being processed, gdalcubes simply iterates over its chunks. If the cube is the result from chained operations, the process graph is automatically traversed backwards and each chunk knows which chunks from the input cubes must be read or which images must be read. </span></span>
<span id="cb6-82"><a href="#cb6-82"></a></span>
<span id="cb6-83"><a href="#cb6-83"></a></span>
<span id="cb6-84"><a href="#cb6-84"></a><span class="vs">### Defining custom chunk sizes in R</span></span>
<span id="cb6-85"><a href="#cb6-85"></a></span>
<span id="cb6-86"><a href="#cb6-86"></a><span class="vs">A custom chunk size of data cubes can be set either as an additional argument `</span><span class="fu">chunking</span><span class="vs">` to the `</span><span class="fu">raster_cube</span>()<span class="vs">` function, or as a global package default variable using `</span><span class="fu">gdalcubes_options</span>()<span class="vs">`. Sizes are defined as an integer vector with 3 elements, representing the size in t, y, and x dimensions (in this order). For `</span><span class="fu">gdalcubes_options</span>()<span class="vs">`, it is also possible to define a function that calculates the chunk size based on the size of the input cube. </span></span>
<span id="cb6-87"><a href="#cb6-87"></a></span>
<span id="cb6-88"><a href="#cb6-88"></a><span class="vs">The following examples show how to define a custom chunk size either for a specific cube, or as a global package variable.</span></span>
<span id="cb6-89"><a href="#cb6-89"></a></span>
<span id="cb6-90"><a href="#cb6-90"></a><span class="vs">```</span>{<span class="op">.</span><span class="at">r</span> code<span class="op">-</span>line<span class="op">-</span>numbers<span class="op">=</span><span class="st">"false"</span>}</span>
<span id="cb6-91"><a href="#cb6-91"></a>L8<span class="op">.</span><span class="at">col</span> <span class="op">=</span> <span class="fu">image_collection</span>(file<span class="op">.</span><span class="fu">path</span>(<span class="fu">tempdir</span>()<span class="op">,</span> <span class="st">"L8.db"</span>))</span>
<span id="cb6-92"><a href="#cb6-92"></a>v <span class="op">=</span> <span class="fu">cube_view</span>(extent<span class="op">=</span>L8<span class="op">.</span><span class="at">col</span><span class="op">,</span> srs<span class="op">=</span><span class="st">"EPSG:32618"</span><span class="op">,</span> nx <span class="op">=</span> <span class="dv">497</span><span class="op">,</span> ny<span class="op">=</span><span class="dv">526</span><span class="op">,</span> dt<span class="op">=</span><span class="st">"P1M"</span>)</span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="fu">raster_cube</span>(L8<span class="op">.</span><span class="at">col</span><span class="op">,</span> v<span class="op">,</span> chunking <span class="op">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">512</span><span class="op">,</span><span class="dv">512</span>))</span>
<span id="cb6-94"><a href="#cb6-94"></a><span class="vs">```</span></span>
<span id="cb6-95"><a href="#cb6-95"></a></span>
<span id="cb6-96"><a href="#cb6-96"></a><span class="vs">```</span>{<span class="op">.</span><span class="at">r</span> code<span class="op">-</span>line<span class="op">-</span>numbers<span class="op">=</span><span class="st">"false"</span>}</span>
<span id="cb6-97"><a href="#cb6-97"></a><span class="fu">gdalcubes_options</span>(default_chunksize <span class="op">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">512</span><span class="op">,</span> <span class="dv">512</span>))</span>
<span id="cb6-98"><a href="#cb6-98"></a><span class="vs">```</span></span>
<span id="cb6-99"><a href="#cb6-99"></a></span>
<span id="cb6-100"><a href="#cb6-100"></a></span>
<span id="cb6-101"><a href="#cb6-101"></a></span>
<span id="cb6-102"><a href="#cb6-102"></a></span>
<span id="cb6-103"><a href="#cb6-103"></a><span class="vs">## Parallel execution</span></span>
<span id="cb6-104"><a href="#cb6-104"></a></span>
<span id="cb6-105"><a href="#cb6-105"></a><span class="vs">gdalcubes has built-in support for processing data cubes in parallel using multiple CPU cores.</span></span>
<span id="cb6-106"><a href="#cb6-106"></a><span class="vs">Users can define the maximum number of _worker processes_ as a global package variable (see below). Chunks of the data cube will then be distributed among the worker processes. </span></span>
<span id="cb6-107"><a href="#cb6-107"></a></span>
<span id="cb6-108"><a href="#cb6-108"></a><span class="vs">```</span>{<span class="op">.</span><span class="at">r</span> code<span class="op">-</span>line<span class="op">-</span>numbers<span class="op">=</span><span class="st">"false"</span>}</span>
<span id="cb6-109"><a href="#cb6-109"></a><span class="fu">gdalcubes_options</span>(parallel <span class="op">=</span> <span class="dv">8</span>)</span>
<span id="cb6-110"><a href="#cb6-110"></a><span class="vs">```</span></span>
<span id="cb6-111"><a href="#cb6-111"></a></span>
<span id="cb6-112"><a href="#cb6-112"></a></span>
<span id="cb6-113"><a href="#cb6-113"></a><span class="vs">## Practical considerations</span></span>
<span id="cb6-114"><a href="#cb6-114"></a></span>
<span id="cb6-115"><a href="#cb6-115"></a><span class="vs">The size of data cube chunks has a strong effect on computation times and memory consumption.</span></span>
<span id="cb6-116"><a href="#cb6-116"></a><span class="vs">There is no golden rule to find an optimal chunk size, because it depends on</span></span>
<span id="cb6-117"><a href="#cb6-117"></a></span>
<span id="cb6-118"><a href="#cb6-118"></a><span class="vs">- available hardware,</span></span>
<span id="cb6-119"><a href="#cb6-119"></a><span class="vs">- input imagery (data format, tiling), and</span></span>
<span id="cb6-120"><a href="#cb6-120"></a><span class="vs">- particular analysis (how the data is accessed).</span></span>
<span id="cb6-121"><a href="#cb6-121"></a></span>
<span id="cb6-122"><a href="#cb6-122"></a><span class="vs">By default, gdalcubes tries to find an appropriate size considering the size of the cube and the number of worker processes. However, below are some practical considerations that might be helpful to find a better chunk size:</span></span>
<span id="cb6-123"><a href="#cb6-123"></a></span>
<span id="cb6-124"><a href="#cb6-124"></a><span class="vs">1. The larger the chunks and the more parallel processes are being used, the more memory is consumed. If you run into out-of-memory issues / swapping, try decreasing one or both.</span></span>
<span id="cb6-125"><a href="#cb6-125"></a></span>
<span id="cb6-126"><a href="#cb6-126"></a><span class="vs">2. If you find that the number of true processes used is lower than set, the data cube might have less chunks than worker processes. You can try to decrease the chunk size to improve parallelization.</span></span>
<span id="cb6-127"><a href="#cb6-127"></a></span>
<span id="cb6-128"><a href="#cb6-128"></a><span class="vs">3. If the computations are I/O-bound (most time is required for disk reads / writes or downloads), try to find out the block size of the image data (e.g., with the `</span><span class="fu">gdalinfo</span><span class="vs">` utility) and use this as a chunk size. You also might want to try out different [GDAL configuration options](#gdaloptions) to define how downloads and/or memory blocks are being cached. </span></span>
<span id="cb6-129"><a href="#cb6-129"></a></span>
<span id="cb6-130"><a href="#cb6-130"></a><span class="vs">4. There are only very few cases where chunks with temporal size greater than one improve computation times, so there is likely no need to change this. </span></span>
<span id="cb6-131"><a href="#cb6-131"></a></span>
<span id="cb6-132"><a href="#cb6-132"></a></span>
<span id="cb6-133"><a href="#cb6-133"></a><span class="vs">## Performance-related GDAL configuration options {#gdaloptions}</span></span>
<span id="cb6-134"><a href="#cb6-134"></a></span>
<span id="cb6-135"><a href="#cb6-135"></a><span class="vs">gdalcubes heavily relies on GDAL to read image data. GDAL itself comes with a lot of </span></span>
<span id="cb6-136"><a href="#cb6-136"></a><span class="vs">[configuration options](https://gdal.org/user/configoptions.html) that can be set to improve computation times and I/O or network transfer performance. Below, you find the most options for gdalcubes with a brief description. Please refer to the [original documentation](https://gdal.org/user/configoptions.html) for details.</span></span>
<span id="cb6-137"><a href="#cb6-137"></a></span>
<span id="cb6-138"><a href="#cb6-138"></a><span class="vs">| Configuration option | Description                                        | </span></span>
<span id="cb6-139"><a href="#cb6-139"></a><span class="vs">|:-------------------- |:-------------------------------------------------- |</span></span>
<span id="cb6-140"><a href="#cb6-140"></a><span class="vs">| `</span><span class="fu">GDAL_CACHEMAX</span><span class="vs">`      | Size of the default block cache, can be set in byte, MB, or as a percentage of available main,  memory. Defaults to 256 MB | </span></span>
<span id="cb6-141"><a href="#cb6-141"></a><span class="vs">| `</span><span class="fu">GDAL_DISABLE_READDIR_ON_OPEN</span><span class="vs">` | Set to `</span><span class="fu">TRUE</span><span class="vs">` or `</span><span class="fu">EMPTY_DIR</span><span class="vs">` to avoid listing all files in the directory once a single file is opened (_this is **highly** recommended_). Defaults to `</span><span class="fu">TRUE</span><span class="vs">`  |                                   |</span></span>
<span id="cb6-142"><a href="#cb6-142"></a><span class="vs">| `</span><span class="fu">GDAL_NUM_THREADS</span><span class="vs">`      | Number of threads GDAL can use for block reads and (de)compression, set to `</span><span class="fu">ALL_CPUS</span><span class="vs">` to use all available cores. Defaults to 1. |</span></span>
<span id="cb6-143"><a href="#cb6-143"></a><span class="vs">| `</span><span class="fu">VSI_CACHE</span><span class="vs">`      | Enable / disable _per-file_ caching by setting to `</span><span class="fu">TRUE</span><span class="vs">` or `</span><span class="fu">FALSE</span><span class="vs">`. Default is `</span><span class="fu">FALSE</span><span class="vs">`.|</span></span>
<span id="cb6-144"><a href="#cb6-144"></a><span class="vs">| `</span><span class="fu">VSI_CACHE_SIZE</span><span class="vs">`      | _Per-file_ cache size in bytes, defaults to 25 MB. |</span></span>
<span id="cb6-145"><a href="#cb6-145"></a><span class="vs">| `</span><span class="fu">CPL_VSIL_CURL_CACHE_SIZE</span><span class="vs">`      | Global cache size for downloads in bytes, defaults to 16 MB. |</span></span>
<span id="cb6-146"><a href="#cb6-146"></a></span>
<span id="cb6-147"><a href="#cb6-147"></a></span>
<span id="cb6-148"><a href="#cb6-148"></a><span class="vs">&lt;!-- | `</span><span class="fu">GTIFF_DIRECT_IO</span><span class="vs">`      | | --&gt;</span></span>
<span id="cb6-149"><a href="#cb6-149"></a><span class="vs">&lt;!-- | `</span><span class="fu">GDAL_INGESTED_BYTES_AT_OPEN</span><span class="vs">`      | | --&gt;</span></span>
<span id="cb6-150"><a href="#cb6-150"></a></span>
<span id="cb6-151"><a href="#cb6-151"></a></span>
<span id="cb6-152"><a href="#cb6-152"></a><span class="vs">Please consider that settings apply for each gdalcubes worker process and you should calculate memory limits such as cache sizes accordingly. To set a configuration option, you can use `</span><span class="fu">gdalcubes_set_gdal_config</span>()<span class="vs">` as in the following examples.</span></span>
<span id="cb6-153"><a href="#cb6-153"></a></span>
<span id="cb6-154"><a href="#cb6-154"></a></span>
<span id="cb6-155"><a href="#cb6-155"></a><span class="vs">```</span>{<span class="op">.</span><span class="at">r</span> code<span class="op">-</span>line<span class="op">-</span>numbers<span class="op">=</span><span class="st">"false"</span>}</span>
<span id="cb6-156"><a href="#cb6-156"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"GDAL_NUM_THREADS"</span><span class="op">,</span> <span class="st">"ALL_CPUS"</span>)</span>
<span id="cb6-157"><a href="#cb6-157"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"VSI_CACHE"</span><span class="op">,</span> <span class="st">"TRUE"</span>)</span>
<span id="cb6-158"><a href="#cb6-158"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"VSI_CACHE_SIZE"</span><span class="op">,</span> <span class="im">as</span><span class="op">.</span><span class="fu">character</span>(<span class="dv">5</span><span class="op">*</span><span class="dv">1000</span><span class="op">*</span><span class="dv">1000</span>)) # <span class="dv">5</span> MB per file</span>
<span id="cb6-159"><a href="#cb6-159"></a><span class="fu">gdalcubes_set_gdal_config</span>(<span class="st">"GDAL_CACHEMAX"</span><span class="op">,</span> <span class="st">"2%"</span>) </span>
<span id="cb6-160"><a href="#cb6-160"></a><span class="vs">```</span></span>
<span id="cb6-161"><a href="#cb6-161"></a></span>
<span id="cb6-162"><a href="#cb6-162"></a></span>
<span id="cb6-163"><a href="#cb6-163"></a></span>
<span id="cb6-164"><a href="#cb6-164"></a></span>
<span id="cb6-165"><a href="#cb6-165"></a></span>
<span id="cb6-166"><a href="#cb6-166"></a></span>
<span id="cb6-167"><a href="#cb6-167"></a></span>
<span id="cb6-168"><a href="#cb6-168"></a><span class="vs">&lt;!-- ### AWS  --&gt;</span></span>
<span id="cb6-169"><a href="#cb6-169"></a></span>
<span id="cb6-170"><a href="#cb6-170"></a><span class="vs">&lt;!-- | Configuration option | Description                                        | --&gt;</span></span>
<span id="cb6-171"><a href="#cb6-171"></a><span class="vs">&lt;!-- |:-------------------- | -------------------------------------------------- | --&gt;</span></span>
<span id="cb6-172"><a href="#cb6-172"></a><span class="vs">&lt;!-- | `</span><span class="fu">AWS_REQUEST_PAYER</span><span class="vs">`      | Set to "requester" to allow accessing requester pays buckets on AWS  --&gt;</span></span>
<span id="cb6-173"><a href="#cb6-173"></a><span class="vs">&lt;!-- | `</span><span class="fu">AWS_ACCESS_KEY_ID</span><span class="vs">`      | Access key | --&gt;</span></span>
<span id="cb6-174"><a href="#cb6-174"></a><span class="vs">&lt;!-- | `</span><span class="fu">AWS_SECRET_ACCESS_KEY</span><span class="vs">`  | Secret access key | --&gt;</span></span>
<span id="cb6-175"><a href="#cb6-175"></a><span class="vs">&lt;!-- | `</span><span class="fu">CPL_AWS_CREDENTIALS_FILE</span><span class="vs">` | Path to an AWS credentials file | --&gt;</span></span>
<span id="cb6-176"><a href="#cb6-176"></a><span class="vs">&lt;!-- | `</span><span class="fu">AWS_CONFIG_FILE</span><span class="vs">`      | Path to an AWS config file | --&gt;</span></span>
<span id="cb6-177"><a href="#cb6-177"></a></span>
<span id="cb6-178"><a href="#cb6-178"></a><span class="vs">&lt;!-- For more details, please refer to the (GDAL /vsis3/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsis3-aws-s3-files]. --&gt;</span></span>
<span id="cb6-179"><a href="#cb6-179"></a></span>
<span id="cb6-180"><a href="#cb6-180"></a></span>
<span id="cb6-181"><a href="#cb6-181"></a><span class="vs">&lt;!-- ### Azure  --&gt;</span></span>
<span id="cb6-182"><a href="#cb6-182"></a></span>
<span id="cb6-183"><a href="#cb6-183"></a><span class="vs">&lt;!-- | Configuration option | Description                                        | --&gt;</span></span>
<span id="cb6-184"><a href="#cb6-184"></a><span class="vs">&lt;!-- |:-------------------- | -------------------------------------------------- | --&gt;</span></span>
<span id="cb6-185"><a href="#cb6-185"></a><span class="vs">&lt;!-- | `</span><span class="fu">AZURE_STORAGE_CONNECTION_STRING</span><span class="vs">`      | String containing account name and secret key | --&gt;</span></span>
<span id="cb6-186"><a href="#cb6-186"></a><span class="vs">&lt;!-- | `</span><span class="fu">AZURE_STORAGE_ACCOUNT</span><span class="vs">`      | Account name | --&gt;</span></span>
<span id="cb6-187"><a href="#cb6-187"></a><span class="vs">&lt;!-- | `</span><span class="fu">AZURE_STORAGE_ACCESS_TOKEN</span><span class="vs">`      | Access token | --&gt;</span></span>
<span id="cb6-188"><a href="#cb6-188"></a><span class="vs">&lt;!-- | `</span><span class="fu">AZURE_STORAGE_ACCESS_KEY</span><span class="vs">`      | Secret key | --&gt;</span></span>
<span id="cb6-189"><a href="#cb6-189"></a><span class="vs">&lt;!-- | `</span><span class="fu">AZURE_STORAGE_SAS_TOKEN</span><span class="vs">` and `</span><span class="fu">AZURE_SAS</span><span class="vs">` |  Shared access signature that is appended to URLs |  --&gt;</span></span>
<span id="cb6-190"><a href="#cb6-190"></a></span>
<span id="cb6-191"><a href="#cb6-191"></a><span class="vs">&lt;!-- For more details, please refer to the (GDAL /vsiaz/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsiaz-microsoft-azure-blob-files]. --&gt;</span></span>
<span id="cb6-192"><a href="#cb6-192"></a></span>
<span id="cb6-193"><a href="#cb6-193"></a></span>
<span id="cb6-194"><a href="#cb6-194"></a><span class="vs">&lt;!-- ### Google cloud  --&gt;</span></span>
<span id="cb6-195"><a href="#cb6-195"></a></span>
<span id="cb6-196"><a href="#cb6-196"></a><span class="vs">&lt;!-- | `</span><span class="fu">GS_ACCESS_KEY_ID</span><span class="vs">`      | Access key | --&gt;</span></span>
<span id="cb6-197"><a href="#cb6-197"></a><span class="vs">&lt;!-- | `</span><span class="fu">GS_SECRET_ACCESS_KEY</span><span class="vs">`      | Secret access key | --&gt;</span></span>
<span id="cb6-198"><a href="#cb6-198"></a><span class="vs">&lt;!-- | `</span><span class="fu">GOOGLE_APPLICATION_CREDENTIALS</span><span class="vs">`      | Path to a JSON file containing OAuth2 user credentials | --&gt;</span></span>
<span id="cb6-199"><a href="#cb6-199"></a><span class="vs">&lt;!-- | `</span><span class="fu">CPL_GS_CREDENTIALS_FILE</span><span class="vs">`      | Path to a credentials file | --&gt;</span></span>
<span id="cb6-200"><a href="#cb6-200"></a></span>
<span id="cb6-201"><a href="#cb6-201"></a><span class="vs">&lt;!-- For more details, please refer to the (GDAL /vsigs/ documentation )[https://gdal.org/user/virtual_file_systems.html#vsigs-google-cloud-storage-files]. --&gt;</span></span>
<span id="cb6-202"><a href="#cb6-202"></a></span>
<span id="cb6-203"><a href="#cb6-203"></a></span>
<span id="cb6-204"><a href="#cb6-204"></a></span>
<span id="cb6-205"><a href="#cb6-205"></a></span>
<span id="cb6-206"><a href="#cb6-206"></a></span>
<span id="cb6-207"><a href="#cb6-207"></a></span>
<span id="cb6-208"><a href="#cb6-208"></a></span>
<span id="cb6-209"><a href="#cb6-209"></a></span>
<span id="cb6-210"><a href="#cb6-210"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Â© 2022 Marius Appel
  </li>  
</ul>
      </div>
  </div>
</footer>



</body></html>