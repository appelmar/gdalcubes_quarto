<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>gdalcubes – datacubes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../source/concepts/operations.html" rel="next">
<link href="../../source/concepts/collection_formats.html" rel="prev">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../source/gdalcubes_logo_mini.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">gdalcubes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../source/getstarted.html" rel="" target="">
 <span class="menu-text">Get started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../source/introduction/why.html" rel="" target="" aria-current="page">
 <span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../source/tutorials/index.html" rel="" target="">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../source/reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R/issues" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../source/introduction/faq.html" rel="" target=""><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">FAQ</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../source/about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../source/concepts/image_collections.html">Basic concepts</a></li><li class="breadcrumb-item"><a href="../../source/concepts/datacubes.html">Data cubes</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Overview</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/why.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Why gdalcubes?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/components.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Components</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/faq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FAQ</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/credits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Credits</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Basic concepts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/image_collections.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image collections</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/collection_formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image collection formats</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/datacubes.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Data cubes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data cube operations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Execution and parallelization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/udfs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User-defined functions (UDFs)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/config.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configuration options</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-cubes" id="toc-data-cubes" class="nav-link active" data-scroll-target="#data-cubes">Data cubes</a>
  <ul class="collapse">
  <li><a href="#spatiotemporal-reference" id="toc-spatiotemporal-reference" class="nav-link" data-scroll-target="#spatiotemporal-reference">Spatiotemporal reference</a>
  <ul class="collapse">
  <li><a href="#handling-datetime" id="toc-handling-datetime" class="nav-link" data-scroll-target="#handling-datetime">Handling date/time</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a></li>
  </ul></li>
  <li><a href="#datacube_creation" id="toc-datacube_creation" class="nav-link" data-scroll-target="#datacube_creation">Creating data cubes from image collections</a>
  <ul class="collapse">
  <li><a href="#aggregation-and-resampling" id="toc-aggregation-and-resampling" class="nav-link" data-scroll-target="#aggregation-and-resampling">Aggregation and resampling</a></li>
  <li><a href="#image-masks" id="toc-image-masks" class="nav-link" data-scroll-target="#image-masks">Image masks</a></li>
  <li><a href="#examples-1" id="toc-examples-1" class="nav-link" data-scroll-target="#examples-1">Examples</a></li>
  </ul></li>
  <li><a href="#indexing-data-cubes" id="toc-indexing-data-cubes" class="nav-link" data-scroll-target="#indexing-data-cubes">Indexing data cubes</a>
  <ul class="collapse">
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><div class="quarto-title-block"><div class="quarto-title-tools-only"><h1></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>



<section id="data-cubes" class="level1">
<h1>Data cubes</h1>
<p>gdalcubes implements <em>regular dense raster data cubes</em>, making the following assumptions <span class="citation" data-cites="appel2019">(<a href="#ref-appel2019" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>:</p>
<ol type="1">
<li>Spatial dimensions refer to a single spatial reference system (SRS);</li>
<li>Cells of a data cube have a constant spatial size (with regard to the cube’s SRS);</li>
<li>The spatial reference is defined by a simple offset and the cell size per axis, i.e., the cube axes are aligned with the SRS axes;</li>
<li>Cells of a data cube have a constant temporal duration, defined by an integer number and a date or time unit (years, months, days, hours, minutes, or seconds);</li>
<li>The temporal reference is defined by a simple start date/time and the temporal duration of cells;</li>
<li>For every combination of dimensions, a cell has a single, scalar (real) attribute value.</li>
</ol>
<p>Data cubes are always four-dimensional (bands, time, y, x).</p>
<div id="fig-datacube" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="cube.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: A single four-dimensional raster data cube.</figcaption>
</figure>
</div>
<section id="spatiotemporal-reference" class="level2">
<h2 class="anchored" data-anchor-id="spatiotemporal-reference">Spatiotemporal reference</h2>
<p>Before creating a cube, users must define its spatiotemporal geometry as a so called <em>data cube view</em>, without connecting it to specific datasets. The data cube view contains</p>
<ul>
<li>the spatial reference system (SRS),</li>
<li>the spatiotemporal extent (left, right, bottom, top, start date/time, end date/time), and</li>
<li>the spatiotemporal size of pixels (spatial size, temporal duration).</li>
</ul>
<p>The resolution of dimensions can be specified either by the number of pixels (nx, ny, nt), or by the size of pixels (dx, dy, dt). If the size of the extent in one dimension does not align with the corresponding pixel size, the extent will be enlarged accordingly. For example, assuming <code>left = 1</code>, <code>right = 10</code>, and <code>dx = 2</code>, pixels would start at <code>x = [1,3,5,7,9]</code> such that the last pixel would have size 1. In this case, the extent would be replaced by <code>left=0.5</code>, <code>right=10.5</code>, such that pixels start at <code>x = [0.5, 2.5, 4.5, 6.5, 8.5]</code> and all pixels have size 2.</p>
<p>Please notice that the cube view does <em>not</em> include any information on the band dimension, i.e., the cube view is independent of particular data products.</p>
<section id="handling-datetime" class="level3">
<h3 class="anchored" data-anchor-id="handling-datetime">Handling date/time</h3>
<p>The temporal duration of pixels (dt) includes a temporal unit (or <em>granularity</em>). Following ISO 8601 durations, it is defined as a string starting with “P” (period), followed by an integer number and a unit (one of “Y”, “M”, “D”, “TH”, “TM”, “TS”). In contrast to ISO 8601, gdalcubes does <strong>not</strong> allow to mix several units. For example, the duration <code>"P1M10DT2H"</code> (one month, 10 days, and 2 hours) will produce an error.</p>
<p>If dt uses a larger datetime unit than t0 and t1, the temporal extent is enlarged. For instance, defining <code>t0 = "2019-03-05"</code>, <code>t1 = "2019-06-05"</code>, and monthly temporal resolution <code>dt = "P1M"</code>, will lead to the extent <code>t0 = "2019-03"</code> and <code>t1 = "2019-06"</code>, such that the data cube covers the full March and June of 2019.</p>
</section>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples</h3>
<p>The spatiotemporal reference of a cube can be set using the <code>cube_view()</code> function, as in the examples below.</p>
<div class="sourceCode" id="cb1" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:4326"</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">extent =</span> <span class="fu">list</span>(<span class="at">left =</span> <span class="dv">6</span>, <span class="at">right =</span> <span class="dv">7</span>, <span class="at">bottom =</span> <span class="dv">50</span>, <span class="at">top =</span> <span class="dv">51</span>, </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">t0 =</span> <span class="st">"2022-01-01"</span>, <span class="at">t1 =</span> <span class="st">"2022-04-30"</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">dx =</span> <span class="fl">0.01</span>, <span class="at">dy =</span> <span class="fl">0.01</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>v1 <span class="ot">=</span> <span class="fu">cube_view</span>(v, <span class="at">dt =</span> <span class="st">"P1M"</span>) <span class="co"># modify existing data cube view object</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>w <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:3857"</span>, </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">extent =</span> collection, <span class="co"># use extent from an image collection</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">dx =</span> <span class="dv">100</span>, <span class="at">dy =</span>  <span class="dv">100</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="datacube_creation" class="level2">
<h2 class="anchored" data-anchor-id="datacube_creation">Creating data cubes from image collections</h2>
<p>Combining a <em>data cube view</em> with an <em>image collection</em> yields a regular raster data cube with band data from the image collection and geometry from the data cube view.</p>
<p>To read values of data cube <a href="../../source/concepts/execution.html#chunking">chunk</a> from an image collection, the following algorithm is used <span class="citation" data-cites="appel2019">(<a href="#ref-appel2019" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>:</p>
<ol type="1">
<li><p>Allocate and initialize an in-memory chunk buffer for the resulting chunk data (a four-dimensional bands, t, y, x array);</p></li>
<li><p>Find all images of the collection that intersect with the spatiotemporal extent of the chunk;</p></li>
<li><p>For all images found:</p>
<p>3.1. Crop, reproject, and resample according to the spatiotemporal extent of the chunk and the data cube view and store the result as an in-memory three-dimensional (bands, y, x) array;</p>
<p>3.2. Copy the result to the chunk buffer at the correct temporal slice. If the chunk buffer already contains values at the target position, update a pixel-wise aggregator (e.g., mean, median, min., max.) to combine pixel values from multiple images which are written to the same cell in the data cube.</p></li>
<li><p>Finalize the pixel-wise aggregator if needed (e.g., divide pixel values by n for mean aggregation).</p></li>
</ol>
<section id="aggregation-and-resampling" class="level3">
<h3 class="anchored" data-anchor-id="aggregation-and-resampling">Aggregation and resampling</h3>
<p>To build regular data cubes from image collections, individual images are reprojected, rescaled, cropped, and resampled with regard to the data cube view first. Afterwards, pixel values of several images that are located within the same data cube cell (i.e.&nbsp;from different days in the same month) are combined by an aggregation function. Methods for both, spatial <em>resampling</em> and temporal <em>aggregation</em> can be provided in the data cube view. gdalcubes supports all <a href="https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r">resampling methods implemented in GDAL</a>. Supported aggregation methods include <code>"first"</code>, <code>"min"</code>, <code>"max"</code>, <code>"median"</code>, <code>"mean"</code>, and <code>"last"</code>.</p>
</section>
<section id="image-masks" class="level3">
<h3 class="anchored" data-anchor-id="image-masks">Image masks</h3>
<p>When data products include mask bands, pixel-wise quality flags, cloud probability layers, or similar, these can be used to filter pixels of images contributing the data cube cells. In gdalcubes, masks can be defined by band name and a set of mask values (or a value range). If a pixel’s mask band value is within the set of values, this pixel is ignored. Masks can be inverted, such that only pixels for which the value of the mask band is within the provided set will be used. Additionally, a bitwise AND can be applied to extract specific bits of a bit mask only (e.g.&nbsp;for MODIS quality flag bands).</p>
<p>Notice that the masks are applied on images, not on cubes (during step 3.1 in the <a href="#datacube_creation">aforementioned algorithm</a>). As such, masked values simply will not contribute to the pixel-wise aggregation.</p>
</section>
<section id="examples-1" class="level3">
<h3 class="anchored" data-anchor-id="examples-1">Examples</h3>
<p>The following example combines an image collection and a data cube view to create a data cube using <code>raster_cube()</code>.</p>
<div class="sourceCode" id="cb2" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>collection <span class="ot">=</span> <span class="fu">image_collection</span>(<span class="st">"/path/to/collection.db"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:3857"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">extent =</span> collection, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">dx =</span> <span class="dv">100</span>, <span class="at">dy =</span>  <span class="dv">100</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">raster_cube</span>(collection, v) <span class="co"># no mask</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">=</span> <span class="fu">image_mask</span>(<span class="st">"CLOUD_PROB"</span>, <span class="at">min =</span> <span class="dv">50</span>, <span class="at">max =</span> <span class="dv">100</span>)<span class="er">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">raster_cube</span>(collection, v, mask) <span class="co"># mask from CLOUD_PROB band</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- ## Proxy objects, lazy evaluation -->
<!-- Creating data cubes in the C++ library or the R package is a cheap operation and does not read any pixel values nor run any expensive operations. Instead, it returns a *proxy* object, knowing the shape of the data cube. This allows for *lazy evaluation* and some optimizations when operations on data cubes are chained (see [Data cube operations](operations.qmd) and [Execution and parallelization](execution.qmd)). -->
</section>
</section>
<section id="indexing-data-cubes" class="level2">
<h2 class="anchored" data-anchor-id="indexing-data-cubes">Indexing data cubes</h2>
<p>Data cubes can be accessed using the common <code>[]</code> operator. Indexes can be provided as integer array coordinates (zero-based), or using labels (band names and spatiotemporal coordinates respectively). For integer array indexes, pixel <span class="math inline">\((i_t, i_y, i_x) = (0, 0, 0)\)</span> is located in the top left corner at the starting time of the cube.</p>
<p>Dimensions can be derived automatically by the type of the indexing object and by the position, assuming the order band, time, y, x. Trailing dimensions that are not modified can be omitted.</p>
<p>The following examples show how data can be selected by integer array coordinates where the dimension is looked up by position.</p>
<div class="sourceCode" id="cb3" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># x is a data cube </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="co"># first band, top-left pixel at starting time</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>x[, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="co"># same pixel, all bands</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>x[, <span class="dv">1</span>] <span class="co"># all bands, full image at time = 1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>,,<span class="dv">200</span>,<span class="dv">200</span>] <span class="co"># first band, time series at pixel (200,200)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>] <span class="co"># data cube of the second band only</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>x[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="co"># data cube of the second and third band only</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>x[,<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>,,] <span class="co"># first ten image slices, all bands</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>x[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="co"># data cube of the second and third band only</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>x[,<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>,,] <span class="co"># first ten image slices, all bands</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>,<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>] <span class="co"># three bands, first image slice, spatial subset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the spatial dimensions, it is <strong>not</strong> possible to provide arbitrary (irregular) vectors. For example, <code>x[0, 1, c(0,2,4), c(1,2,3,9)]</code> will produce a warning and use the minimum and maximum values of the provided values to select the full range (equivalent to what you might expect from <code>x[0, 1, 0:4, 1:9]</code>).</p>
</div>
</div>
<p>The following examples show how labels and objects of different types can be used for a more user-friendly selection.</p>
<div class="sourceCode" id="cb4" data-code-line-numbers="false"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># x is a data cube </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>x[<span class="st">"B01"</span>] <span class="co">#  band with name "B01"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>x[<span class="fu">c</span>(<span class="st">"B01"</span>, <span class="st">"B08"</span>)] <span class="co">#  bands "B01" and "B08"</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>x[, <span class="fu">c</span>(<span class="st">"2001-01-01"</span>,<span class="st">"2001-01-31"</span>)] <span class="co"># all bands, image slices from 2001, Jan, only</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>x[<span class="fu">list</span>(<span class="at">left=</span><span class="dv">388941</span>, <span class="at">right=</span><span class="dv">766552</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">bottom=</span><span class="dv">4345299</span>, <span class="at">top=</span><span class="dv">4744931</span>)] <span class="co"># spatial window</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Additionally, spatial selection support points and bounding box types from the <a href="https://cran.r-project.org/package=sf"><code>sf</code> package</a><span class="citation" data-cites="sf">(<a href="#ref-sf" role="doc-biblioref">Pebesma 2018</a>)</span> using <code>sf::st_point()</code> and <code>sf::st_bbox()</code>.</p>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-appel2019" class="csl-entry" role="listitem">
Appel, Marius, and Edzer Pebesma. 2019. <span>“On-Demand Processing of Data Cubes from Satellite Image Collections with the Gdalcubes Library.”</span> <em>Data</em> 4 (3). <a href="https://doi.org/10.3390/data4030092">https://doi.org/10.3390/data4030092</a>.
</div>
<div id="ref-sf" class="csl-entry" role="listitem">
Pebesma, Edzer. 2018. <span>“<span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span>.”</span> <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
</div>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../source/concepts/collection_formats.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Image collection formats</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../source/concepts/operations.html" class="pagination-link">
        <span class="nav-page-text">Data cube operations</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb5" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu"># Data cubes</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>gdalcubes implements *regular dense raster data cubes*, making the following assumptions <span class="co">[</span><span class="ot">@appel2019</span><span class="co">]</span>:</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ss">1.  </span>Spatial dimensions refer to a single spatial reference system (SRS);</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ss">2.  </span>Cells of a data cube have a constant spatial size (with regard to the cube's SRS);</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="ss">3.  </span>The spatial reference is defined by a simple offset and the cell size per axis, i.e., the cube axes are aligned with the SRS axes;</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="ss">4.  </span>Cells of a data cube have a constant temporal duration, defined by an integer number and a date or time unit (years, months, days, hours, minutes, or seconds);</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="ss">5.  </span>The temporal reference is defined by a simple start date/time and the temporal duration of cells;</span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="ss">6.  </span>For every combination of dimensions, a cell has a single, scalar (real) attribute value.</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a>Data cubes are always four-dimensional (bands, time, y, x).</span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="al">![A single four-dimensional raster data cube.](cube.png)</span>{#fig-datacube}</span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="fu">## Spatiotemporal reference</span></span>
<span id="cb5-17"><a href="#cb5-17"></a> </span>
<span id="cb5-18"><a href="#cb5-18"></a>Before creating a cube, users must define its spatiotemporal geometry as a so called *data cube view*, without connecting it to specific datasets. The data cube view contains</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="ss">-   </span>the spatial reference system (SRS),</span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="ss">-   </span>the spatiotemporal extent (left, right, bottom, top, start date/time, end date/time), and</span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="ss">-   </span>the spatiotemporal size of pixels (spatial size, temporal duration).</span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a>The resolution of dimensions can be specified either by the number of pixels (nx, ny, nt), or by the size of pixels (dx, dy, dt). If the size of the extent in one dimension does not align with the corresponding pixel size, the extent will be enlarged accordingly. For example, assuming <span class="in">`left = 1`</span>, <span class="in">`right = 10`</span>, and <span class="in">`dx = 2`</span>, pixels would start at <span class="in">`x = [1,3,5,7,9]`</span> such that the last pixel would have size 1. In this case, the extent would be replaced by <span class="in">`left=0.5`</span>, <span class="in">`right=10.5`</span>, such that pixels start at <span class="in">`x = [0.5, 2.5, 4.5, 6.5, 8.5]`</span> and all pixels have size 2.</span>
<span id="cb5-25"><a href="#cb5-25"></a></span>
<span id="cb5-26"><a href="#cb5-26"></a>Please notice that the cube view does _not_ include any information on the band dimension, i.e., the cube view is independent of particular data products.</span>
<span id="cb5-27"><a href="#cb5-27"></a></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="fu">### Handling date/time</span></span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30"><a href="#cb5-30"></a>The temporal duration of pixels (dt) includes a temporal unit (or *granularity*). Following ISO 8601 durations, it is defined as a string starting with "P" (period), followed by an integer number and a unit (one of "Y", "M", "D", "TH", "TM", "TS"). In contrast to ISO 8601, gdalcubes does **not** allow to mix several units. For example, the duration <span class="in">`"P1M10DT2H"`</span> (one month, 10 days, and 2 hours) will produce an error.</span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a>If dt uses a larger datetime unit than t0 and t1, the temporal extent is enlarged. For instance, defining <span class="in">`t0 = "2019-03-05"`</span>, <span class="in">`t1 = "2019-06-05"`</span>, and monthly temporal resolution <span class="in">`dt = "P1M"`</span>, will lead to the extent <span class="in">`t0 = "2019-03"`</span> and <span class="in">`t1 = "2019-06"`</span>, such that the data cube covers the full March and June of 2019.</span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="fu">### Examples</span></span>
<span id="cb5-35"><a href="#cb5-35"></a></span>
<span id="cb5-36"><a href="#cb5-36"></a>The spatiotemporal reference of a cube can be set using the <span class="in">`cube_view()`</span> function, as in the examples below.</span>
<span id="cb5-37"><a href="#cb5-37"></a></span>
<span id="cb5-38"><a href="#cb5-38"></a><span class="in">```{.r  code-line-numbers="false"}</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:4326"</span>, </span>
<span id="cb5-40"><a href="#cb5-40"></a>              <span class="at">extent =</span> <span class="fu">list</span>(<span class="at">left =</span> <span class="dv">6</span>, <span class="at">right =</span> <span class="dv">7</span>, <span class="at">bottom =</span> <span class="dv">50</span>, <span class="at">top =</span> <span class="dv">51</span>, </span>
<span id="cb5-41"><a href="#cb5-41"></a>                            <span class="at">t0 =</span> <span class="st">"2022-01-01"</span>, <span class="at">t1 =</span> <span class="st">"2022-04-30"</span>),</span>
<span id="cb5-42"><a href="#cb5-42"></a>              <span class="at">dx =</span> <span class="fl">0.01</span>, <span class="at">dy =</span> <span class="fl">0.01</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>)</span>
<span id="cb5-43"><a href="#cb5-43"></a></span>
<span id="cb5-44"><a href="#cb5-44"></a>v1 <span class="ot">=</span> <span class="fu">cube_view</span>(v, <span class="at">dt =</span> <span class="st">"P1M"</span>) <span class="co"># modify existing data cube view object</span></span>
<span id="cb5-45"><a href="#cb5-45"></a></span>
<span id="cb5-46"><a href="#cb5-46"></a>w <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:3857"</span>, </span>
<span id="cb5-47"><a href="#cb5-47"></a>              <span class="at">extent =</span> collection, <span class="co"># use extent from an image collection</span></span>
<span id="cb5-48"><a href="#cb5-48"></a>              <span class="at">dx =</span> <span class="dv">100</span>, <span class="at">dy =</span>  <span class="dv">100</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>)</span>
<span id="cb5-49"><a href="#cb5-49"></a><span class="in">```</span></span>
<span id="cb5-50"><a href="#cb5-50"></a></span>
<span id="cb5-51"><a href="#cb5-51"></a></span>
<span id="cb5-52"><a href="#cb5-52"></a><span class="fu">## Creating data cubes from image collections {#datacube_creation}</span></span>
<span id="cb5-53"><a href="#cb5-53"></a></span>
<span id="cb5-54"><a href="#cb5-54"></a>Combining a *data cube view* with an *image collection* yields a regular raster data cube with band data from the image collection and geometry from the data cube view.</span>
<span id="cb5-55"><a href="#cb5-55"></a></span>
<span id="cb5-56"><a href="#cb5-56"></a>To read values of data cube <span class="co">[</span><span class="ot">chunk</span><span class="co">](execution.qmd#chunking)</span> from an image collection, the following algorithm is used <span class="co">[</span><span class="ot">@appel2019</span><span class="co">]</span>:</span>
<span id="cb5-57"><a href="#cb5-57"></a></span>
<span id="cb5-58"><a href="#cb5-58"></a><span class="ss">1.  </span>Allocate and initialize an in-memory chunk buffer for the resulting chunk data (a four-dimensional bands, t, y, x array);</span>
<span id="cb5-59"><a href="#cb5-59"></a></span>
<span id="cb5-60"><a href="#cb5-60"></a><span class="ss">2.  </span>Find all images of the collection that intersect with the spatiotemporal extent of the chunk;</span>
<span id="cb5-61"><a href="#cb5-61"></a></span>
<span id="cb5-62"><a href="#cb5-62"></a><span class="ss">3.  </span>For all images found:</span>
<span id="cb5-63"><a href="#cb5-63"></a></span>
<span id="cb5-64"><a href="#cb5-64"></a>    3.1. Crop, reproject, and resample according to the spatiotemporal extent of the chunk and the data cube view and store the result as an in-memory three-dimensional (bands, y, x) array; </span>
<span id="cb5-65"><a href="#cb5-65"></a></span>
<span id="cb5-66"><a href="#cb5-66"></a>    3.2. Copy the result to the chunk buffer at the correct temporal slice. If the chunk buffer already contains values at the target position, update a pixel-wise aggregator (e.g., mean, median, min., max.) to combine pixel values from multiple images which are written to the same cell in the data cube.</span>
<span id="cb5-67"><a href="#cb5-67"></a></span>
<span id="cb5-68"><a href="#cb5-68"></a><span class="ss">4.  </span>Finalize the pixel-wise aggregator if needed (e.g., divide pixel values by n for mean aggregation).</span>
<span id="cb5-69"><a href="#cb5-69"></a></span>
<span id="cb5-70"><a href="#cb5-70"></a></span>
<span id="cb5-71"><a href="#cb5-71"></a></span>
<span id="cb5-72"><a href="#cb5-72"></a></span>
<span id="cb5-73"><a href="#cb5-73"></a><span class="fu">### Aggregation and resampling</span></span>
<span id="cb5-74"><a href="#cb5-74"></a></span>
<span id="cb5-75"><a href="#cb5-75"></a>To build regular data cubes from image collections, individual images are reprojected, rescaled, cropped, and resampled with regard to the data cube view first. Afterwards, pixel values of several images that are located within the same data cube cell (i.e. from different days in the same month) are combined by an aggregation function. Methods for both, spatial *resampling* and temporal *aggregation* can be provided in the data cube view. gdalcubes supports all <span class="co">[</span><span class="ot">resampling methods implemented in GDAL</span><span class="co">](https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r)</span>. Supported aggregation methods include <span class="in">`"first"`</span>, <span class="in">`"min"`</span>, <span class="in">`"max"`</span>, <span class="in">`"median"`</span>, <span class="in">`"mean"`</span>, and <span class="in">`"last"`</span>.</span>
<span id="cb5-76"><a href="#cb5-76"></a></span>
<span id="cb5-77"><a href="#cb5-77"></a></span>
<span id="cb5-78"><a href="#cb5-78"></a><span class="fu">### Image masks</span></span>
<span id="cb5-79"><a href="#cb5-79"></a></span>
<span id="cb5-80"><a href="#cb5-80"></a>When data products include mask bands, pixel-wise quality flags, cloud probability layers, or similar, these can be used to filter pixels of images contributing the data cube cells. In gdalcubes, masks can be defined by band name and a set of mask values (or a value range). If a pixel's mask band value is within the set of values, this pixel is ignored. Masks can be inverted, such that only pixels for which the value of the mask band is within the provided set will be used. Additionally, a bitwise AND can be applied to extract specific bits of a bit mask only (e.g. for MODIS quality flag bands).</span>
<span id="cb5-81"><a href="#cb5-81"></a></span>
<span id="cb5-82"><a href="#cb5-82"></a>Notice that the masks are applied on images, not on cubes (during step 3.1 in the <span class="co">[</span><span class="ot">aforementioned algorithm</span><span class="co">](#datacube_creation)</span>). As such, masked values simply will not contribute to the pixel-wise aggregation.</span>
<span id="cb5-83"><a href="#cb5-83"></a></span>
<span id="cb5-84"><a href="#cb5-84"></a></span>
<span id="cb5-85"><a href="#cb5-85"></a></span>
<span id="cb5-86"><a href="#cb5-86"></a></span>
<span id="cb5-87"><a href="#cb5-87"></a><span class="fu">### Examples</span></span>
<span id="cb5-88"><a href="#cb5-88"></a></span>
<span id="cb5-89"><a href="#cb5-89"></a>The following example combines an image collection and a data cube view to create a data cube using <span class="in">`raster_cube()`</span>.</span>
<span id="cb5-90"><a href="#cb5-90"></a></span>
<span id="cb5-91"><a href="#cb5-91"></a><span class="in">```{.r  code-line-numbers="false"}</span></span>
<span id="cb5-92"><a href="#cb5-92"></a>collection <span class="ot">=</span> <span class="fu">image_collection</span>(<span class="st">"/path/to/collection.db"</span>)</span>
<span id="cb5-93"><a href="#cb5-93"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:3857"</span>, </span>
<span id="cb5-94"><a href="#cb5-94"></a>              <span class="at">extent =</span> collection, </span>
<span id="cb5-95"><a href="#cb5-95"></a>              <span class="at">dx =</span> <span class="dv">100</span>, <span class="at">dy =</span>  <span class="dv">100</span>, <span class="at">dt =</span> <span class="st">"P1D"</span>,</span>
<span id="cb5-96"><a href="#cb5-96"></a>              <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb5-97"><a href="#cb5-97"></a>              </span>
<span id="cb5-98"><a href="#cb5-98"></a><span class="fu">raster_cube</span>(collection, v) <span class="co"># no mask</span></span>
<span id="cb5-99"><a href="#cb5-99"></a></span>
<span id="cb5-100"><a href="#cb5-100"></a>mask <span class="ot">=</span> <span class="fu">image_mask</span>(<span class="st">"CLOUD_PROB"</span>, <span class="at">min =</span> <span class="dv">50</span>, <span class="at">max =</span> <span class="dv">100</span>)<span class="er">)</span></span>
<span id="cb5-101"><a href="#cb5-101"></a><span class="fu">raster_cube</span>(collection, v, mask) <span class="co"># mask from CLOUD_PROB band</span></span>
<span id="cb5-102"><a href="#cb5-102"></a><span class="in">```</span></span>
<span id="cb5-103"><a href="#cb5-103"></a></span>
<span id="cb5-104"><a href="#cb5-104"></a></span>
<span id="cb5-105"><a href="#cb5-105"></a><span class="co">&lt;!-- ## Proxy objects, lazy evaluation --&gt;</span></span>
<span id="cb5-106"><a href="#cb5-106"></a></span>
<span id="cb5-107"><a href="#cb5-107"></a><span class="co">&lt;!-- Creating data cubes in the C++ library or the R package is a cheap operation and does not read any pixel values nor run any expensive operations. Instead, it returns a *proxy* object, knowing the shape of the data cube. This allows for *lazy evaluation* and some optimizations when operations on data cubes are chained (see [Data cube operations](operations.qmd) and [Execution and parallelization](execution.qmd)). --&gt;</span></span>
<span id="cb5-108"><a href="#cb5-108"></a></span>
<span id="cb5-109"><a href="#cb5-109"></a></span>
<span id="cb5-110"><a href="#cb5-110"></a></span>
<span id="cb5-111"><a href="#cb5-111"></a></span>
<span id="cb5-112"><a href="#cb5-112"></a><span class="fu">## Indexing data cubes </span></span>
<span id="cb5-113"><a href="#cb5-113"></a></span>
<span id="cb5-114"><a href="#cb5-114"></a>Data cubes can be accessed using the common <span class="in">`[]`</span> operator. Indexes can be provided as integer array coordinates (zero-based), or using labels (band names and spatiotemporal coordinates respectively). For integer array indexes, pixel $(i_t, i_y, i_x) = (0, 0, 0)$ is located in the top left corner at the starting time of the cube.</span>
<span id="cb5-115"><a href="#cb5-115"></a></span>
<span id="cb5-116"><a href="#cb5-116"></a>Dimensions can be derived automatically by the type of the indexing object and by the position, assuming the order band, time, y, x. Trailing dimensions that are not modified can be omitted.</span>
<span id="cb5-117"><a href="#cb5-117"></a></span>
<span id="cb5-118"><a href="#cb5-118"></a>The following examples show how data can be selected by integer array coordinates where the dimension is looked up by position.</span>
<span id="cb5-119"><a href="#cb5-119"></a></span>
<span id="cb5-120"><a href="#cb5-120"></a><span class="in">```{.r code-line-numbers="false"}</span></span>
<span id="cb5-121"><a href="#cb5-121"></a><span class="co"># x is a data cube </span></span>
<span id="cb5-122"><a href="#cb5-122"></a>x[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="co"># first band, top-left pixel at starting time</span></span>
<span id="cb5-123"><a href="#cb5-123"></a>x[, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>] <span class="co"># same pixel, all bands</span></span>
<span id="cb5-124"><a href="#cb5-124"></a>x[, <span class="dv">1</span>] <span class="co"># all bands, full image at time = 1</span></span>
<span id="cb5-125"><a href="#cb5-125"></a>x[<span class="dv">0</span>,,<span class="dv">200</span>,<span class="dv">200</span>] <span class="co"># first band, time series at pixel (200,200)</span></span>
<span id="cb5-126"><a href="#cb5-126"></a>x[<span class="dv">1</span>] <span class="co"># data cube of the second band only</span></span>
<span id="cb5-127"><a href="#cb5-127"></a></span>
<span id="cb5-128"><a href="#cb5-128"></a>x[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="co"># data cube of the second and third band only</span></span>
<span id="cb5-129"><a href="#cb5-129"></a>x[,<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>,,] <span class="co"># first ten image slices, all bands</span></span>
<span id="cb5-130"><a href="#cb5-130"></a></span>
<span id="cb5-131"><a href="#cb5-131"></a>x[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="co"># data cube of the second and third band only</span></span>
<span id="cb5-132"><a href="#cb5-132"></a>x[,<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>,,] <span class="co"># first ten image slices, all bands</span></span>
<span id="cb5-133"><a href="#cb5-133"></a>x[<span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>,<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>] <span class="co"># three bands, first image slice, spatial subset</span></span>
<span id="cb5-134"><a href="#cb5-134"></a><span class="in">```</span></span>
<span id="cb5-135"><a href="#cb5-135"></a></span>
<span id="cb5-136"><a href="#cb5-136"></a></span>
<span id="cb5-137"><a href="#cb5-137"></a>:::{.callout-warning}</span>
<span id="cb5-138"><a href="#cb5-138"></a>For the spatial dimensions, it is **not** possible to provide arbitrary (irregular) vectors. For example, <span class="in">`x[0, 1, c(0,2,4), c(1,2,3,9)]`</span> will produce a warning and use the minimum and maximum values of the provided values to select the full range (equivalent to what you might expect from <span class="in">`x[0, 1, 0:4, 1:9]`</span>).</span>
<span id="cb5-139"><a href="#cb5-139"></a>:::</span>
<span id="cb5-140"><a href="#cb5-140"></a></span>
<span id="cb5-141"><a href="#cb5-141"></a></span>
<span id="cb5-142"><a href="#cb5-142"></a>The following examples show how labels and objects of different types can be used for a more user-friendly selection.</span>
<span id="cb5-143"><a href="#cb5-143"></a></span>
<span id="cb5-144"><a href="#cb5-144"></a><span class="in">```{.r code-line-numbers="false"}</span></span>
<span id="cb5-145"><a href="#cb5-145"></a><span class="co"># x is a data cube </span></span>
<span id="cb5-146"><a href="#cb5-146"></a>x[<span class="st">"B01"</span>] <span class="co">#  band with name "B01"</span></span>
<span id="cb5-147"><a href="#cb5-147"></a>x[<span class="fu">c</span>(<span class="st">"B01"</span>, <span class="st">"B08"</span>)] <span class="co">#  bands "B01" and "B08"</span></span>
<span id="cb5-148"><a href="#cb5-148"></a>x[, <span class="fu">c</span>(<span class="st">"2001-01-01"</span>,<span class="st">"2001-01-31"</span>)] <span class="co"># all bands, image slices from 2001, Jan, only</span></span>
<span id="cb5-149"><a href="#cb5-149"></a>x[<span class="fu">list</span>(<span class="at">left=</span><span class="dv">388941</span>, <span class="at">right=</span><span class="dv">766552</span>, </span>
<span id="cb5-150"><a href="#cb5-150"></a>       <span class="at">bottom=</span><span class="dv">4345299</span>, <span class="at">top=</span><span class="dv">4744931</span>)] <span class="co"># spatial window</span></span>
<span id="cb5-151"><a href="#cb5-151"></a><span class="in">```</span></span>
<span id="cb5-152"><a href="#cb5-152"></a></span>
<span id="cb5-153"><a href="#cb5-153"></a>Additionally, spatial selection support points and bounding box types from the <span class="co">[</span><span class="ot">`sf` package</span><span class="co">](https://cran.r-project.org/package=sf)[</span><span class="ot">@sf</span><span class="co">]</span> using <span class="in">`sf::st_point()`</span> and <span class="in">`sf::st_bbox()`</span>.</span>
<span id="cb5-154"><a href="#cb5-154"></a></span>
<span id="cb5-155"><a href="#cb5-155"></a></span>
<span id="cb5-156"><a href="#cb5-156"></a></span>
<span id="cb5-157"><a href="#cb5-157"></a></span>
<span id="cb5-158"><a href="#cb5-158"></a></span>
<span id="cb5-159"><a href="#cb5-159"></a></span>
<span id="cb5-160"><a href="#cb5-160"></a><span class="fu">### References</span></span>
<span id="cb5-161"><a href="#cb5-161"></a></span>
<span id="cb5-162"><a href="#cb5-162"></a>::: {#refs}</span>
<span id="cb5-163"><a href="#cb5-163"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2024 Marius Appel
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>