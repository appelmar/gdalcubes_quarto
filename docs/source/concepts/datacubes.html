<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.238">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>gdalcubes – datacubes</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>

  <script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../../site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="../../">
  <script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="../../site_libs/quarto-search/fuse.min.js"></script>
  <script src="../../site_libs/quarto-search/quarto-search.js"></script>
  <link href="../../favicon.png" rel="icon" type="image/png">
  <script src="../../site_libs/quarto-html/quarto.js"></script>
  <script src="../../site_libs/quarto-html/popper.min.js"></script>
  <script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../../site_libs/quarto-html/anchor.min.js"></script>
  <link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link class="quarto-color-scheme" id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <link class="quarto-color-scheme quarto-color-alternate" rel="prefetch" id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css">
  <script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link class="quarto-color-scheme" href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link class="quarto-color-scheme quarto-color-alternate" rel="prefetch" href="../../site_libs/bootstrap/bootstrap-dark.min.css">
  <script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 3,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="../../styles.css">
</head>
<body class="floating nav-fixed">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <img src="../../source/gdalcubes_logo_mini.png" alt="">
    <span class="navbar-title">gdalcubes</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/appelmar/gdalcubes_R"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">(Untitled)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Introduction</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/why.html" class="sidebar-item-text sidebar-link">Why gdalcubes?</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/overview.html" class="sidebar-item-text sidebar-link">Overview</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/installation.html" class="sidebar-item-text sidebar-link">Installation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/faq.html" class="sidebar-item-text sidebar-link">FAQ</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/license.html" class="sidebar-item-text sidebar-link">License</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/introduction/credits.html" class="sidebar-item-text sidebar-link">Credits</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Basic Concepts</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/image_collections.html" class="sidebar-item-text sidebar-link">Image collections</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/collection_formats.html" class="sidebar-item-text sidebar-link">Image Collection Formats</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/datacubes.html" class="sidebar-item-text sidebar-link active">Data Cubes</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/operations.html" class="sidebar-item-text sidebar-link">Data Cube Operations</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/streaming.html" class="sidebar-item-text sidebar-link">Streaming</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/concepts/distributed.html" class="sidebar-item-text sidebar-link">Distributed Data Cube Processing</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">R Tutorials</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/tutorials/vignettes/gc01_MODIS.html" class="sidebar-item-text sidebar-link">1. Creating data cubes from local MODIS imagery</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/tutorials/vignettes/gc02_AWS_Sentinel2.html" class="sidebar-item-text sidebar-link">2. Data cubes from Sentinel-2 data in the cloud</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/tutorials/vignettes/gc03_ML_training_data.html" class="sidebar-item-text sidebar-link">3. Extracting training data for machine learning models</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../source/tutorials/bfast/bfast.html" class="sidebar-item-text sidebar-link">Land cover change detection with gdalcubes and bfast</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
<ul>
<li><a href="#data-cubes" id="toc-data-cubes" class="nav-link active" data-scroll-target="#data-cubes">Data Cubes</a>
<ul class="collapse">
<li><a href="#data-cube-view" id="toc-data-cube-view" class="nav-link" data-scroll-target="#data-cube-view">Data Cube View</a>
<ul class="collapse">
<li><a href="#handling-datetime" id="toc-handling-datetime" class="nav-link" data-scroll-target="#handling-datetime">Handling Date/time</a></li>
</ul></li>
<li><a href="#data-cube-data-model" id="toc-data-cube-data-model" class="nav-link" data-scroll-target="#data-cube-data-model">Data Cube Data Model</a></li>
<li><a href="#creating-data-cubes-from-image-collections" id="toc-creating-data-cubes-from-image-collections" class="nav-link" data-scroll-target="#creating-data-cubes-from-image-collections">Creating Data Cubes from Image Collections</a>
<ul class="collapse">
<li><a href="#aggregation-and-resampling" id="toc-aggregation-and-resampling" class="nav-link" data-scroll-target="#aggregation-and-resampling">Aggregation and Resampling</a></li>
</ul></li>
<li><a href="#proxy-objects-lazy-evaluation" id="toc-proxy-objects-lazy-evaluation" class="nav-link" data-scroll-target="#proxy-objects-lazy-evaluation">Proxy Objects, Lazy Evaluation</a></li>
<li><a href="#image-masks" id="toc-image-masks" class="nav-link" data-scroll-target="#image-masks">Image Masks</a>
<ul class="collapse">
<li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<section id="data-cubes" class="level1">
<h1>Data Cubes</h1>
<p>gdalcubes implements <em>regular dense raster data cubes</em>, making the following assumptions <span class="citation" data-cites="appel2019">(<a href="#ref-appel2019" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>:</p>
<ol type="1">
<li>Spatial dimensions refer to a single spatial reference system (SRS);</li>
<li>Cells of a data cube have a constant spatial size (with regard to the cube’s SRS);</li>
<li>The spatial reference is defined by a simple offset and the cell size per axis, i.e., the cube axes are aligned with the SRS axes;</li>
<li>Cells of a data cube have a constant temporal duration, defined by an integer number and a date or time unit (years, months, days, hours, minutes, or seconds);</li>
<li>The temporal reference is defined by a simple start date/time and the temporal duration of cells;</li>
<li>For every combination of dimensions, a cell has a single, scalar (real) attribute value.</li>
</ol>
<p>Data cubes are always four-dimensional (bands, time, y, x).</p>
<section id="data-cube-view" class="level2">
<h2 class="anchored" data-anchor-id="data-cube-view">Data Cube View</h2>
<p>To create data cubes, users first define virtual data cubes as a <em>data cube view</em>, without connecting it to specific datasets. The data cube view contains information on the geometry of the cube, including</p>
<ul>
<li>the spatial reference system (SRS),</li>
<li>the spatiotemporal extent (left, right, bottom, top, start date/time, end date/time), and</li>
<li>the spatiotemporal size of pixels (spatial size, temporal duration).</li>
</ul>
<p>The resolution of dimensions can be specified either by the number of pixels (nx, ny, nt), or by the size of pixels (dx, dy, dt). If the size of the extent in one dimension does not align with the corresponding pixel size, the extent will be enlarged accordingly. For example, assuming <code>left = 1</code>, <code>right = 10</code>, and <code>dx = 2</code>, pixels would start at <code>x = [1,3,5,7,9]</code> such that the last pixel would have size 1. In this case, the extent would be replaced by <code>left=0.5</code>, <code>right=10.5</code>, such that pixels start at <code>x = [0.5, 2.5, 4.5, 6.5, 8.5]</code> and all pixels have size 2.</p>
<p>Please notice that the cube view does not include any information on the band dimension, i.e., the cube view is independent of particular data products.</p>
<section id="handling-datetime" class="level3">
<h3 class="anchored" data-anchor-id="handling-datetime">Handling Date/time</h3>
<p>The temporal duration of pixels (dt) includes a temporal unit (or <em>granularity</em>). Following ISO8601 durations, it is defined as a string starting with “P”, following by an integer number and a unit (one of “Y”, “M”, “D”, “TH”, “TM”, “TS”). In contrast to ISO8601, it is however <strong>not</strong> possible to mix several units, e.g.&nbsp;<code>"P1M10DT2H"</code> (one month, 10 days, and 2 hours).</p>
<p>If dt uses a larger unit than t0 and t1, the temporal extent is enlarged. For instance, defining <code>t0 = "2019-03-05"</code>, <code>t1 = "2019-06-05"</code>, and monthly temporal resolution <code>dt = "P1M"</code>, will lead to the extent <code>t0 = "2019-03"</code> and <code>t1 = "2019-06"</code>, such that the data cube covers the full March and June of 2019.</p>
</section>
</section>
<section id="data-cube-data-model" class="level2">
<h2 class="anchored" data-anchor-id="data-cube-data-model">Data Cube Data Model</h2>
<p>To manage large data cubes under limited main memory, a data cube is divided into smaller chunks, where the size of chunks (how many pixels in space and time) can be user-defined. A chunk contains values for all bands and stores values as a simple four-dimensional double array.</p>
<div id="fig-datacube" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="cube.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1: A single four-dimensional raster data cube.</figcaption><p></p>
</figure>
</div>
<p>.. TODO: add data cube class description (public methods)</p>
<p>.. TODO: parallelization?</p>
</section>
<section id="creating-data-cubes-from-image-collections" class="level2">
<h2 class="anchored" data-anchor-id="creating-data-cubes-from-image-collections">Creating Data Cubes from Image Collections</h2>
<p>Combining a <em>data cube view</em> with an <em>image collection</em> yields a regular raster data cube with band data from the image collection and geometry from the data cube view.</p>
<p>To read values of data cube chunk from an image collection, the following algorithm is used <span class="citation" data-cites="appel2019">(<a href="#ref-appel2019" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>:</p>
<ol type="1">
<li><p>Allocate and initialize an in-memory chunk buffer for the resulting chunk data (a four-dimensional bands, t, y, x array);</p></li>
<li><p>Find all images of the collection that intersect with the spatiotemporal extent of the chunk;</p></li>
<li><p>For all images found:</p>
<p>3.1. Crop, reproject, and resample according to the spatiotemporal extent of the chunk and the data cube view and store the result as an in-memory three-dimensional (bands, y, x) array;</p>
<p>3.2. Copy the result to the chunk buffer at the correct temporal slice. If the chunk buffer already contains values at the target position, update a pixel-wise aggregator (e.g., mean, median, min., max.) to combine pixel values from multiple images which are written to the same cell in the data cube.</p></li>
<li><p>Finalize the pixel-wise aggregator if needed (e.g., divide pixel values by n for mean aggregation).</p></li>
</ol>
<section id="aggregation-and-resampling" class="level3">
<h3 class="anchored" data-anchor-id="aggregation-and-resampling">Aggregation and Resampling</h3>
<p>To build regular data cubes from image collections, individual images are reprojected, rescaled, cropped, and resampled with regard to the data cube view first. Afterwards, pixel values of several images that are located within the same data cube cell (i.e.&nbsp;from different days in the same month) are combined by an aggregation function. Methods for both, spatial <em>resampling</em> and temporal <em>aggregation</em> can be provided in the data cube view. gdalcubes supports all <a href="https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r">resampling methods implemented in GDAL</a>. Supported aggregation methods include <code>"first"</code>, <code>"min"</code>, <code>"max"</code>, <code>"median"</code>, <code>"mean"</code>, and <code>"last"</code>.</p>
</section>
</section>
<section id="proxy-objects-lazy-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="proxy-objects-lazy-evaluation">Proxy Objects, Lazy Evaluation</h2>
<p>Creating data cubes in the C++ library or the R package is a cheap operation and does not read any pixel values nor run any expensive operations. Instead, it returns a <em>proxy</em> object, knowing the shape of the data cube. This allows for <em>lazy evaluation</em> and some optimizations when operations on data cubes are chained (see :doc:<code>operations</code>).</p>
</section>
<section id="image-masks" class="level2">
<h2 class="anchored" data-anchor-id="image-masks">Image Masks</h2>
<p>When data products include mask bands, these can be used to filter pixels of images contributing the data cube cells. Masks are applied on images, not on cubes (during step 3.1 in :ref:<code>above &lt;cube_creation_alg&gt;</code>). As such, masked values simply will not contribute to the pixel-wise aggregation.</p>
<p>In gdalcubes, masks can be defined by band name and a set of mask values (or a value range). If a pixel’s mask band value is within the set of values, this pixel is masked, otherwise not. Optionally, the masked can be inverted, and a bitwise AND can be applied to extract specific bits of a bit mask (e.g.&nbsp;for MODIS quality flag bands).</p>
<section id="references" class="level3">





<!-- -->

</section>
</section>
</section>
<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-appel2019" class="csl-entry" role="doc-biblioentry">
Appel, Marius, and Edzer Pebesma. 2019. <span>“On-Demand Processing of Data Cubes from Satellite Image Collections with the Gdalcubes Library.”</span> <em>Data</em> 4 (3). <a href="https://doi.org/10.3390/data4030092">https://doi.org/10.3390/data4030092</a>.
</div>
</div></section></div></main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
    } else {
      disableStylesheet(alternateStylesheets);
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb1" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu"># Data Cubes</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>gdalcubes implements *regular dense raster data cubes*, making the following assumptions <span class="co">[</span><span class="ot">@appel2019</span><span class="co">]</span>:</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ss">1.  </span>Spatial dimensions refer to a single spatial reference system (SRS);</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="ss">2.  </span>Cells of a data cube have a constant spatial size (with regard to the cube's SRS);</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="ss">3.  </span>The spatial reference is defined by a simple offset and the cell size per axis, i.e., the cube axes are aligned with the SRS axes;</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="ss">4.  </span>Cells of a data cube have a constant temporal duration, defined by an integer number and a date or time unit (years, months, days, hours, minutes, or seconds);</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="ss">5.  </span>The temporal reference is defined by a simple start date/time and the temporal duration of cells;</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="ss">6.  </span>For every combination of dimensions, a cell has a single, scalar (real) attribute value.</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>Data cubes are always four-dimensional (bands, time, y, x).</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="fu">## Data Cube View</span></span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a>To create data cubes, users first define virtual data cubes as a *data cube view*, without connecting it to specific datasets. The data cube view contains information on the geometry of the cube, including</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="ss">-   </span>the spatial reference system (SRS),</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="ss">-   </span>the spatiotemporal extent (left, right, bottom, top, start date/time, end date/time), and</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="ss">-   </span>the spatiotemporal size of pixels (spatial size, temporal duration).</span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a>The resolution of dimensions can be specified either by the number of pixels (nx, ny, nt), or by the size of pixels (dx, dy, dt). If the size of the extent in one dimension does not align with the corresponding pixel size, the extent will be enlarged accordingly. For example, assuming <span class="in">`left = 1`</span>, <span class="in">`right = 10`</span>, and <span class="in">`dx = 2`</span>, pixels would start at <span class="in">`x = [1,3,5,7,9]`</span> such that the last pixel would have size 1. In this case, the extent would be replaced by <span class="in">`left=0.5`</span>, <span class="in">`right=10.5`</span>, such that pixels start at <span class="in">`x = [0.5, 2.5, 4.5, 6.5, 8.5]`</span> and all pixels have size 2.</span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a>Please notice that the cube view does not include any information on the band dimension, i.e., the cube view is independent of particular data products.</span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="fu">### Handling Date/time</span></span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a>The temporal duration of pixels (dt) includes a temporal unit (or *granularity*). Following ISO8601 durations, it is defined as a string starting with "P", following by an integer number and a unit (one of "Y", "M", "D", "TH", "TM", "TS"). In contrast to ISO8601, it is however **not** possible to mix several units, e.g. <span class="in">`"P1M10DT2H"`</span> (one month, 10 days, and 2 hours).</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a>If dt uses a larger unit than t0 and t1, the temporal extent is enlarged. For instance, defining <span class="in">`t0 = "2019-03-05"`</span>, <span class="in">`t1 = "2019-06-05"`</span>, and monthly temporal resolution <span class="in">`dt = "P1M"`</span>, will lead to the extent <span class="in">`t0 = "2019-03"`</span> and <span class="in">`t1 = "2019-06"`</span>, such that the data cube covers the full March and June of 2019.</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="fu">## Data Cube Data Model</span></span>
<span id="cb1-33"><a href="#cb1-33"></a></span>
<span id="cb1-34"><a href="#cb1-34"></a>To manage large data cubes under limited main memory, a data cube is divided into smaller chunks, where the size of chunks (how many pixels in space and time) can be user-defined. A chunk contains values for all bands and stores values as a simple four-dimensional double array.</span>
<span id="cb1-35"><a href="#cb1-35"></a></span>
<span id="cb1-36"><a href="#cb1-36"></a></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="al">![A single four-dimensional raster data cube.](cube.png)</span>{#fig-datacube}</span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a></span>
<span id="cb1-40"><a href="#cb1-40"></a>.. TODO: add data cube class description (public methods)</span>
<span id="cb1-41"><a href="#cb1-41"></a></span>
<span id="cb1-42"><a href="#cb1-42"></a>.. TODO: parallelization?</span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="fu">## Creating Data Cubes from Image Collections</span></span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a>Combining a *data cube view* with an *image collection* yields a regular raster data cube with band data from the image collection and geometry from the data cube view.</span>
<span id="cb1-47"><a href="#cb1-47"></a></span>
<span id="cb1-48"><a href="#cb1-48"></a>To read values of data cube chunk from an image collection, the following algorithm is used <span class="co">[</span><span class="ot">@appel2019</span><span class="co">]</span>:</span>
<span id="cb1-49"><a href="#cb1-49"></a></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="ss">1.  </span>Allocate and initialize an in-memory chunk buffer for the resulting chunk data (a four-dimensional bands, t, y, x array);</span>
<span id="cb1-51"><a href="#cb1-51"></a></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="ss">2.  </span>Find all images of the collection that intersect with the spatiotemporal extent of the chunk;</span>
<span id="cb1-53"><a href="#cb1-53"></a></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="ss">3.  </span>For all images found:</span>
<span id="cb1-55"><a href="#cb1-55"></a></span>
<span id="cb1-56"><a href="#cb1-56"></a>    3.1. Crop, reproject, and resample according to the spatiotemporal extent of the chunk and the data cube view and store the result as an in-memory three-dimensional (bands, y, x) array;</span>
<span id="cb1-57"><a href="#cb1-57"></a></span>
<span id="cb1-58"><a href="#cb1-58"></a>    3.2. Copy the result to the chunk buffer at the correct temporal slice. If the chunk buffer already contains values at the target position, update a pixel-wise aggregator (e.g., mean, median, min., max.) to combine pixel values from multiple images which are written to the same cell in the data cube.</span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="ss">4.  </span>Finalize the pixel-wise aggregator if needed (e.g., divide pixel values by n for mean aggregation).</span>
<span id="cb1-61"><a href="#cb1-61"></a></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="fu">### Aggregation and Resampling</span></span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a>To build regular data cubes from image collections, individual images are reprojected, rescaled, cropped, and resampled with regard to the data cube view first. Afterwards, pixel values of several images that are located within the same data cube cell (i.e. from different days in the same month) are combined by an aggregation function. Methods for both, spatial *resampling* and temporal *aggregation* can be provided in the data cube view. gdalcubes supports all <span class="co">[</span><span class="ot">resampling methods implemented in GDAL</span><span class="co">](https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r)</span>. Supported aggregation methods include <span class="in">`"first"`</span>, <span class="in">`"min"`</span>, <span class="in">`"max"`</span>, <span class="in">`"median"`</span>, <span class="in">`"mean"`</span>, and <span class="in">`"last"`</span>.</span>
<span id="cb1-65"><a href="#cb1-65"></a></span>
<span id="cb1-66"><a href="#cb1-66"></a><span class="fu">## Proxy Objects, Lazy Evaluation</span></span>
<span id="cb1-67"><a href="#cb1-67"></a></span>
<span id="cb1-68"><a href="#cb1-68"></a>Creating data cubes in the C++ library or the R package is a cheap operation and does not read any pixel values nor run any expensive operations. Instead, it returns a *proxy* object, knowing the shape of the data cube. This allows for *lazy evaluation* and some optimizations when operations on data cubes are chained (see :doc:<span class="in">`operations`</span>).</span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="fu">## Image Masks</span></span>
<span id="cb1-71"><a href="#cb1-71"></a></span>
<span id="cb1-72"><a href="#cb1-72"></a>When data products include mask bands, these can be used to filter pixels of images contributing the data cube cells. Masks are applied on images, not on cubes (during step 3.1 in :ref:<span class="in">`above &lt;cube_creation_alg&gt;`</span>). As such, masked values simply will not contribute to the pixel-wise aggregation.</span>
<span id="cb1-73"><a href="#cb1-73"></a></span>
<span id="cb1-74"><a href="#cb1-74"></a>In gdalcubes, masks can be defined by band name and a set of mask values (or a value range). If a pixel's mask band value is within the set of values, this pixel is masked, otherwise not. Optionally, the masked can be inverted, and a bitwise AND can be applied to extract specific bits of a bit mask (e.g. for MODIS quality flag bands).</span>
<span id="cb1-75"><a href="#cb1-75"></a></span>
<span id="cb1-76"><a href="#cb1-76"></a><span class="fu">### References</span></span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a>::: {#refs}</span>
<span id="cb1-79"><a href="#cb1-79"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2022 Marius Appel
  </li>  
</ul>
      </div>
  </div>
</footer>


</body></html>