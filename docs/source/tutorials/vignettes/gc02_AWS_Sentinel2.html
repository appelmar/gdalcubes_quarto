<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Marius Appel">
<title>gdalcubes - 2. Data cubes from Sentinel-2 data in the cloud</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../favicon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../../../styles.css">
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../source/gdalcubes_logo_mini.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">gdalcubes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../source/getstarted.html" rel="" target="">
 <span class="menu-text">Get started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../source/introduction/why.html" rel="" target="">
 <span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../source/tutorials/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../source/reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">
<li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R/issues" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../source/introduction/faq.html" rel="" target=""><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">FAQ</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../../source/about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../source/tutorials/vignettes/gc02_AWS_Sentinel2.html">Cloud data access</a></li><li class="breadcrumb-item"><a href="../../../source/tutorials/vignettes/gc02_AWS_Sentinel2.html">1. Sentinel-2 data on AWS</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Get started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc01_MODIS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Quickstart: Creating data cubes from local MODIS imagery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/Landsat8_getting_started/Landsat8_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. In-depth: Analyzing Landsat image collections</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">User-defined functions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/bfast/bfast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Change detection with bfast</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Cloud data access</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc02_AWS_Sentinel2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. Sentinel-2 data on AWS</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Extraction from data cubes</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc03_ML_training_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Extract training data for ML models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/videos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Videos</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#finding-images-with-rstac" id="toc-finding-images-with-rstac" class="nav-link active" data-scroll-target="#finding-images-with-rstac">Finding images with <code>rstac</code></a></li>
  <li><a href="#converting-stac-items-to-image-collections" id="toc-converting-stac-items-to-image-collections" class="nav-link" data-scroll-target="#converting-stac-items-to-image-collections">Converting STAC items to image collections</a></li>
  <li><a href="#creating-and-processing-data-cubes" id="toc-creating-and-processing-data-cubes" class="nav-link" data-scroll-target="#creating-and-processing-data-cubes">Creating and processing data cubes</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">2. Data cubes from Sentinel-2 data in the cloud</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Marius Appel </p>
          </div>
  </div>
    
  
    
  </div>
  

</header><p>Many cloud computing providers contain large catalogs of satellite imagery as from the Sentinel-2 satellites. To avoid downloading hundreds of images (and gigabytes) from portals, one can directly run a machine on a cloud platform and run the analysis without any downloads before. Fortunately, this has recently been made much easier and more efficient due to the development and popularity of the <a href="https://www.cogeo.org">cloud-optimized GeoTIFF</a> image format and the <a href="https://stacspec.org">SpatioTemporal Asset Catalog (STAC)</a>.</p>
<p>This vignette will not explain any details the specifications but demonstrate how they can be used in combination with gdalcubes and the <a href="https://cran.r-project.org/package=rstac"><code>rstac</code></a> package. We will use the freely available <a href="https://registry.opendata.aws/sentinel-2-l2a-cogs">Sentinel-2 COG catalog</a> on Amazon Web Services (AWS) and the corresponding STAC-API endpoint at https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a.</p>
<p>Notice that this vignette in principle runs anywhere but computations take much longer when not working on an AWS machine in the region of the data catalog (in this case us-west-2).</p>
<section id="finding-images-with-rstac" class="level1"><h1>Finding images with <code>rstac</code>
</h1>
<p>As an example, we are interested in cloud-free images of New York City in June, 2021. We can use the NYC administrative polygons that are shipped as example data with the package and use the (<code>sf</code>)[https://cran.r-project.org/package=sf] package for reading and calculating the bounding box.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="do">## Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>nyc_shape <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">system.file</span>(<span class="st">"nycd.gpkg"</span>,<span class="at">package =</span> <span class="st">"gdalcubes"</span>))</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(nyc_shape) </span>
<span id="cb1-6"><a href="#cb1-6"></a>bbox</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="do">##      xmin      ymin      xmax      ymax </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="do">##  563069.9 4483098.0  609761.1 4529895.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To ask the STACK endpoints for available images intersecting with our area of interest, we need to provide the bounding box in WGS84 (latitude / longitude) coordinates, which we can calculate with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>nyc_shape <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">st_bbox</span>() <span class="ot">-&gt;</span> bbox_wgs84</span>
<span id="cb2-4"><a href="#cb2-4"></a>bbox_wgs84</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="do">##      xmin      ymin      xmax      ymax </span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="do">## -74.25559  40.49614 -73.70002  40.91500</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we load the <code>rstac</code> package, specify the STAC-API endpoint URL and query all available images for our area and time of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(rstac)</span>
<span id="cb3-2"><a href="#cb3-2"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>  items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb3-5"><a href="#cb3-5"></a>                <span class="at">bbox =</span> <span class="fu">c</span>(bbox_wgs84[<span class="st">"xmin"</span>],bbox_wgs84[<span class="st">"ymin"</span>],</span>
<span id="cb3-6"><a href="#cb3-6"></a>                         bbox_wgs84[<span class="st">"xmax"</span>],bbox_wgs84[<span class="st">"ymax"</span>]), </span>
<span id="cb3-7"><a href="#cb3-7"></a>                <span class="at">datetime =</span> <span class="st">"2021-06-01/2021-06-30"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="fu">length</span>(items<span class="sc">$</span>features)</span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="do">## [1] 48</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As a result, we get a list with metadata and URLs pointing to 48 images. This list is an index-like object pointing to original images on a AWS S3 bucket and hence somewhat similar to gdalcubes image collections.</p>
</section><section id="converting-stac-items-to-image-collections" class="level1"><h1>Converting STAC items to image collections</h1>
<p>We can convert the STAC response to a gdalcubes image collections using <code>stac_image_collection()</code>. This function expects a STAC feature list as input and optionally can apply some filters on metadata and bands. Notice that this operation is much faster than the creation of image collections from local files, because all metadata are already available and no image file must be opened. Below, we create a collection for images with less than 10% cloud cover.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb4-2"><a href="#cb4-2"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features,  <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span>
<span id="cb4-3"><a href="#cb4-3"></a>s2_collection</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="do">## Image collection object, referencing 16 images with 21 bands</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="do">## Images:</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="do">##                       name      left      top   bottom     right</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="do">## 1 S2B_18TWK_20210629_0_L2A -75.00023 40.65085 39.65842 -73.78649</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="do">## 2 S2B_18TXK_20210629_0_L2A -73.81752 40.64478 40.55838 -73.78649</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="do">## 3 S2B_18TWL_20210629_0_L2A -75.00023 41.55184 40.55671 -73.68381</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="do">## 4 S2B_18TXL_20210629_0_L2A -73.81884 41.54559 40.55671 -73.45793</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="do">## 5 S2A_18TWK_20210624_0_L2A -75.00023 40.65085 39.65836 -73.77774</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="do">## 6 S2A_18TXK_20210624_0_L2A -73.81796 40.64478 40.53306 -73.77774</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="do">##              datetime        srs</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="do">## 1 2021-06-29T16:02:02 EPSG:32618</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="do">## 2 2021-06-29T16:01:52 EPSG:32618</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="do">## 3 2021-06-29T16:01:48 EPSG:32618</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="do">## 4 2021-06-29T16:01:42 EPSG:32618</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="do">## 5 2021-06-24T16:02:02 EPSG:32618</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="do">## 6 2021-06-24T16:01:52 EPSG:32618</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="do">## [ omitted 10 images ] </span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="do">## </span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="do">## Bands:</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="do">##            name offset scale unit nodata image_count</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="do">## 1           AOT      0     1                      16</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="do">## 2           B01      0     1                      16</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="do">## 3           B02      0     1                      16</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="do">## 4           B03      0     1                      16</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="do">## 5           B04      0     1                      16</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="do">## 6           B05      0     1                      16</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="do">## 7           B06      0     1                      16</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="do">## 8           B07      0     1                      16</span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="do">## 9           B08      0     1                      16</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="do">## 10          B09      0     1                      16</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="do">## 11          B11      0     1                      16</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="do">## 12          B12      0     1                      16</span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="do">## 13          B8A      0     1                      16</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="do">## 14          SCL      0     1                      16</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="do">## 15          WVP      0     1                      16</span></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="do">## 16 overview:B02      0     1                      16</span></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="do">## 17 overview:B03      0     1                      16</span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="do">## 18 overview:B04      0     1                      16</span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="do">## 19   visual:B02      0     1                      16</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="do">## 20   visual:B03      0     1                      16</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="do">## 21   visual:B04      0     1                      16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The collection contains 16 images and all spectral bands plus some RGB preview images. However, the <a href="https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm">scene classification layer (SCL)</a> containing pixel-wise information whether a pixel shows a cloud, cloud-shadow, water, or something else, is missing. Although the SCL images are available in the returned STAC list, the response does not include all of the metadata to let gdalcubes recognize it as an image. However, it is possible to explicitly list the names of all bands to be included in the collection by adding the <code>asset_names</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>assets <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B01"</span>,<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>,<span class="st">"B05"</span>,<span class="st">"B06"</span>, <span class="st">"B07"</span>,<span class="st">"B08"</span>,<span class="st">"B8A"</span>,<span class="st">"B09"</span>,<span class="st">"B11"</span>,<span class="st">"SCL"</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">asset_names =</span> assets, <span class="at">property_filter =</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>                                      <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span>
<span id="cb5-4"><a href="#cb5-4"></a>s2_collection</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="do">## Image collection object, referencing 16 images with 12 bands</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="do">## Images:</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="do">##                       name      left      top   bottom     right</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="do">## 1 S2B_18TWK_20210629_0_L2A -75.00023 40.65085 39.65842 -73.78649</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="do">## 2 S2B_18TXK_20210629_0_L2A -73.81752 40.64478 40.55838 -73.78649</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="do">## 3 S2B_18TWL_20210629_0_L2A -75.00023 41.55184 40.55671 -73.68381</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="do">## 4 S2B_18TXL_20210629_0_L2A -73.81884 41.54559 40.55671 -73.45793</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="do">## 5 S2A_18TWK_20210624_0_L2A -75.00023 40.65085 39.65836 -73.77774</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="do">## 6 S2A_18TXK_20210624_0_L2A -73.81796 40.64478 40.53306 -73.77774</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="do">##              datetime        srs</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="do">## 1 2021-06-29T16:02:02 EPSG:32618</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="do">## 2 2021-06-29T16:01:52 EPSG:32618</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="do">## 3 2021-06-29T16:01:48 EPSG:32618</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="do">## 4 2021-06-29T16:01:42 EPSG:32618</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="do">## 5 2021-06-24T16:02:02 EPSG:32618</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="do">## 6 2021-06-24T16:01:52 EPSG:32618</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="do">## [ omitted 10 images ] </span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="do">## </span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="do">## Bands:</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="do">##    name offset scale unit nodata image_count</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="do">## 1   B01      0     1                      16</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="do">## 2   B02      0     1                      16</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="do">## 3   B03      0     1                      16</span></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="do">## 4   B04      0     1                      16</span></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="do">## 5   B05      0     1                      16</span></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="do">## 6   B06      0     1                      16</span></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="do">## 7   B07      0     1                      16</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="do">## 8   B08      0     1                      16</span></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="do">## 9   B09      0     1                      16</span></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="do">## 10  B11      0     1                      16</span></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="do">## 11  B8A      0     1                      16</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="do">## 12  SCL      0     1                      16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="creating-and-processing-data-cubes" class="level1"><h1>Creating and processing data cubes</h1>
<p>Having an image collection object, we can now use gdalcubes in the same way as we do with local files. Particularly, we define a data cube view and maybe some additional data cube operations. In the following example, we create a coarse resolution (100m) simple median-composite RGB image from a daily data cube.</p>
<div class="cell" data-layout-align="center" data-fig.dim="[4.5,4.5]">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">8</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs=</span><span class="st">"EPSG:32618"</span>, <span class="at">dx=</span><span class="dv">100</span>, <span class="at">dy=</span><span class="dv">100</span>, <span class="at">dt=</span><span class="st">"P1D"</span>, </span>
<span id="cb6-3"><a href="#cb6-3"></a>                           <span class="at">aggregation=</span><span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"average"</span>,</span>
<span id="cb6-4"><a href="#cb6-4"></a>                           <span class="at">extent=</span><span class="fu">list</span>(<span class="at">t0 =</span> <span class="st">"2021-06-01"</span>, <span class="at">t1 =</span> <span class="st">"2021-06-30"</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>                                       <span class="at">left=</span>bbox[<span class="st">"xmin"</span>], <span class="at">right=</span>bbox[<span class="st">"xmax"</span>],</span>
<span id="cb6-6"><a href="#cb6-6"></a>                                       <span class="at">top=</span>bbox[<span class="st">"ymax"</span>], <span class="at">bottom=</span>bbox[<span class="st">"ymin"</span>]))</span>
<span id="cb6-7"><a href="#cb6-7"></a>v</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="do">## A data cube view object</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="do">## </span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="do">## Dimensions:</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="do">##                low             high count pixel_size</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="do">## t       2021-06-01       2021-06-30    30        P1D</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="do">## y 4483096.51932691 4529896.51932691   468        100</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="do">## x 563065.499607774 609765.499607774   467        100</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="do">## </span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="do">## SRS: "EPSG:32618"</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="do">## Temporal aggregation method: "median"</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="do">## Spatial resampling method: "average"</span></span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="fu">reduce_time</span>(<span class="fu">c</span>(<span class="st">"median(B02)"</span>, <span class="st">"median(B03)"</span>, <span class="st">"median(B04)"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="fu">plot</span>(<span class="at">rgb =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2500</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc02_AWS_Sentinel2_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Of course, we can “zoom in” to Lower Manhattan simply by changing the <em>data cube view</em>.</p>
<div class="cell" data-layout-align="center" data-fig.dim="[4.5,4.5]">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs=</span><span class="st">"EPSG:32618"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">dt=</span><span class="st">"P1D"</span>, </span>
<span id="cb7-2"><a href="#cb7-2"></a>                           <span class="at">aggregation=</span><span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"average"</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>                           <span class="at">extent=</span><span class="fu">list</span>(<span class="at">t0 =</span> <span class="st">"2021-06-01"</span>, <span class="at">t1 =</span> <span class="st">"2021-06-30"</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>                                       <span class="at">left=</span><span class="dv">582182</span>, <span class="at">right=</span><span class="dv">587019</span>,</span>
<span id="cb7-5"><a href="#cb7-5"></a>                                       <span class="at">top=</span><span class="dv">4508997</span>, <span class="at">bottom=</span><span class="dv">4505883</span>))</span>
<span id="cb7-6"><a href="#cb7-6"></a>v</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="do">## A data cube view object</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="do">## </span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="do">## Dimensions:</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="do">##          low       high count pixel_size</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="do">## t 2021-06-01 2021-06-30    30        P1D</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="do">## y    4505880    4509000   312         10</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="do">## x   582180.5   587020.5   484         10</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="do">## </span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="do">## SRS: "EPSG:32618"</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="do">## Temporal aggregation method: "median"</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="do">## Spatial resampling method: "average"</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="fu">reduce_time</span>(<span class="fu">c</span>(<span class="st">"median(B02)"</span>, <span class="st">"median(B03)"</span>, <span class="st">"median(B04)"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="fu">plot</span>(<span class="at">rgb =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2500</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc02_AWS_Sentinel2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>For more complex examples, you can find a <a href="https://youtu.be/Xlg__2PeTXM?t=3693">tutorial on YouTube</a> and corresponding materials on <a href="https://github.com/appelmar/ogh2021">GitHub</a> how to use gdalcubes in the cloud, presented at the virtual OpenGeoHub Summer School 2021.</p>
</section><section id="summary" class="level1"><h1>Summary</h1>
<p>Thanks to STAC, cloud-optimized GeoTIFFs, and GDAL being capable of reading imagery from cloud storage directly, moving to cloud-based analysis workflows without downloading any imagery from portals become a lot easier and more efficient. Whether or not this is the right approach depends a lot on particular applications. In some cases (e.g.&nbsp;when having access to institutional HPC resources while applying very complex models on small areas of interest), it might still be appropriate to download the data once. The <code>gdalcubes</code> package still can help as an interface to downloading analysis-ready data cubes instead of image files from portals.</p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb8" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">---</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="an">title:</span><span class="co"> "2. Data cubes from Sentinel-2 data in the cloud"</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="an">author:</span><span class="co"> "Marius Appel"</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">  rmarkdown::html_vignette</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="an">vignette:</span><span class="co"> &gt;</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">  %\VignetteIndexEntry{2. Data cubes from Sentinel-2 data in the cloud}</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">  %\VignetteEngine{knitr::rmarkdown}</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">  %\VignetteEncoding{UTF-8}</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">---</span></span>
<span id="cb8-11"><a href="#cb8-11"></a></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>ev <span class="ot">=</span> <span class="fu">unname</span>(<span class="fu">Sys.info</span>()[<span class="st">"user"</span>]) <span class="sc">==</span> <span class="st">"marius"</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="at">eval =</span> ev</span>
<span id="cb8-17"><a href="#cb8-17"></a>)</span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="in">```</span></span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a></span>
<span id="cb8-21"><a href="#cb8-21"></a>Many cloud computing providers contain large catalogs of satellite imagery as from the Sentinel-2 satellites. To avoid downloading hundreds of images (and gigabytes) from portals, one can directly run a machine on a cloud platform and run the analysis without any downloads before. Fortunately, this has recently been made much easier and more efficient due to the development and popularity of the <span class="co">[</span><span class="ot">cloud-optimized GeoTIFF</span><span class="co">](https://www.cogeo.org)</span> image format and the <span class="co">[</span><span class="ot">SpatioTemporal Asset Catalog (STAC)</span><span class="co">](https://stacspec.org)</span>.</span>
<span id="cb8-22"><a href="#cb8-22"></a></span>
<span id="cb8-23"><a href="#cb8-23"></a>This vignette will not explain any details the specifications but demonstrate how they can be used in combination with gdalcubes and the <span class="co">[</span><span class="ot">`rstac`</span><span class="co">](https://cran.r-project.org/package=rstac)</span> package. We will use the freely available <span class="co">[</span><span class="ot">Sentinel-2 COG catalog</span><span class="co">](https://registry.opendata.aws/sentinel-2-l2a-cogs)</span> on Amazon Web Services (AWS) and the corresponding STAC-API endpoint at https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a.</span>
<span id="cb8-24"><a href="#cb8-24"></a></span>
<span id="cb8-25"><a href="#cb8-25"></a>Notice that this vignette in principle runs anywhere but computations take much longer when not working on an AWS machine in the region of the data catalog (in this case us-west-2).</span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-27"><a href="#cb8-27"></a></span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="fu"># Finding images with `rstac`</span></span>
<span id="cb8-30"><a href="#cb8-30"></a></span>
<span id="cb8-31"><a href="#cb8-31"></a>As an example, we are interested in cloud-free images of New York City in June, 2021. We can use the </span>
<span id="cb8-32"><a href="#cb8-32"></a>NYC administrative polygons that are shipped as example data with the package and use the (<span class="in">`sf`</span>)<span class="co">[</span><span class="ot">https://cran.r-project.org/package=sf</span><span class="co">]</span> package for reading and calculating the bounding box.</span>
<span id="cb8-33"><a href="#cb8-33"></a></span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="in">```{r}</span></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="fu">library</span>(sf)</span>
<span id="cb8-38"><a href="#cb8-38"></a>nyc_shape <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">system.file</span>(<span class="st">"nycd.gpkg"</span>,<span class="at">package =</span> <span class="st">"gdalcubes"</span>))</span>
<span id="cb8-39"><a href="#cb8-39"></a></span>
<span id="cb8-40"><a href="#cb8-40"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(nyc_shape) </span>
<span id="cb8-41"><a href="#cb8-41"></a>bbox</span>
<span id="cb8-42"><a href="#cb8-42"></a><span class="in">```</span></span>
<span id="cb8-43"><a href="#cb8-43"></a></span>
<span id="cb8-44"><a href="#cb8-44"></a>To ask the STACK endpoints for available images intersecting with our area of interest, we need to provide the bounding box in WGS84 (latitude / longitude) coordinates, which we can calculate with: </span>
<span id="cb8-45"><a href="#cb8-45"></a></span>
<span id="cb8-46"><a href="#cb8-46"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a><span class="in">```{r}</span></span>
<span id="cb8-50"><a href="#cb8-50"></a>nyc_shape <span class="sc">|&gt;</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-52"><a href="#cb8-52"></a>  <span class="fu">st_bbox</span>() <span class="ot">-&gt;</span> bbox_wgs84</span>
<span id="cb8-53"><a href="#cb8-53"></a>bbox_wgs84</span>
<span id="cb8-54"><a href="#cb8-54"></a><span class="in">```</span></span>
<span id="cb8-55"><a href="#cb8-55"></a></span>
<span id="cb8-56"><a href="#cb8-56"></a>Next, we load the <span class="in">`rstac`</span> package, specify the STAC-API endpoint URL and query all available images for our area and time of interest.</span>
<span id="cb8-57"><a href="#cb8-57"></a></span>
<span id="cb8-60"><a href="#cb8-60"></a><span class="in">```{r}</span></span>
<span id="cb8-61"><a href="#cb8-61"></a><span class="fu">library</span>(rstac)</span>
<span id="cb8-62"><a href="#cb8-62"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb8-63"><a href="#cb8-63"></a>  items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb8-64"><a href="#cb8-64"></a>    <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb8-65"><a href="#cb8-65"></a>                <span class="at">bbox =</span> <span class="fu">c</span>(bbox_wgs84[<span class="st">"xmin"</span>],bbox_wgs84[<span class="st">"ymin"</span>],</span>
<span id="cb8-66"><a href="#cb8-66"></a>                         bbox_wgs84[<span class="st">"xmax"</span>],bbox_wgs84[<span class="st">"ymax"</span>]), </span>
<span id="cb8-67"><a href="#cb8-67"></a>                <span class="at">datetime =</span> <span class="st">"2021-06-01/2021-06-30"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-68"><a href="#cb8-68"></a>    <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-69"><a href="#cb8-69"></a>  <span class="fu">length</span>(items<span class="sc">$</span>features)</span>
<span id="cb8-70"><a href="#cb8-70"></a><span class="in">```</span></span>
<span id="cb8-71"><a href="#cb8-71"></a>As a result, we get a list with metadata and URLs pointing to 48 images. This list is an index-like object pointing to original images on a AWS S3 bucket and hence somewhat similar to gdalcubes image collections.</span>
<span id="cb8-72"><a href="#cb8-72"></a></span>
<span id="cb8-73"><a href="#cb8-73"></a></span>
<span id="cb8-74"><a href="#cb8-74"></a><span class="fu"># Converting STAC items to image collections</span></span>
<span id="cb8-75"><a href="#cb8-75"></a></span>
<span id="cb8-76"><a href="#cb8-76"></a></span>
<span id="cb8-77"><a href="#cb8-77"></a>We can convert the STAC response to a gdalcubes image collections using <span class="in">`stac_image_collection()`</span>. </span>
<span id="cb8-78"><a href="#cb8-78"></a>This function expects a STAC feature list as input and optionally can apply some filters on metadata and bands. Notice that this operation is much faster than the creation of image collections from local files, because all metadata are already available and no image file must be opened. Below, we create a collection for images with less than 10% cloud cover. </span>
<span id="cb8-79"><a href="#cb8-79"></a></span>
<span id="cb8-82"><a href="#cb8-82"></a><span class="in">```{r}</span></span>
<span id="cb8-83"><a href="#cb8-83"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb8-84"><a href="#cb8-84"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features,  <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span>
<span id="cb8-85"><a href="#cb8-85"></a>s2_collection</span>
<span id="cb8-86"><a href="#cb8-86"></a><span class="in">```</span></span>
<span id="cb8-87"><a href="#cb8-87"></a></span>
<span id="cb8-88"><a href="#cb8-88"></a>The collection contains 16 images and all spectral bands plus some RGB preview images. However, the <span class="co">[</span><span class="ot">scene classification layer (SCL)</span><span class="co">](https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm)</span> containing pixel-wise information whether a pixel shows a cloud, cloud-shadow, water, or something else, is missing. Although the SCL images are available in the returned STAC list, the response does not include all of the metadata to let gdalcubes recognize it as an image. However, it is possible to explicitly list the names of all bands to be included in the collection by adding the <span class="in">`asset_names`</span> argument:</span>
<span id="cb8-89"><a href="#cb8-89"></a></span>
<span id="cb8-90"><a href="#cb8-90"></a><span class="in">```{r, warning=FALSE}</span></span>
<span id="cb8-91"><a href="#cb8-91"></a>assets <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B01"</span>,<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>,<span class="st">"B05"</span>,<span class="st">"B06"</span>, <span class="st">"B07"</span>,<span class="st">"B08"</span>,<span class="st">"B8A"</span>,<span class="st">"B09"</span>,<span class="st">"B11"</span>,<span class="st">"SCL"</span>)</span>
<span id="cb8-92"><a href="#cb8-92"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">asset_names =</span> assets, <span class="at">property_filter =</span></span>
<span id="cb8-93"><a href="#cb8-93"></a>                                      <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span>
<span id="cb8-94"><a href="#cb8-94"></a>s2_collection</span>
<span id="cb8-95"><a href="#cb8-95"></a><span class="in">```</span></span>
<span id="cb8-96"><a href="#cb8-96"></a></span>
<span id="cb8-97"><a href="#cb8-97"></a></span>
<span id="cb8-98"><a href="#cb8-98"></a></span>
<span id="cb8-99"><a href="#cb8-99"></a><span class="fu"># Creating and processing data cubes</span></span>
<span id="cb8-100"><a href="#cb8-100"></a></span>
<span id="cb8-101"><a href="#cb8-101"></a>Having an image collection object, we can now use gdalcubes in the same way as we do with local files. Particularly, we define a data cube view and maybe some additional data cube operations. In the following example, we create a coarse resolution (100m) simple median-composite RGB image from a daily data cube.</span>
<span id="cb8-102"><a href="#cb8-102"></a></span>
<span id="cb8-103"><a href="#cb8-103"></a><span class="in">```{r, fig.align="center", fig.dim=c(4.5,4.5)}</span></span>
<span id="cb8-104"><a href="#cb8-104"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">8</span>)</span>
<span id="cb8-105"><a href="#cb8-105"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs=</span><span class="st">"EPSG:32618"</span>, <span class="at">dx=</span><span class="dv">100</span>, <span class="at">dy=</span><span class="dv">100</span>, <span class="at">dt=</span><span class="st">"P1D"</span>, </span>
<span id="cb8-106"><a href="#cb8-106"></a>                           <span class="at">aggregation=</span><span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"average"</span>,</span>
<span id="cb8-107"><a href="#cb8-107"></a>                           <span class="at">extent=</span><span class="fu">list</span>(<span class="at">t0 =</span> <span class="st">"2021-06-01"</span>, <span class="at">t1 =</span> <span class="st">"2021-06-30"</span>,</span>
<span id="cb8-108"><a href="#cb8-108"></a>                                       <span class="at">left=</span>bbox[<span class="st">"xmin"</span>], <span class="at">right=</span>bbox[<span class="st">"xmax"</span>],</span>
<span id="cb8-109"><a href="#cb8-109"></a>                                       <span class="at">top=</span>bbox[<span class="st">"ymax"</span>], <span class="at">bottom=</span>bbox[<span class="st">"ymin"</span>]))</span>
<span id="cb8-110"><a href="#cb8-110"></a>v</span>
<span id="cb8-111"><a href="#cb8-111"></a></span>
<span id="cb8-112"><a href="#cb8-112"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span></span>
<span id="cb8-113"><a href="#cb8-113"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-114"><a href="#cb8-114"></a>  <span class="fu">reduce_time</span>(<span class="fu">c</span>(<span class="st">"median(B02)"</span>, <span class="st">"median(B03)"</span>, <span class="st">"median(B04)"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-115"><a href="#cb8-115"></a>  <span class="fu">plot</span>(<span class="at">rgb =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2500</span>))</span>
<span id="cb8-116"><a href="#cb8-116"></a><span class="in">```</span></span>
<span id="cb8-117"><a href="#cb8-117"></a>Of course, we can "zoom in" to Lower Manhattan simply by changing the _data cube view_.</span>
<span id="cb8-118"><a href="#cb8-118"></a></span>
<span id="cb8-119"><a href="#cb8-119"></a><span class="in">```{r, fig.align="center", fig.dim=c(4.5,4.5)}</span></span>
<span id="cb8-120"><a href="#cb8-120"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs=</span><span class="st">"EPSG:32618"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">dt=</span><span class="st">"P1D"</span>, </span>
<span id="cb8-121"><a href="#cb8-121"></a>                           <span class="at">aggregation=</span><span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"average"</span>,</span>
<span id="cb8-122"><a href="#cb8-122"></a>                           <span class="at">extent=</span><span class="fu">list</span>(<span class="at">t0 =</span> <span class="st">"2021-06-01"</span>, <span class="at">t1 =</span> <span class="st">"2021-06-30"</span>,</span>
<span id="cb8-123"><a href="#cb8-123"></a>                                       <span class="at">left=</span><span class="dv">582182</span>, <span class="at">right=</span><span class="dv">587019</span>,</span>
<span id="cb8-124"><a href="#cb8-124"></a>                                       <span class="at">top=</span><span class="dv">4508997</span>, <span class="at">bottom=</span><span class="dv">4505883</span>))</span>
<span id="cb8-125"><a href="#cb8-125"></a>v</span>
<span id="cb8-126"><a href="#cb8-126"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span></span>
<span id="cb8-127"><a href="#cb8-127"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-128"><a href="#cb8-128"></a>  <span class="fu">reduce_time</span>(<span class="fu">c</span>(<span class="st">"median(B02)"</span>, <span class="st">"median(B03)"</span>, <span class="st">"median(B04)"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-129"><a href="#cb8-129"></a>  <span class="fu">plot</span>(<span class="at">rgb =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2500</span>))</span>
<span id="cb8-130"><a href="#cb8-130"></a><span class="in">```</span></span>
<span id="cb8-131"><a href="#cb8-131"></a></span>
<span id="cb8-132"><a href="#cb8-132"></a>For more complex examples, you can find a <span class="co">[</span><span class="ot">tutorial on YouTube</span><span class="co">](https://youtu.be/Xlg__2PeTXM?t=3693)</span> and corresponding materials on <span class="co">[</span><span class="ot">GitHub</span><span class="co">](https://github.com/appelmar/ogh2021)</span> how to use gdalcubes in the cloud, presented at the virtual OpenGeoHub Summer School 2021.</span>
<span id="cb8-133"><a href="#cb8-133"></a></span>
<span id="cb8-134"><a href="#cb8-134"></a><span class="fu"># Summary</span></span>
<span id="cb8-135"><a href="#cb8-135"></a></span>
<span id="cb8-136"><a href="#cb8-136"></a>Thanks to STAC, cloud-optimized GeoTIFFs, and GDAL being capable of reading imagery from cloud storage directly, moving to cloud-based analysis workflows without downloading any imagery from portals become a lot easier and more efficient. Whether or not this is the right approach depends a lot on particular applications. In some cases (e.g. when having access to institutional HPC resources while applying very complex models on small areas of interest), it might still be appropriate to download the data once. The <span class="in">`gdalcubes`</span> package still can help as an interface to downloading analysis-ready data cubes instead of image files from portals. </span>
<span id="cb8-137"><a href="#cb8-137"></a></span>
<span id="cb8-138"><a href="#cb8-138"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
 © 2023 Marius Appel
  </li>  
</ul>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>