<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Marius Appel">
<title>gdalcubes - 3. Extracting training data for machine learning models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../favicon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../../styles.css">
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../source/gdalcubes_logo_mini.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">gdalcubes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../source/getstarted.html" rel="" target="">
 <span class="menu-text">Get started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../source/introduction/why.html" rel="" target="">
 <span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../source/tutorials/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../source/reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">
<li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/appelmar/gdalcubes_R/issues" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../source/introduction/faq.html" rel="" target=""><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">FAQ</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../../source/about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/appelmar/gdalcubes_R" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../source/tutorials/vignettes/gc03_ML_training_data.html">Extraction from data cubes</a></li><li class="breadcrumb-item"><a href="../../../source/tutorials/vignettes/gc03_ML_training_data.html">1. Extract training data for ML models</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Get started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc01_MODIS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Quickstart: Creating data cubes from local MODIS imagery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/Landsat8_getting_started/Landsat8_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. In-depth: Analyzing Landsat image collections</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">User-defined functions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/bfast/bfast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Change detection with bfast</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Cloud data access</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc02_AWS_Sentinel2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Sentinel-2 data on AWS</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Extraction from data cubes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/vignettes/gc03_ML_training_data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. Extract training data for ML models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../source/tutorials/videos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Videos</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#the-extract_geom-function" id="toc-the-extract_geom-function" class="nav-link active" data-scroll-target="#the-extract_geom-function">The <code>extract_geom()</code> function</a></li>
  <li><a href="#extracting-pixel-values-and-summary-statistics-from-spatial-polygons" id="toc-extracting-pixel-values-and-summary-statistics-from-spatial-polygons" class="nav-link" data-scroll-target="#extracting-pixel-values-and-summary-statistics-from-spatial-polygons">1. Extracting pixel values and summary statistics from spatial polygons</a></li>
  <li><a href="#time-series-extraction-from-spatial-points" id="toc-time-series-extraction-from-spatial-points" class="nav-link" data-scroll-target="#time-series-extraction-from-spatial-points">2. Time series extraction from spatial points</a></li>
  <li><a href="#combining-satellite-observations-with-in-situ-observations" id="toc-combining-satellite-observations-with-in-situ-observations" class="nav-link" data-scroll-target="#combining-satellite-observations-with-in-situ-observations">3. Combining satellite observations with in-situ observations</a></li>
  <li><a href="#further-options-to-extract-data" id="toc-further-options-to-extract-data" class="nav-link" data-scroll-target="#further-options-to-extract-data">Further options to extract data</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">3. Extracting training data for machine learning models</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Marius Appel </p>
          </div>
  </div>
    
  
    
  </div>
  

</header><p>Machine learning models for land cover classification, change detection, spatiotemporal prediction, and similar tasks in most cases need a large number of observations for training.</p>
<p>This vignette will demonstrate how training data from satellite image collections can be extracted for typical tasks including:</p>
<ol type="1">
<li>Classification from labeled spatial polygons</li>
<li>Time series extraction from spatial points</li>
<li>Combining satellite observations with in-situ observations or movement data (trajectories)</li>
</ol>
<p>One function that can do all of this is <code>extract_geom()</code>, which is similar to the <code>st_extract()</code> function from the <a href="https://cran.r-project.org/package=stars"><code>stars</code> package</a> and the <code>extract()</code> function from the <a href="https://cran.r-project.org/package=raster"><code>raster</code></a> and <a href="https://cran.r-project.org/package=terra"><code>terra</code></a> packages.</p>
<section id="the-extract_geom-function" class="level2"><h2 class="anchored" data-anchor-id="the-extract_geom-function">The <code>extract_geom()</code> function</h2>
<p>Given a data cube and any simple feature geometries as an <code>sf</code> object, the <code>extract_geom()</code> function can be used as a general method to extract data cube pixel values at irregular locations. <code>extract_geom()</code> returns a <code>data.frame</code> with columns for feature identifiers (FIDs, often row numbers of the <code>sf</code> object), time, and bands / variables of the data cube. Each row represents the data cube values of one pixel relating to the feature given by the FID column. For anything other than simple point geometries (e.g.&nbsp;POLYGON, LINESTRING, MULTIPOINT, and similar), the result may contain multiple rows per feature. In these cases, it is possible to apply an aggregation function to compute mean, median or similar summary statistics over features.</p>
<p><code>extract_geom()</code> drops any pixels with missing values only. Hence, if a feature is outside the extent of the data cube, or all pixels of a feature are NA due to clouds or unavailability of images, these pixels will not be included in the result. In contrast, if the input features contain overlapping geometries, pixels may be included several times (with different values in the FID column).</p>
<p>For multitemporal cubes, the full time series of pixels relating to the features is returned by default, leading to multiple rows with different time values. It is possible to specify the date/time of features using either an available time column from the <code>sf</code> object by name (argument <code>time_column</code>), or as an additional <code>Date</code>, <code>POSIXt</code>, or <code>character</code> vector with length corresponding to the number of features (argument <code>datetime</code>). In this case, only data cube pixels related to the time value of features is returned in the result instead of the full time series.</p>
<p>Compared to the <code>extract()</code> function from the <a href="https://cran.r-project.org/package=raster"><code>raster</code></a> and <a href="https://cran.r-project.org/package=terra"><code>terra</code></a> packages, <code>extract_geom()</code> is a little less flexible. For example, it is not possible to derive fractions of pixels covered by the features to compute weighted aggregations or similar.</p>
</section><section id="extracting-pixel-values-and-summary-statistics-from-spatial-polygons" class="level2"><h2 class="anchored" data-anchor-id="extracting-pixel-values-and-summary-statistics-from-spatial-polygons">1. Extracting pixel values and summary statistics from spatial polygons</h2>
<p>As a small example how to prepare training data for simple classification tasks, we use a labeled land cover polygon dataset covering the city of Muenster, Germany, which can be downloaded from https://uni-muenster.sciebo.de/s/fgyaomOJxSd93H8/download. This GeoPackage dataset contains spatial polygons with a column <em>class</em> representing land cover. We can directly download and plot the features using the <a href="https://cran.r-project.org/package=sf"><code>sf</code> package</a>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="do">## Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>training_sites <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="st">"https://uni-muenster.sciebo.de/s/fgyaomOJxSd93H8/download"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">plot</span>(training_sites, <span class="at">axes =</span> <span class="cn">TRUE</span>, <span class="at">key.pos =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc03_ML_training_data_files/figure-html/training_sites-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a rather small toy dataset but since the features are polygons, they already cover quite a few 10m pixels from Sentinel-2 imagery. As a first step to extract Sentinel-2 values within the polygons, we create a (virtual) data cube from Sentinel-2 data on Amazon Web Services (see previous vignette). Since the data is openly available, we can still work locally and do not need to run a machine on AWS (though this would be much faster for larger polygon datasets).</p>
<p>As our area of interest, we use the extent of the polygon dataset and look for (cloud-free) observations in July, 2021. To find corresponding images, we use the <a href="https://cran.r-project.org/package=rstac"><code>rstac</code> package</a> and query from the Sentinel-2 cloud-optimized GeoTIFF collection on AWS.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(training_sites) </span>
<span id="cb2-2"><a href="#cb2-2"></a>bbox</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="do">##      xmin      ymin      xmax      ymax </span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="do">##  7.576647 51.874603  7.673467 51.977592</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="fu">library</span>(rstac)</span>
<span id="cb2-6"><a href="#cb2-6"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb2-7"><a href="#cb2-7"></a>  items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb2-9"><a href="#cb2-9"></a>                <span class="at">bbox =</span> <span class="fu">c</span>(bbox[<span class="st">"xmin"</span>],bbox[<span class="st">"ymin"</span>],</span>
<span id="cb2-10"><a href="#cb2-10"></a>                         bbox[<span class="st">"xmax"</span>],bbox[<span class="st">"ymax"</span>]), </span>
<span id="cb2-11"><a href="#cb2-11"></a>                <span class="at">datetime =</span> <span class="st">"2021-07-01/2021-07-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="fu">length</span>(items<span class="sc">$</span>features)</span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="do">## [1] 26</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To filter by cloud coverage and create a gdalcubes image collection object, we apply <code>stac_image_collection()</code> on the resulting list of 26 images.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb3-2"><a href="#cb3-2"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">20</span>})</span>
<span id="cb3-3"><a href="#cb3-3"></a>s2_collection</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="do">## Image collection object, referencing 5 images with 21 bands</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="do">## Images:</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="do">##                       name     left      top   bottom    right</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="do">## 1 S2B_32ULC_20210723_0_L2A 6.946499 52.34304 51.34525 7.704564</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="do">## 2 S2B_32UMC_20210723_0_L2A 7.531544 52.35038 51.35444 9.143276</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="do">## 3 S2A_32ULC_20210718_0_L2A 6.952812 52.34304 51.34536 7.704564</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="do">## 4 S2A_32UMC_20210718_0_L2A 7.531544 52.35038 51.35444 9.143276</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="do">## 5 S2B_32ULC_20210703_0_L2A 6.948221 52.34304 51.34528 7.704564</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="do">##              datetime        srs</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="do">## 1 2021-07-23T10:36:40 EPSG:32632</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="do">## 2 2021-07-23T10:36:36 EPSG:32632</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="do">## 3 2021-07-18T10:36:41 EPSG:32632</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="do">## 4 2021-07-18T10:36:37 EPSG:32632</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="do">## 5 2021-07-03T10:36:39 EPSG:32632</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="do">## </span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="do">## Bands:</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="do">##            name offset scale unit nodata image_count</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="do">## 1           AOT      0     1                       5</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="do">## 2           B01      0     1                       5</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="do">## 3           B02      0     1                       5</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="do">## 4           B03      0     1                       5</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="do">## 5           B04      0     1                       5</span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="do">## 6           B05      0     1                       5</span></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="do">## 7           B06      0     1                       5</span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="do">## 8           B07      0     1                       5</span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="do">## 9           B08      0     1                       5</span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="do">## 10          B09      0     1                       5</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="do">## 11          B11      0     1                       5</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="do">## 12          B12      0     1                       5</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="do">## 13          B8A      0     1                       5</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="do">## 14          SCL      0     1                       5</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="do">## 15          WVP      0     1                       5</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="do">## 16 overview:B02      0     1                       5</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="do">## 17 overview:B03      0     1                       5</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="do">## 18 overview:B04      0     1                       5</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="do">## 19   visual:B02      0     1                       5</span></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="do">## 20   visual:B03      0     1                       5</span></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="do">## 21   visual:B04      0     1                       5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The collection contains five images only. However, we now create a rather large data cube with spatial extent from the image collection and 10m spatial resolution. Notice that this data cube is not downloaded but only created virtually, as a <em>proxy object</em> that knows where the corresponding images are located and what to do with the data when needed. In the example below, we use the visible RGB and the near infrared bands and add the NDVI vegetation index as a data cube band. Notice that we do not use a per-pixel cloud mask here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>s2_collection, <span class="at">dt=</span><span class="st">"P1M"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">srs=</span><span class="st">"EPSG:3857"</span>, </span>
<span id="cb4-2"><a href="#cb4-2"></a>                      <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span> <span class="co"># no mask</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>,<span class="st">"B08"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>, <span class="at">keep_bands =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ms_cube</span>
<span id="cb4-7"><a href="#cb4-7"></a>ms_cube</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="do">## A data cube proxy object</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="do">## </span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="do">## Dimensions:</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="do">##                low             high count pixel_size chunk_size</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="do">## t       2021-07-01       2021-07-31     1        P1M          1</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="do">## y 6682590.54960759 6863730.54960759 18114         10       1024</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="do">## x 773277.779989172 1017827.77998917 24455         10       1024</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="do">## </span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="do">## Bands:</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="do">##   name offset scale nodata unit</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="do">## 1  B02      0     1    NaN     </span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="do">## 2  B03      0     1    NaN     </span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="do">## 3  B04      0     1    NaN     </span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="do">## 4  B08      0     1    NaN     </span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="do">## 5 NDVI      0     1    NaN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The cube has 24455 x 18114 spatial pixels, which would sum to a GeoTIFF file of several gigabytes (depending on data type and compression), although the area of interest is quite small and we are only interested in a few pixels in the polygons. Fortunately, <code>extract_geom()</code> reduces unnecessary data reads to a large extent, meaning that even if we would use a data cube for whole Germany at 10m resolution, it would only read blocks of the data covering our area of interest, and simply ignore other parts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>x <span class="ot">=</span> <span class="fu">extract_geom</span>(ms_cube, training_sites)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">nrow</span>(x)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="do">## [1] 12744</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="fu">head</span>(x)</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="do">##   FID       time      B02      B03      B04      B08      NDVI</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="do">## 1   7 2021-07-01 312.3927 454.4502 300.3140 4142.701 0.8648152</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="do">## 2   7 2021-07-01 314.5155 445.5853 303.2982 4160.428 0.8641054</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="do">## 3   7 2021-07-01 320.6820 445.7498 307.1665 4165.566 0.8626493</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="do">## 4   7 2021-07-01 313.4379 459.7528 307.8308 4106.122 0.8605192</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="do">## 5   7 2021-07-01 318.1167 446.6952 311.6203 4140.536 0.8600138</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="do">## 6   7 2021-07-01 324.3806 444.3545 312.0102 4149.988 0.8601478</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As expected, the result contains multiple rows per polygon (because polygons cover multiple pixels). To compute summary statistics per polygon, we can provide a function as the <code>FUN</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>x <span class="ot">=</span> <span class="fu">extract_geom</span>(ms_cube, training_sites, <span class="at">FUN =</span> median)</span>
<span id="cb6-2"><a href="#cb6-2"></a>x</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="do">##    FID       time       B02       B03       B04       B08        NDVI</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="do">## 1    1 2021-07-01  266.2039  389.5117  218.2514  237.6531  0.04524603</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="do">## 2    2 2021-07-01  266.8352  368.6943  223.0690  257.1879  0.07006745</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="do">## 3    3 2021-07-01  642.4923  884.2024  987.9066 2134.6692  0.36731547</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="do">## 4    4 2021-07-01  339.1859  519.5446  314.6939 4237.5824  0.86212147</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="do">## 5    5 2021-07-01  742.0260 1048.1800 1432.2655 2591.4463  0.28675374</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="do">## 6    6 2021-07-01  554.2089  829.8890  866.6759 2255.3755  0.44919218</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="do">## 7    7 2021-07-01  427.3777  596.9655  485.9907 3970.5424  0.78361568</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="do">## 8    8 2021-07-01 1181.4101 1277.0147 1335.0851 1752.2424  0.10188053</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="do">## 9    9 2021-07-01  858.2257  990.5626 1143.5540 1573.5704  0.14296265</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="do">## 10  10 2021-07-01 1361.9271 1536.8561 1653.4901 2186.0671  0.09075880</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="do">## 11  11 2021-07-01  721.8104  867.5908 1001.1942 1868.7402  0.25241746</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="do">## 12  12 2021-07-01  269.9440  405.1574  237.6765 3493.1907  0.87339904</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="do">## 13  13 2021-07-01  288.0669  424.8431  261.3002 3458.0253  0.86101114</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="do">## 14  14 2021-07-01  277.8512  412.7048  245.6007 4087.6796  0.88691074</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="do">## 15  15 2021-07-01  599.5534  821.2706  498.7003  260.6612 -0.30120940</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="do">## 16  16 2021-07-01  538.8088  758.5329  407.5442  311.8426 -0.15754052</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To combine the extracted data cube values with the original <code>sf</code> objects including the geometries, the <code><a href="https://rdrr.io/r/base/merge.html">merge()</a></code> function can be used. <code><a href="https://rdrr.io/r/base/merge.html">merge()</a></code> performs table join operations on common columns (e.g.&nbsp;IDs). We therefore first need to add an FID column to the features and then join both tables by their FID columns. Notice that by default, this is performing an <em>inner join</em>, i.e.&nbsp;rows with FIDs that only exist in one table will be dropped. Alternatively, we can set <code>all.x=TRUE</code> to make sure that our result contains all features from the original dataset (left outer join). Below, we combine the tables, drop the geometries and order by NDVI, showing a clear relation between class and NDVI.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>x <span class="ot">=</span> x[<span class="fu">order</span>(x<span class="sc">$</span>NDVI,<span class="at">decreasing =</span> T),]</span>
<span id="cb7-2"><a href="#cb7-2"></a>training_sites<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(training_sites)</span>
<span id="cb7-3"><a href="#cb7-3"></a>trn_df <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>(<span class="fu">merge</span>(training_sites, x, <span class="at">by =</span> <span class="st">"FID"</span>))</span>
<span id="cb7-4"><a href="#cb7-4"></a>trn_df[<span class="fu">order</span>(trn_df<span class="sc">$</span>NDVI, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="do">##    FID       class       time       B02       B03       B04       B08</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="do">## 6   14      forest 2021-07-01  277.8512  412.7048  245.6007 4087.6796</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="do">## 4   12      forest 2021-07-01  269.9440  405.1574  237.6765 3493.1907</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="do">## 11   4 agriculture 2021-07-01  339.1859  519.5446  314.6939 4237.5824</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="do">## 5   13      forest 2021-07-01  288.0669  424.8431  261.3002 3458.0253</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="do">## 14   7 agriculture 2021-07-01  427.3777  596.9655  485.9907 3970.5424</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="do">## 13   6 agriculture 2021-07-01  554.2089  829.8890  866.6759 2255.3755</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="do">## 10   3 agriculture 2021-07-01  642.4923  884.2024  987.9066 2134.6692</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="do">## 12   5 agriculture 2021-07-01  742.0260 1048.1800 1432.2655 2591.4463</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="do">## 3   11       urban 2021-07-01  721.8104  867.5908 1001.1942 1868.7402</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="do">## 16   9       urban 2021-07-01  858.2257  990.5626 1143.5540 1573.5704</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="do">## 15   8       urban 2021-07-01 1181.4101 1277.0147 1335.0851 1752.2424</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="do">## 2   10       urban 2021-07-01 1361.9271 1536.8561 1653.4901 2186.0671</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="do">## 9    2       water 2021-07-01  266.8352  368.6943  223.0690  257.1879</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="do">## 1    1       water 2021-07-01  266.2039  389.5117  218.2514  237.6531</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="do">## 8   16       water 2021-07-01  538.8088  758.5329  407.5442  311.8426</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="do">## 7   15       water 2021-07-01  599.5534  821.2706  498.7003  260.6612</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="do">##           NDVI</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="do">## 6   0.88691074</span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="do">## 4   0.87339904</span></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="do">## 11  0.86212147</span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="do">## 5   0.86101114</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="do">## 14  0.78361568</span></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="do">## 13  0.44919218</span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="do">## 10  0.36731547</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="do">## 12  0.28675374</span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="do">## 3   0.25241746</span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="do">## 16  0.14296265</span></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="do">## 15  0.10188053</span></span>
<span id="cb7-34"><a href="#cb7-34"></a><span class="do">## 2   0.09075880</span></span>
<span id="cb7-35"><a href="#cb7-35"></a><span class="do">## 9   0.07006745</span></span>
<span id="cb7-36"><a href="#cb7-36"></a><span class="do">## 1   0.04524603</span></span>
<span id="cb7-37"><a href="#cb7-37"></a><span class="do">## 8  -0.15754052</span></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="do">## 7  -0.30120940</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="time-series-extraction-from-spatial-points" class="level2"><h2 class="anchored" data-anchor-id="time-series-extraction-from-spatial-points">2. Time series extraction from spatial points</h2>
<p>In the next example, we use MODIS land surface temperature measurements over Europe (see first vignette) and extract time series in London, Paris, and Barcelona. For each city, we define some points in the urban center as well as in the rural surrounding areas.</p>
<p>We start with downloading the MODIS data, if needed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>dest_dir <span class="ot">=</span> <span class="fu">tempdir</span>()</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>))) {</span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">options</span>(<span class="at">timeout =</span> <span class="fu">max</span>(<span class="dv">1800</span>, <span class="fu">getOption</span>(<span class="st">"timeout"</span>)))</span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">download.file</span>(<span class="st">"https://uni-muenster.sciebo.de/s/eP9E6OIkQbXrmsY/download"</span>, <span class="at">destfile=</span><span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>),<span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="fu">unzip</span>(<span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>), <span class="at">exdir =</span> <span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>))</span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">unlink</span>(<span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>))</span>
<span id="cb8-7"><a href="#cb8-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we build a gdalcubes image collection object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb9-2"><a href="#cb9-2"></a>files <span class="ot">=</span> <span class="fu">list.files</span>(<span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>), <span class="at">pattern=</span><span class="st">".hdf$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a>MODIS.collection <span class="ot">=</span> <span class="fu">create_image_collection</span>(files, <span class="st">"MxD11A2"</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>MODIS.collection</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="do">## Image collection object, referencing 140 images with 8 bands</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="do">## Images:</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="do">##                                                                name      left</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="do">## 1 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018001.h17v03.006.2018011145329 -20.00000</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="do">## 2 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018001.h17v04.006.2018011145438 -15.55724</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="do">## 3 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018001.h18v03.006.2018011145428   0.00000</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="do">## 4 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018001.h18v04.006.2018011145326   0.00000</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="do">## 5 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018009.h17v03.006.2018018034330 -20.00000</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="do">## 6 /tmp/RtmpHgZRl9/MOD11A2/MOD11A2.A2018009.h17v04.006.2018018034246 -15.55724</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="do">##   top bottom    right            datetime</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="do">## 1  60     50  0.00000 2018-01-01T00:00:00</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="do">## 2  50     40  0.00000 2018-01-01T00:00:00</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="do">## 3  60     50 20.00000 2018-01-01T00:00:00</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="do">## 4  50     40 15.55724 2018-01-01T00:00:00</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="do">## 5  60     50  0.00000 2018-01-09T00:00:00</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="do">## 6  50     40  0.00000 2018-01-09T00:00:00</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="do">##                                                                                                                                                                                                                                                                                                                                                                                                                                        srs</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="do">## 1 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="do">## 2 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="do">## 3 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="do">## 4 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="do">## 5 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="do">## 6 PROJCS["unnamed",GEOGCS["Unknown datum based upon the custom spheroid",DATUM["Not specified (based on custom spheroid)",SPHEROID["Custom spheroid",6371007.181,0]],PRIMEM["Greenwich",0],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]]],PROJECTION["Sinusoidal"],PARAMETER["longitude_of_center",0],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["Meter",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="do">## [ omitted 134 images ] </span></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="do">## </span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="do">## Bands:</span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="do">##              name offset scale unit     nodata image_count</span></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="do">## 1   DAY_VIEW_TIME   0.00 0.100  hrs 255.000000         140</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="do">## 2         EMIS_31   0.49 0.002        0.000000         140</span></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="do">## 3         EMIS_32   0.49 0.002        0.000000         140</span></span>
<span id="cb9-35"><a href="#cb9-35"></a><span class="do">## 4         LST_DAY   0.00 0.020    K   0.000000         140</span></span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="do">## 5       LST_NIGHT   0.00 0.020    K   0.000000         140</span></span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="do">## 6 NIGHT_VIEW_TIME   0.00 0.100  hrs 255.000000         140</span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="do">## 7          QC_DAY   0.00 1.000                         140</span></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="do">## 8        QC_NIGHT   0.00 1.000                         140</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we create some sample points from hand, where we want to extract the time series of land surface temperature measurements. We convert the created <code>data.frame</code> to an <code>sf</code> object using <code>st_as_sf()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># create points from hand...</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">2.347821</span>, <span class="fl">2.3062300</span>, <span class="fl">2.3802715</span>, <span class="fl">2.3562110</span>, <span class="fl">2.473618884</span>, <span class="fl">2.2717150</span>, <span class="fl">1.9978976</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">48.853590</span>, <span class="fl">48.8422630</span>, <span class="fl">48.8680197</span>, <span class="fl">48.8901057</span>, <span class="fl">48.670428823</span>, <span class="fl">49.0335277</span>, <span class="fl">48.6987311</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a>name <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"PARIS_URBAN_1"</span>, <span class="st">"PARIS_URBAN_2"</span>, <span class="st">"PARIS_URBAN_3"</span>, <span class="st">"PARIS_URBAN_4"</span>, <span class="st">"PARIS_RURAL_1"</span>, <span class="st">"PARIS_RURAL_2"</span>, <span class="st">"PARIS_RURAL_3"</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>x <span class="ot">=</span> <span class="fu">c</span>(x, <span class="sc">-</span><span class="fl">0.1004895</span>, <span class="sc">-</span><span class="fl">0.1018785</span>, <span class="sc">-</span><span class="fl">0.1250968</span>, <span class="sc">-</span><span class="fl">0.0810867</span>, <span class="fl">0.0490169</span>, <span class="sc">-</span><span class="fl">0.461243207</span>, <span class="sc">-</span><span class="fl">0.2806675</span>, <span class="sc">-</span><span class="fl">0.3103141</span>)</span>
<span id="cb10-7"><a href="#cb10-7"></a>y <span class="ot">=</span> <span class="fu">c</span>(y, <span class="fl">51.4941646</span>, <span class="fl">51.4653369</span>, <span class="fl">51.5268144</span>, <span class="fl">51.5109185</span>, <span class="fl">51.6569130</span>, <span class="fl">51.589319769</span>, <span class="fl">51.2611309</span>, <span class="fl">51.6595132</span>)</span>
<span id="cb10-8"><a href="#cb10-8"></a>name <span class="ot">=</span> <span class="fu">c</span>(name, <span class="st">"LONDON_URBAN_1"</span>, <span class="st">"LONDON_URBAN_2"</span>, <span class="st">"LONDON_URBAN_3"</span>,<span class="st">"LONDON_URBAN_4"</span>, <span class="st">"LONDON_RURAL_1"</span>, <span class="st">"LONDON_RURAL_2"</span>, <span class="st">"LONDON_RURAL_3"</span>, <span class="st">"LONDON_RURAL_4"</span>)</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a>x <span class="ot">=</span> <span class="fu">c</span>(x,<span class="fl">2.1599154</span>, <span class="fl">2.19904748</span>, <span class="fl">2.2230235</span>, <span class="fl">2.1670374</span>, <span class="fl">2.2290286</span>, <span class="fl">1.9649098</span>)</span>
<span id="cb10-11"><a href="#cb10-11"></a>y <span class="ot">=</span> <span class="fu">c</span>(y, <span class="fl">41.3879580</span>, <span class="fl">41.42672217</span>, <span class="fl">41.4274755</span>, <span class="fl">41.4556412</span>, <span class="fl">41.4823003</span>, <span class="fl">41.3235823</span>)</span>
<span id="cb10-12"><a href="#cb10-12"></a>name <span class="ot">=</span> <span class="fu">c</span>(name, <span class="st">"BARCELONA_URBAN_1"</span>, <span class="st">"BARCELONA_URBAN_2"</span>, <span class="st">"BARCELONA_URBAN_3"</span>, <span class="st">"BARCELONA_RURAL_1"</span>, <span class="st">"BARCELONA_RURAL_2"</span>, <span class="st">"BARCELONA_RURAL_3"</span>)</span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14"><a href="#cb10-14"></a>pts <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">name =</span> name)</span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="fu">library</span>(sf)</span>
<span id="cb10-17"><a href="#cb10-17"></a>sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(pts, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step, we build a 1km 8-daily cube over Europe, convert the measurements to degree Celsius and extract the time series using the <code>extract_geom()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">8</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>MODIS.collection, <span class="at">srs =</span> <span class="st">"EPSG:3035"</span>, <span class="at">dx =</span> <span class="dv">1000</span>, <span class="at">dy =</span> <span class="dv">1000</span>, <span class="at">dt =</span> <span class="st">"P8D"</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">raster_cube</span>(MODIS.collection, v)  <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"LST_DAY"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="fu">apply_pixel</span>(<span class="st">"LST_DAY * 0.02 - 273.15"</span>, <span class="st">"LST"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="fu">extract_geom</span>(sf) <span class="ot">-&gt;</span> result</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="fu">head</span>(result, <span class="at">n =</span> <span class="dv">40</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="do">##    FID       time    LST</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="do">## 1   16 2018-01-09  12.23</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="do">## 2   17 2018-01-09  12.15</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="do">## 3   18 2018-01-09  12.07</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="do">## 4   19 2018-01-09  10.19</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="do">## 5   20 2018-01-09   9.83</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="do">## 6   21 2018-01-09   9.81</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="do">## 7    1 2018-01-01   6.39</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="do">## 8    3 2018-01-01   4.77</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="do">## 9    5 2018-01-01   6.55</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="do">## 10   7 2018-01-01 -11.71</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="do">## 11  16 2018-01-25  15.11</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="do">## 12  17 2018-01-25  14.85</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="do">## 13  18 2018-01-25  15.11</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="do">## 14  19 2018-01-25  13.51</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="do">## 15  20 2018-01-25  12.91</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="do">## 16  21 2018-01-25  11.67</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="do">## 17  16 2018-01-01  13.33</span></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="do">## 18  17 2018-01-01  13.63</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="do">## 19  18 2018-01-01  13.33</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="do">## 20  19 2018-01-01  12.15</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="do">## 21  20 2018-01-01  14.73</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="do">## 22  21 2018-01-01  15.91</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="do">## 23  16 2018-01-17  17.13</span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="do">## 24  17 2018-01-17  16.87</span></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="do">## 25  18 2018-01-17  16.03</span></span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="do">## 26  19 2018-01-17  14.03</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="do">## 27  20 2018-01-17  13.65</span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="do">## 28  21 2018-01-17  13.81</span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="do">## 29  16 2018-02-10  14.33</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="do">## 30  17 2018-02-10  14.47</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="do">## 31  18 2018-02-10  15.69</span></span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="do">## 32  19 2018-02-10  12.63</span></span>
<span id="cb11-41"><a href="#cb11-41"></a><span class="do">## 33  20 2018-02-10   9.53</span></span>
<span id="cb11-42"><a href="#cb11-42"></a><span class="do">## 34  21 2018-02-10  11.93</span></span>
<span id="cb11-43"><a href="#cb11-43"></a><span class="do">## 35   8 2018-01-09   5.61</span></span>
<span id="cb11-44"><a href="#cb11-44"></a><span class="do">## 36   9 2018-01-09   1.67</span></span>
<span id="cb11-45"><a href="#cb11-45"></a><span class="do">## 37  10 2018-01-09   6.87</span></span>
<span id="cb11-46"><a href="#cb11-46"></a><span class="do">## 38  11 2018-01-09   5.53</span></span>
<span id="cb11-47"><a href="#cb11-47"></a><span class="do">## 39  12 2018-01-09   5.03</span></span>
<span id="cb11-48"><a href="#cb11-48"></a><span class="do">## 40  13 2018-01-09   3.85</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result contains FID, time, and LST as columns and we can combine the data with the original sf object with <code><a href="https://rdrr.io/r/base/merge.html">merge()</a></code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>sf<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(sf)</span>
<span id="cb12-2"><a href="#cb12-2"></a>df <span class="ot">=</span> <span class="fu">merge</span>(sf, result, <span class="at">by =</span> <span class="st">"FID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the time series as in the example below, showing some differences between the rural and the urban locations for Paris and Barcelona.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>df <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">startsWith</span>(name, <span class="st">"PARIS"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(time), <span class="at">y =</span> LST, <span class="at">color =</span> FID, <span class="at">group =</span> FID)) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Paris"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"LST [K]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc03_ML_training_data_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>  </span>
<span id="cb14-2"><a href="#cb14-2"></a>df <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">startsWith</span>(name, <span class="st">"BARCELONA"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(time), <span class="at">y =</span> LST, <span class="at">color =</span> FID, <span class="at">group =</span> FID)) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>()  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Barcelona"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"LST [K]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc03_ML_training_data_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A similar workflow can e.g.&nbsp;be used to create patterns for time series classification using the <a href="https://cran.r-project.org/package=dtwSat"><code>dtwSat</code> package</a>.</p>
</section><section id="combining-satellite-observations-with-in-situ-observations" class="level2"><h2 class="anchored" data-anchor-id="combining-satellite-observations-with-in-situ-observations">3. Combining satellite observations with in-situ observations</h2>
<p>The previous examples have used spatial features without time information. For applications where interest lies in the combination of satellite-based and in-situ observations or adding satellite observations to movement data such as animal tracks, time information is available for the spatial features (mostly points) and should be considered in the analysis. In this example, we will use primary data from the European <a href="https://ec.europa.eu/eurostat/web/lucas/">Land Use and Coverage Area frame Survey (LUCAS)</a> containing land cover point samples from 2018. The data can be downloaded as country-wise CSV files (see <a href="https://ec.europa.eu/eurostat/de/web/lucas/data/primary-data/2018">here</a>). We will use observations over Germany, subset some specific crop types and combine the points with Sentinel-2 NDVI observations.</p>
<p>As a first step, we load the data, remove rows with missing coordinates and convert the data.frame to an sf object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>x <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"https://ec.europa.eu/eurostat/cache/lucas/DE_2018_20200213.CSV"</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>x <span class="ot">=</span> x[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">is.na</span>(x<span class="sc">$</span>TH_LAT) <span class="sc">|</span> <span class="fu">is.na</span>(x<span class="sc">$</span>TH_LONG)),]</span>
<span id="cb15-3"><a href="#cb15-3"></a>x <span class="ot">=</span> <span class="fu">st_as_sf</span>(x, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"TH_LONG"</span>, <span class="st">"TH_LAT"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards we extract the observation date from points and add it as a new column <code>t</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>x<span class="sc">$</span>t <span class="ot">=</span> <span class="fu">as.Date</span>(x<span class="sc">$</span>SURVEY_DATE, <span class="at">format =</span> <span class="st">"%d/%m/%y"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dominant land cover type is encoded in the <code>LC1</code> column, where a letter indicates the major class (e.g., forest, agriculture, water, or urban) that is followed by a number to identify more specific types (e.g.&nbsp;wheat, barley, oat, and others for class agriculture). Here, we are interested in four different crop types (common wheat, barley, rye, and maize). Below, we select corresponding points and randomly sample 100 points for each type and add common names to the relevant land cover types.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>x[<span class="fu">startsWith</span>(x<span class="sc">$</span>LC1, <span class="fu">c</span>(<span class="st">"B11"</span>, <span class="st">"B13"</span>, <span class="st">"B14"</span>, <span class="st">"B16"</span>)), <span class="fu">c</span>(<span class="st">"LC1"</span>,<span class="st">"t"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(LC1) <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="ot">-&gt;</span> training</span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a>names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B11"</span> <span class="ot">=</span> <span class="st">"Common Wheat"</span>,</span>
<span id="cb17-6"><a href="#cb17-6"></a>          <span class="st">"B13"</span> <span class="ot">=</span> <span class="st">"Barley"</span>,</span>
<span id="cb17-7"><a href="#cb17-7"></a>          <span class="st">"B14"</span> <span class="ot">=</span> <span class="st">"Rye"</span>,</span>
<span id="cb17-8"><a href="#cb17-8"></a>          <span class="st">"B16"</span> <span class="ot">=</span> <span class="st">"Maize"</span>)</span>
<span id="cb17-9"><a href="#cb17-9"></a></span>
<span id="cb17-10"><a href="#cb17-10"></a>training<span class="sc">$</span>LC1_NAME <span class="ot">=</span> names[training<span class="sc">$</span>LC1]</span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="fu">table</span>(training<span class="sc">$</span>LC1_NAME)</span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="do">## </span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="do">##       Barley Common Wheat        Maize          Rye </span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="do">##          100          100          100          100</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="fu">plot</span>(training[,<span class="st">"LC1_NAME"</span>], <span class="at">key.pos =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc03_ML_training_data_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The result contains 400 samples with observations at different dates. To add NDVI measurements to the data, we now request available Sentinel-2 images from the Sentinel-2 cloud-optimized GeoTIFF collection on AWS within the area and time of interest using <code>rstac</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(training) </span>
<span id="cb18-2"><a href="#cb18-2"></a>bbox</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="do">##      xmin      ymin      xmax      ymax </span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="do">##  6.219421 47.673906 14.878689 54.731253</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="fu">library</span>(rstac)</span>
<span id="cb18-6"><a href="#cb18-6"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb18-7"><a href="#cb18-7"></a>items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>              <span class="at">bbox =</span> <span class="fu">c</span>(bbox[<span class="st">"xmin"</span>],bbox[<span class="st">"ymin"</span>],</span>
<span id="cb18-10"><a href="#cb18-10"></a>                       bbox[<span class="st">"xmax"</span>],bbox[<span class="st">"ymax"</span>]), </span>
<span id="cb18-11"><a href="#cb18-11"></a>              <span class="at">datetime =</span> <span class="st">"2018-05-01/2018-09-30"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result contains 5253 images. Next, we load the <code>gdalcubes</code> package, create an image collection object from the STAC result and at the same time filter images by cloud cover.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb19-2"><a href="#cb19-2"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The collection contains 2387 remaining images with less than 10% cloud cover. Now we create a data cube at original 10m spatial resolution and use the revisit time (5 days) as temporal resolution. We also derive NDVI measurements and drop unneeded bands on-the-fly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>s2_collection, <span class="at">dt=</span><span class="st">"P5D"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">srs=</span><span class="st">"EPSG:3857"</span>, </span>
<span id="cb20-2"><a href="#cb20-2"></a>              <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"nearest"</span>)</span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="fu">raster_cube</span>(s2_collection, v, <span class="at">chunking =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">512</span>,<span class="dv">512</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B04"</span>,<span class="st">"B08"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>) <span class="ot">-&gt;</span> cube</span>
<span id="cb20-7"><a href="#cb20-7"></a>cube</span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="do">## A data cube proxy object</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="do">## </span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="do">## Dimensions:</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="do">##                low             high  count pixel_size chunk_size</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="do">## t       2018-05-03       2018-10-04     31        P5D          1</span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="do">## y  5908460.4569991  7370990.4569991 146253         10        512</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="do">## x 503996.201529035 1686796.20152904 118280         10        512</span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="do">## </span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="do">## Bands:</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="do">##   name offset scale nodata unit</span></span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="do">## 1 NDVI      0     1    NaN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that the selection of resolution here has some important implications:</p>
<ol type="1">
<li><p>Spatially larger pixels increase the likelihood that the pixel corresponding with a point contains different land cover classes, a moderate increasement, however, may still be helpful to include a bit of spatial context and reduce noise.</p></li>
<li><p>Using a lower temporal resolution (e.g.&nbsp;in a monthly aggregated cube) reduces the amount of missing data (e.g.&nbsp;due to clouds) but of course decreases the time accuracy of measurements.</p></li>
</ol>
<p>To extract the samples from the cube, we call <code>extract_geom()</code>, provide the training data and the name of the time column. Please notice that we use quite a few parallel worker instances (even more than the number of cores of the machine) to make downloading the data a little faster. Although the extraction will only need to download smaller patches of images that intersect (in space and time) with the points, it is still the most time consuming part of the extraction when working locally (not on AWS, where the data is stored). As a result, the extraction might take a few minutes on your local machine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">12</span>)</span>
<span id="cb21-2"><a href="#cb21-2"></a>cubex <span class="ot">&lt;-</span> <span class="fu">extract_geom</span>(cube,training, <span class="at">time_column =</span> <span class="st">"t"</span>)</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="fu">nrow</span>(cubex)</span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="do">## [1] 167</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once available, notice that the number of results is smaller than the number of selected sample points simply because for some points there was no (cloud-free) image available. We can now merge the results with the point features and plot the NDVI by time for the different crop types.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>sf <span class="ot">=</span> training</span>
<span id="cb22-2"><a href="#cb22-2"></a>sf<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(sf)</span>
<span id="cb22-3"><a href="#cb22-3"></a>df <span class="ot">=</span> <span class="fu">merge</span>(sf, cubex, <span class="at">by =</span> <span class="st">"FID"</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb22-7"><a href="#cb22-7"></a>p <span class="ot">=</span> <span class="fu">lapply</span>(names, <span class="cf">function</span>(x) {</span>
<span id="cb22-8"><a href="#cb22-8"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(LC1_NAME <span class="sc">==</span> x) <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>    <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(t), <span class="at">y =</span> NDVI)) <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>) <span class="sc">+</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb22-13"><a href="#cb22-13"></a>    <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2018-05-01"</span>),<span class="fu">as.Date</span>(<span class="st">"2018-09-30"</span>))) <span class="sc">+</span> </span>
<span id="cb22-14"><a href="#cb22-14"></a>    <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"NDVI"</span>)  <span class="sc">+</span> <span class="fu">ggtitle</span>(x)</span>
<span id="cb22-15"><a href="#cb22-15"></a>})</span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> p)</span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="do">## `geom_smooth()` using formula = 'y ~ x'</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="do">## `geom_smooth()` using formula = 'y ~ x'</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="do">## `geom_smooth()` using formula = 'y ~ x'</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="do">## `geom_smooth()` using formula = 'y ~ x'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="gc03_ML_training_data_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="further-options-to-extract-data" class="level2"><h2 class="anchored" data-anchor-id="further-options-to-extract-data">Further options to extract data</h2>
<p>Notice that extraction with <code>extract_geom()</code> is not the only possible way to extract pixels or time series from data cubes. For smaller amounts of samples, extraction can be performed entirely using the available operations <code>crop()</code>, <code>slice_time()</code>, <code>slice_space()</code>, or the general selection operator <code>[</code>. For example, extraction of a few spatiotetemporal points on the LUCAS data (see last example) can also achieved by iterating over all samples and extracting a single point using <code>cube[x$geometry, x$t]</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>NDVI <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(training)) {</span>
<span id="cb23-3"><a href="#cb23-3"></a>  y <span class="ot">=</span> cube[x<span class="sc">$</span>geometry[i],x<span class="sc">$</span>t[i]]</span>
<span id="cb23-4"><a href="#cb23-4"></a>  ndvi_pixel <span class="ot">&lt;-</span> <span class="fu">as_array</span>(y)</span>
<span id="cb23-5"><a href="#cb23-5"></a>  NDVI <span class="ot">=</span> <span class="fu">c</span>(NDVI, <span class="fu">as.vector</span>(ndvi_pixel))</span>
<span id="cb23-6"><a href="#cb23-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are of course other applications that require a different preparation of training data. As an example, gdalcubes can also be used for the creation of spatial (or even spatiotemporal) blocks in order to apply convolutional neural networks for object detection, or segmentation tasks.</p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="an">title:</span><span class="co"> "3. Extracting training data for machine learning models"</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="an">author:</span><span class="co"> "Marius Appel"</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co">  rmarkdown::html_vignette</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="an">vignette:</span><span class="co"> &gt;</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co">  %\VignetteIndexEntry{3. Extracting training data for machine learning models}</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co">  %\VignetteEncoding{UTF-8}</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co">  %\VignetteEngine{knitr::rmarkdown}</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">---</span></span>
<span id="cb24-13"><a href="#cb24-13"></a></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>ev <span class="ot">=</span> <span class="fu">unname</span>(<span class="fu">Sys.info</span>()[<span class="st">"user"</span>]) <span class="sc">==</span> <span class="st">"marius"</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb24-17"><a href="#cb24-17"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-18"><a href="#cb24-18"></a>  <span class="at">eval =</span> ev</span>
<span id="cb24-19"><a href="#cb24-19"></a>)</span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="in">```</span></span>
<span id="cb24-21"><a href="#cb24-21"></a></span>
<span id="cb24-22"><a href="#cb24-22"></a></span>
<span id="cb24-23"><a href="#cb24-23"></a>Machine learning models for land cover classification, change detection, spatiotemporal prediction, and similar tasks in most cases need a large number of observations for training. </span>
<span id="cb24-24"><a href="#cb24-24"></a></span>
<span id="cb24-25"><a href="#cb24-25"></a>This vignette will demonstrate how training data from satellite image collections can be extracted for typical tasks including:</span>
<span id="cb24-26"><a href="#cb24-26"></a></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="ss">1. </span>Classification from labeled spatial polygons</span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="ss">2. </span>Time series extraction from spatial points</span>
<span id="cb24-29"><a href="#cb24-29"></a><span class="ss">3. </span>Combining satellite observations with in-situ observations or movement data (trajectories)</span>
<span id="cb24-30"><a href="#cb24-30"></a></span>
<span id="cb24-31"><a href="#cb24-31"></a>One function that can do all of this is <span class="in">`extract_geom()`</span>, which is similar to the <span class="in">`st_extract()`</span> function from the <span class="co">[</span><span class="ot">`stars` package</span><span class="co">](https://cran.r-project.org/package=stars)</span> and the <span class="in">`extract()`</span> function from the <span class="co">[</span><span class="ot">`raster`</span><span class="co">](https://cran.r-project.org/package=raster)</span> and <span class="co">[</span><span class="ot">`terra`</span><span class="co">](https://cran.r-project.org/package=terra)</span> packages.</span>
<span id="cb24-32"><a href="#cb24-32"></a></span>
<span id="cb24-33"><a href="#cb24-33"></a></span>
<span id="cb24-34"><a href="#cb24-34"></a><span class="fu">## The `extract_geom()` function</span></span>
<span id="cb24-35"><a href="#cb24-35"></a></span>
<span id="cb24-36"><a href="#cb24-36"></a>Given a data cube and any simple feature geometries as an <span class="in">`sf`</span> object, the <span class="in">`extract_geom()`</span> function can be used as a general method to extract data cube pixel values at irregular locations. <span class="in">`extract_geom()`</span> returns a <span class="in">`data.frame`</span> with columns for feature identifiers (FIDs, often row numbers of the <span class="in">`sf`</span> object), time, and bands / variables of the data cube. Each row represents the data cube values of one pixel relating to the feature given by the FID column. For anything other than simple point geometries (e.g. POLYGON, LINESTRING, MULTIPOINT, and similar), the result may contain multiple rows per feature. In these cases, it is possible to apply an aggregation function to compute mean, median or similar summary statistics over features. </span>
<span id="cb24-37"><a href="#cb24-37"></a></span>
<span id="cb24-38"><a href="#cb24-38"></a><span class="in">`extract_geom()`</span> drops any pixels with missing values only. Hence, if a feature is outside the extent of the data cube, or all pixels  of a feature are NA due to clouds or unavailability of images, these pixels will not be included in the result. In contrast, if the input features contain overlapping geometries, pixels may be included several times (with different values in the FID column). </span>
<span id="cb24-39"><a href="#cb24-39"></a></span>
<span id="cb24-40"><a href="#cb24-40"></a>For multitemporal cubes, the full time series of pixels relating to the features is returned by default, leading to multiple rows with different time values. It is possible to specify the date/time of features using either an available time column from the <span class="in">`sf`</span> object by name (argument <span class="in">`time_column`</span>), or as an additional <span class="in">`Date`</span>, <span class="in">`POSIXt`</span>, or <span class="in">`character`</span> vector with length corresponding to the number of features (argument <span class="in">`datetime`</span>). In this case, only data cube pixels related to the time value of features is returned in the result instead of the full time series.</span>
<span id="cb24-41"><a href="#cb24-41"></a></span>
<span id="cb24-42"><a href="#cb24-42"></a>Compared to the <span class="in">`extract()`</span> function from the <span class="co">[</span><span class="ot">`raster`</span><span class="co">](https://cran.r-project.org/package=raster)</span> and <span class="co">[</span><span class="ot">`terra`</span><span class="co">](https://cran.r-project.org/package=terra)</span> packages, <span class="in">`extract_geom()`</span> is a little less flexible. For example, it is not possible to derive fractions of pixels covered by the features to compute weighted aggregations or similar.</span>
<span id="cb24-43"><a href="#cb24-43"></a></span>
<span id="cb24-44"><a href="#cb24-44"></a></span>
<span id="cb24-45"><a href="#cb24-45"></a></span>
<span id="cb24-46"><a href="#cb24-46"></a><span class="fu">## 1. Extracting pixel values and summary statistics from spatial polygons</span></span>
<span id="cb24-47"><a href="#cb24-47"></a></span>
<span id="cb24-48"><a href="#cb24-48"></a>As a small example how to prepare training data for simple classification tasks, we use a labeled land cover polygon dataset covering the city of Muenster, Germany, which can be downloaded from https://uni-muenster.sciebo.de/s/fgyaomOJxSd93H8/download. This GeoPackage dataset contains spatial polygons with a column _class_ representing land cover. We can directly download and plot the features using the <span class="co">[</span><span class="ot">`sf` package</span><span class="co">](https://cran.r-project.org/package=sf)</span>:</span>
<span id="cb24-49"><a href="#cb24-49"></a></span>
<span id="cb24-50"><a href="#cb24-50"></a><span class="in">```{r training_sites, fig.align='center'}</span></span>
<span id="cb24-51"><a href="#cb24-51"></a><span class="fu">library</span>(sf)</span>
<span id="cb24-52"><a href="#cb24-52"></a>training_sites <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="st">"https://uni-muenster.sciebo.de/s/fgyaomOJxSd93H8/download"</span>)</span>
<span id="cb24-53"><a href="#cb24-53"></a><span class="fu">plot</span>(training_sites, <span class="at">axes =</span> <span class="cn">TRUE</span>, <span class="at">key.pos =</span> <span class="dv">1</span>)</span>
<span id="cb24-54"><a href="#cb24-54"></a><span class="in">```</span></span>
<span id="cb24-55"><a href="#cb24-55"></a>This is a rather small toy dataset but since the features are polygons, they already cover quite a few 10m pixels from Sentinel-2 imagery. As a first step to extract Sentinel-2 values within the polygons, we create a (virtual) data cube from Sentinel-2 data on Amazon Web Services (see previous vignette). Since the data is openly available, we can still work locally and do not need to run a machine on AWS (though this would be much faster for larger polygon datasets).</span>
<span id="cb24-56"><a href="#cb24-56"></a></span>
<span id="cb24-57"><a href="#cb24-57"></a>As our area of interest, we use the extent of the polygon dataset and look for (cloud-free) observations in July, 2021. To find corresponding images, we use the <span class="co">[</span><span class="ot">`rstac` package</span><span class="co">](https://cran.r-project.org/package=rstac)</span> and query from the Sentinel-2 cloud-optimized GeoTIFF collection on AWS.</span>
<span id="cb24-58"><a href="#cb24-58"></a></span>
<span id="cb24-59"><a href="#cb24-59"></a><span class="in">```{r stac}</span></span>
<span id="cb24-60"><a href="#cb24-60"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(training_sites) </span>
<span id="cb24-61"><a href="#cb24-61"></a>bbox</span>
<span id="cb24-62"><a href="#cb24-62"></a><span class="fu">library</span>(rstac)</span>
<span id="cb24-63"><a href="#cb24-63"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb24-64"><a href="#cb24-64"></a>  items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb24-65"><a href="#cb24-65"></a>    <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb24-66"><a href="#cb24-66"></a>                <span class="at">bbox =</span> <span class="fu">c</span>(bbox[<span class="st">"xmin"</span>],bbox[<span class="st">"ymin"</span>],</span>
<span id="cb24-67"><a href="#cb24-67"></a>                         bbox[<span class="st">"xmax"</span>],bbox[<span class="st">"ymax"</span>]), </span>
<span id="cb24-68"><a href="#cb24-68"></a>                <span class="at">datetime =</span> <span class="st">"2021-07-01/2021-07-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-69"><a href="#cb24-69"></a>    <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-70"><a href="#cb24-70"></a>  <span class="fu">length</span>(items<span class="sc">$</span>features)</span>
<span id="cb24-71"><a href="#cb24-71"></a><span class="in">```</span></span>
<span id="cb24-72"><a href="#cb24-72"></a>To filter by cloud coverage and create a gdalcubes image collection object, we apply <span class="in">`stac_image_collection()`</span> on the resulting list of 26 images. </span>
<span id="cb24-73"><a href="#cb24-73"></a></span>
<span id="cb24-76"><a href="#cb24-76"></a><span class="in">```{r}</span></span>
<span id="cb24-77"><a href="#cb24-77"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb24-78"><a href="#cb24-78"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">20</span>})</span>
<span id="cb24-79"><a href="#cb24-79"></a>s2_collection</span>
<span id="cb24-80"><a href="#cb24-80"></a><span class="in">```</span></span>
<span id="cb24-81"><a href="#cb24-81"></a></span>
<span id="cb24-82"><a href="#cb24-82"></a>The collection contains five images only. However, we now create a rather large data cube with spatial extent from the image collection and 10m spatial resolution. Notice that this data cube is not downloaded but only created virtually, as a _proxy object_ that knows where the corresponding images are located and what to do with the data when needed. In the example below, we use the visible RGB and the near infrared bands and add the NDVI vegetation index as a data cube band. Notice that we do not use a per-pixel cloud mask here.</span>
<span id="cb24-83"><a href="#cb24-83"></a></span>
<span id="cb24-86"><a href="#cb24-86"></a><span class="in">```{r}</span></span>
<span id="cb24-87"><a href="#cb24-87"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>s2_collection, <span class="at">dt=</span><span class="st">"P1M"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">srs=</span><span class="st">"EPSG:3857"</span>, </span>
<span id="cb24-88"><a href="#cb24-88"></a>                      <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb24-89"><a href="#cb24-89"></a></span>
<span id="cb24-90"><a href="#cb24-90"></a><span class="fu">raster_cube</span>(s2_collection, v) <span class="sc">|&gt;</span> <span class="co"># no mask</span></span>
<span id="cb24-91"><a href="#cb24-91"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>,<span class="st">"B08"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-92"><a href="#cb24-92"></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>, <span class="at">keep_bands =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ms_cube</span>
<span id="cb24-93"><a href="#cb24-93"></a>ms_cube</span>
<span id="cb24-94"><a href="#cb24-94"></a><span class="in">```</span></span>
<span id="cb24-95"><a href="#cb24-95"></a></span>
<span id="cb24-96"><a href="#cb24-96"></a>The cube has 24455 x 18114 spatial pixels, which would sum to a GeoTIFF file of several gigabytes (depending on data type and compression), although the area of interest is quite small and we are only interested in a few pixels in the polygons. Fortunately, <span class="in">`extract_geom()`</span> reduces unnecessary data reads to a large extent, meaning that even if we would use a data cube for whole Germany at 10m resolution, it would only read blocks of the data covering our area of interest, and simply ignore other parts. </span>
<span id="cb24-97"><a href="#cb24-97"></a></span>
<span id="cb24-100"><a href="#cb24-100"></a><span class="in">```{r}</span></span>
<span id="cb24-101"><a href="#cb24-101"></a>x <span class="ot">=</span> <span class="fu">extract_geom</span>(ms_cube, training_sites)</span>
<span id="cb24-102"><a href="#cb24-102"></a><span class="fu">nrow</span>(x)</span>
<span id="cb24-103"><a href="#cb24-103"></a><span class="fu">head</span>(x)</span>
<span id="cb24-104"><a href="#cb24-104"></a><span class="in">```</span></span>
<span id="cb24-105"><a href="#cb24-105"></a></span>
<span id="cb24-106"><a href="#cb24-106"></a>As expected, the result contains multiple rows per polygon (because polygons cover multiple pixels). To compute summary statistics per polygon, we can provide a function as the <span class="in">`FUN`</span> argument:</span>
<span id="cb24-107"><a href="#cb24-107"></a></span>
<span id="cb24-110"><a href="#cb24-110"></a><span class="in">```{r}</span></span>
<span id="cb24-111"><a href="#cb24-111"></a>x <span class="ot">=</span> <span class="fu">extract_geom</span>(ms_cube, training_sites, <span class="at">FUN =</span> median)</span>
<span id="cb24-112"><a href="#cb24-112"></a>x</span>
<span id="cb24-113"><a href="#cb24-113"></a><span class="in">```</span></span>
<span id="cb24-114"><a href="#cb24-114"></a></span>
<span id="cb24-115"><a href="#cb24-115"></a>To combine the extracted data cube values with the original <span class="in">`sf`</span> objects including the geometries, the <span class="in">`merge()`</span> function can be used. <span class="in">`merge()`</span> performs table join operations on common columns (e.g. IDs). We therefore first need to add an FID column to the features and then join both tables by their FID columns. Notice that by default, this is performing an _inner join_, i.e. rows with FIDs that only exist in one table will be dropped. Alternatively, we can set <span class="in">`all.x=TRUE`</span> to make sure that our result contains all features from the original dataset (left outer join). Below, we combine the tables, drop the geometries and order by NDVI, showing a clear relation between class and NDVI.</span>
<span id="cb24-116"><a href="#cb24-116"></a></span>
<span id="cb24-119"><a href="#cb24-119"></a><span class="in">```{r}</span></span>
<span id="cb24-120"><a href="#cb24-120"></a>x <span class="ot">=</span> x[<span class="fu">order</span>(x<span class="sc">$</span>NDVI,<span class="at">decreasing =</span> T),]</span>
<span id="cb24-121"><a href="#cb24-121"></a>training_sites<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(training_sites)</span>
<span id="cb24-122"><a href="#cb24-122"></a>trn_df <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>(<span class="fu">merge</span>(training_sites, x, <span class="at">by =</span> <span class="st">"FID"</span>))</span>
<span id="cb24-123"><a href="#cb24-123"></a>trn_df[<span class="fu">order</span>(trn_df<span class="sc">$</span>NDVI, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb24-124"><a href="#cb24-124"></a><span class="in">```</span></span>
<span id="cb24-125"><a href="#cb24-125"></a></span>
<span id="cb24-126"><a href="#cb24-126"></a><span class="fu">## 2. Time series extraction from spatial points</span></span>
<span id="cb24-127"><a href="#cb24-127"></a></span>
<span id="cb24-128"><a href="#cb24-128"></a>In the next example, we use MODIS land surface temperature measurements over Europe (see first vignette) and extract time series in London, Paris, and Barcelona. For each city, we define some points in the urban center as well as in the rural surrounding areas.</span>
<span id="cb24-129"><a href="#cb24-129"></a></span>
<span id="cb24-130"><a href="#cb24-130"></a>We start with downloading the MODIS data, if needed:</span>
<span id="cb24-131"><a href="#cb24-131"></a></span>
<span id="cb24-132"><a href="#cb24-132"></a><span class="in">```{r data_download, echo=TRUE, results='hide'}</span></span>
<span id="cb24-133"><a href="#cb24-133"></a>dest_dir <span class="ot">=</span> <span class="fu">tempdir</span>()</span>
<span id="cb24-134"><a href="#cb24-134"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>))) {</span>
<span id="cb24-135"><a href="#cb24-135"></a>  <span class="fu">options</span>(<span class="at">timeout =</span> <span class="fu">max</span>(<span class="dv">1800</span>, <span class="fu">getOption</span>(<span class="st">"timeout"</span>)))</span>
<span id="cb24-136"><a href="#cb24-136"></a>  <span class="fu">download.file</span>(<span class="st">"https://uni-muenster.sciebo.de/s/eP9E6OIkQbXrmsY/download"</span>, <span class="at">destfile=</span><span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>),<span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb24-137"><a href="#cb24-137"></a>  <span class="fu">unzip</span>(<span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>), <span class="at">exdir =</span> <span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>))</span>
<span id="cb24-138"><a href="#cb24-138"></a>  <span class="fu">unlink</span>(<span class="fu">file.path</span>(dest_dir, <span class="st">"MOD11A2.zip"</span>))</span>
<span id="cb24-139"><a href="#cb24-139"></a>}</span>
<span id="cb24-140"><a href="#cb24-140"></a><span class="in">```</span></span>
<span id="cb24-141"><a href="#cb24-141"></a>Next, we build a gdalcubes image collection object:</span>
<span id="cb24-142"><a href="#cb24-142"></a></span>
<span id="cb24-145"><a href="#cb24-145"></a><span class="in">```{r}</span></span>
<span id="cb24-146"><a href="#cb24-146"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb24-147"><a href="#cb24-147"></a>files <span class="ot">=</span> <span class="fu">list.files</span>(<span class="fu">file.path</span>(dest_dir,<span class="st">"MOD11A2"</span>), <span class="at">pattern=</span><span class="st">".hdf$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-148"><a href="#cb24-148"></a>MODIS.collection <span class="ot">=</span> <span class="fu">create_image_collection</span>(files, <span class="st">"MxD11A2"</span>)</span>
<span id="cb24-149"><a href="#cb24-149"></a>MODIS.collection</span>
<span id="cb24-150"><a href="#cb24-150"></a><span class="in">```</span></span>
<span id="cb24-151"><a href="#cb24-151"></a></span>
<span id="cb24-152"><a href="#cb24-152"></a>Now, we create some sample points from hand, where we want to extract the time series of land surface temperature measurements. We convert the created <span class="in">`data.frame`</span> to an <span class="in">`sf`</span> object using <span class="in">`st_as_sf()`</span>.</span>
<span id="cb24-153"><a href="#cb24-153"></a></span>
<span id="cb24-156"><a href="#cb24-156"></a><span class="in">```{r}</span></span>
<span id="cb24-157"><a href="#cb24-157"></a><span class="co"># create points from hand...</span></span>
<span id="cb24-158"><a href="#cb24-158"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">2.347821</span>, <span class="fl">2.3062300</span>, <span class="fl">2.3802715</span>, <span class="fl">2.3562110</span>, <span class="fl">2.473618884</span>, <span class="fl">2.2717150</span>, <span class="fl">1.9978976</span>)</span>
<span id="cb24-159"><a href="#cb24-159"></a>y <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">48.853590</span>, <span class="fl">48.8422630</span>, <span class="fl">48.8680197</span>, <span class="fl">48.8901057</span>, <span class="fl">48.670428823</span>, <span class="fl">49.0335277</span>, <span class="fl">48.6987311</span>)</span>
<span id="cb24-160"><a href="#cb24-160"></a>name <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"PARIS_URBAN_1"</span>, <span class="st">"PARIS_URBAN_2"</span>, <span class="st">"PARIS_URBAN_3"</span>, <span class="st">"PARIS_URBAN_4"</span>, <span class="st">"PARIS_RURAL_1"</span>, <span class="st">"PARIS_RURAL_2"</span>, <span class="st">"PARIS_RURAL_3"</span>)</span>
<span id="cb24-161"><a href="#cb24-161"></a></span>
<span id="cb24-162"><a href="#cb24-162"></a>x <span class="ot">=</span> <span class="fu">c</span>(x, <span class="sc">-</span><span class="fl">0.1004895</span>, <span class="sc">-</span><span class="fl">0.1018785</span>, <span class="sc">-</span><span class="fl">0.1250968</span>, <span class="sc">-</span><span class="fl">0.0810867</span>, <span class="fl">0.0490169</span>, <span class="sc">-</span><span class="fl">0.461243207</span>, <span class="sc">-</span><span class="fl">0.2806675</span>, <span class="sc">-</span><span class="fl">0.3103141</span>)</span>
<span id="cb24-163"><a href="#cb24-163"></a>y <span class="ot">=</span> <span class="fu">c</span>(y, <span class="fl">51.4941646</span>, <span class="fl">51.4653369</span>, <span class="fl">51.5268144</span>, <span class="fl">51.5109185</span>, <span class="fl">51.6569130</span>, <span class="fl">51.589319769</span>, <span class="fl">51.2611309</span>, <span class="fl">51.6595132</span>)</span>
<span id="cb24-164"><a href="#cb24-164"></a>name <span class="ot">=</span> <span class="fu">c</span>(name, <span class="st">"LONDON_URBAN_1"</span>, <span class="st">"LONDON_URBAN_2"</span>, <span class="st">"LONDON_URBAN_3"</span>,<span class="st">"LONDON_URBAN_4"</span>, <span class="st">"LONDON_RURAL_1"</span>, <span class="st">"LONDON_RURAL_2"</span>, <span class="st">"LONDON_RURAL_3"</span>, <span class="st">"LONDON_RURAL_4"</span>)</span>
<span id="cb24-165"><a href="#cb24-165"></a></span>
<span id="cb24-166"><a href="#cb24-166"></a>x <span class="ot">=</span> <span class="fu">c</span>(x,<span class="fl">2.1599154</span>, <span class="fl">2.19904748</span>, <span class="fl">2.2230235</span>, <span class="fl">2.1670374</span>, <span class="fl">2.2290286</span>, <span class="fl">1.9649098</span>)</span>
<span id="cb24-167"><a href="#cb24-167"></a>y <span class="ot">=</span> <span class="fu">c</span>(y, <span class="fl">41.3879580</span>, <span class="fl">41.42672217</span>, <span class="fl">41.4274755</span>, <span class="fl">41.4556412</span>, <span class="fl">41.4823003</span>, <span class="fl">41.3235823</span>)</span>
<span id="cb24-168"><a href="#cb24-168"></a>name <span class="ot">=</span> <span class="fu">c</span>(name, <span class="st">"BARCELONA_URBAN_1"</span>, <span class="st">"BARCELONA_URBAN_2"</span>, <span class="st">"BARCELONA_URBAN_3"</span>, <span class="st">"BARCELONA_RURAL_1"</span>, <span class="st">"BARCELONA_RURAL_2"</span>, <span class="st">"BARCELONA_RURAL_3"</span>)</span>
<span id="cb24-169"><a href="#cb24-169"></a></span>
<span id="cb24-170"><a href="#cb24-170"></a>pts <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">name =</span> name)</span>
<span id="cb24-171"><a href="#cb24-171"></a></span>
<span id="cb24-172"><a href="#cb24-172"></a><span class="fu">library</span>(sf)</span>
<span id="cb24-173"><a href="#cb24-173"></a>sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(pts, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb24-174"><a href="#cb24-174"></a><span class="in">```</span></span>
<span id="cb24-175"><a href="#cb24-175"></a></span>
<span id="cb24-176"><a href="#cb24-176"></a>In the next step, we build a 1km 8-daily cube over Europe, convert the measurements to degree Celsius and extract the time series using the <span class="in">`extract_geom()`</span> function.</span>
<span id="cb24-177"><a href="#cb24-177"></a></span>
<span id="cb24-180"><a href="#cb24-180"></a><span class="in">```{r}</span></span>
<span id="cb24-181"><a href="#cb24-181"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">8</span>)</span>
<span id="cb24-182"><a href="#cb24-182"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>MODIS.collection, <span class="at">srs =</span> <span class="st">"EPSG:3035"</span>, <span class="at">dx =</span> <span class="dv">1000</span>, <span class="at">dy =</span> <span class="dv">1000</span>, <span class="at">dt =</span> <span class="st">"P8D"</span>)</span>
<span id="cb24-183"><a href="#cb24-183"></a><span class="fu">raster_cube</span>(MODIS.collection, v)  <span class="sc">|&gt;</span></span>
<span id="cb24-184"><a href="#cb24-184"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"LST_DAY"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-185"><a href="#cb24-185"></a>  <span class="fu">apply_pixel</span>(<span class="st">"LST_DAY * 0.02 - 273.15"</span>, <span class="st">"LST"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-186"><a href="#cb24-186"></a>  <span class="fu">extract_geom</span>(sf) <span class="ot">-&gt;</span> result</span>
<span id="cb24-187"><a href="#cb24-187"></a><span class="fu">head</span>(result, <span class="at">n =</span> <span class="dv">40</span>)</span>
<span id="cb24-188"><a href="#cb24-188"></a><span class="in">```</span></span>
<span id="cb24-189"><a href="#cb24-189"></a>The result contains FID, time, and LST as columns and we can combine the data with the original sf object with <span class="in">`merge()`</span>:</span>
<span id="cb24-190"><a href="#cb24-190"></a></span>
<span id="cb24-191"><a href="#cb24-191"></a></span>
<span id="cb24-194"><a href="#cb24-194"></a><span class="in">```{r}</span></span>
<span id="cb24-195"><a href="#cb24-195"></a>sf<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(sf)</span>
<span id="cb24-196"><a href="#cb24-196"></a>df <span class="ot">=</span> <span class="fu">merge</span>(sf, result, <span class="at">by =</span> <span class="st">"FID"</span>)</span>
<span id="cb24-197"><a href="#cb24-197"></a><span class="in">```</span></span>
<span id="cb24-198"><a href="#cb24-198"></a></span>
<span id="cb24-199"><a href="#cb24-199"></a>We can plot the time series as in the example below, showing some differences between the rural and the urban locations for Paris and Barcelona.</span>
<span id="cb24-200"><a href="#cb24-200"></a></span>
<span id="cb24-201"><a href="#cb24-201"></a><span class="in">```{r, fig.align='center'}</span></span>
<span id="cb24-202"><a href="#cb24-202"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-203"><a href="#cb24-203"></a></span>
<span id="cb24-204"><a href="#cb24-204"></a>df <span class="sc">|&gt;</span></span>
<span id="cb24-205"><a href="#cb24-205"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">startsWith</span>(name, <span class="st">"PARIS"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-206"><a href="#cb24-206"></a>  <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(time), <span class="at">y =</span> LST, <span class="at">color =</span> FID, <span class="at">group =</span> FID)) <span class="sc">+</span></span>
<span id="cb24-207"><a href="#cb24-207"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Paris"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"LST [K]"</span>)</span>
<span id="cb24-208"><a href="#cb24-208"></a>  </span>
<span id="cb24-209"><a href="#cb24-209"></a>df <span class="sc">|&gt;</span></span>
<span id="cb24-210"><a href="#cb24-210"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">startsWith</span>(name, <span class="st">"BARCELONA"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-211"><a href="#cb24-211"></a>  <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(time), <span class="at">y =</span> LST, <span class="at">color =</span> FID, <span class="at">group =</span> FID)) <span class="sc">+</span></span>
<span id="cb24-212"><a href="#cb24-212"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>()  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Barcelona"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"LST [K]"</span>)</span>
<span id="cb24-213"><a href="#cb24-213"></a><span class="in">```</span></span>
<span id="cb24-214"><a href="#cb24-214"></a></span>
<span id="cb24-215"><a href="#cb24-215"></a>A similar workflow can e.g. be used to create patterns for time series classification using the </span>
<span id="cb24-216"><a href="#cb24-216"></a><span class="co">[</span><span class="ot">`dtwSat` package</span><span class="co">](https://cran.r-project.org/package=dtwSat)</span>.</span>
<span id="cb24-217"><a href="#cb24-217"></a></span>
<span id="cb24-218"><a href="#cb24-218"></a></span>
<span id="cb24-219"><a href="#cb24-219"></a></span>
<span id="cb24-220"><a href="#cb24-220"></a></span>
<span id="cb24-221"><a href="#cb24-221"></a><span class="fu">## 3. Combining satellite observations with in-situ observations</span></span>
<span id="cb24-222"><a href="#cb24-222"></a></span>
<span id="cb24-223"><a href="#cb24-223"></a>The previous examples have used spatial features without time information. For applications where interest lies in the combination of satellite-based and in-situ observations or adding satellite observations to movement data such as animal tracks, time information is available for the spatial features (mostly points) and should be considered in the analysis. In this example, we will use primary data from the European <span class="co">[</span><span class="ot">Land Use and Coverage Area frame Survey (LUCAS)</span><span class="co">](https://ec.europa.eu/eurostat/web/lucas/)</span> containing land cover point samples from 2018. The data can be downloaded as country-wise CSV files (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://ec.europa.eu/eurostat/de/web/lucas/data/primary-data/2018)</span>). We will use observations over Germany, subset some specific crop types and combine the points with Sentinel-2 NDVI observations. </span>
<span id="cb24-224"><a href="#cb24-224"></a></span>
<span id="cb24-225"><a href="#cb24-225"></a></span>
<span id="cb24-226"><a href="#cb24-226"></a>As a first step, we load the data, remove rows with missing coordinates and convert the data.frame to an sf object. </span>
<span id="cb24-229"><a href="#cb24-229"></a><span class="in">```{r}</span></span>
<span id="cb24-230"><a href="#cb24-230"></a>x <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"https://ec.europa.eu/eurostat/cache/lucas/DE_2018_20200213.CSV"</span>)</span>
<span id="cb24-231"><a href="#cb24-231"></a>x <span class="ot">=</span> x[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">is.na</span>(x<span class="sc">$</span>TH_LAT) <span class="sc">|</span> <span class="fu">is.na</span>(x<span class="sc">$</span>TH_LONG)),]</span>
<span id="cb24-232"><a href="#cb24-232"></a>x <span class="ot">=</span> <span class="fu">st_as_sf</span>(x, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"TH_LONG"</span>, <span class="st">"TH_LAT"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span>
<span id="cb24-233"><a href="#cb24-233"></a><span class="in">```</span></span>
<span id="cb24-234"><a href="#cb24-234"></a></span>
<span id="cb24-235"><a href="#cb24-235"></a>Afterwards we extract the observation date from points and add it as a new column <span class="in">`t`</span>. </span>
<span id="cb24-236"><a href="#cb24-236"></a></span>
<span id="cb24-239"><a href="#cb24-239"></a><span class="in">```{r}</span></span>
<span id="cb24-240"><a href="#cb24-240"></a>x<span class="sc">$</span>t <span class="ot">=</span> <span class="fu">as.Date</span>(x<span class="sc">$</span>SURVEY_DATE, <span class="at">format =</span> <span class="st">"%d/%m/%y"</span>) </span>
<span id="cb24-241"><a href="#cb24-241"></a><span class="in">```</span></span>
<span id="cb24-242"><a href="#cb24-242"></a></span>
<span id="cb24-243"><a href="#cb24-243"></a>The dominant land cover type is encoded in the <span class="in">`LC1`</span> column, where a letter indicates the major class (e.g., forest, agriculture, water, or urban) that is followed by a number to identify more specific types (e.g. wheat, barley, oat, and others for class agriculture). Here, we are interested in four different crop types ("common wheat", "barley", "rye", and "maize"). Below, we select corresponding points and randomly sample 100 points for each type and add common names to the relevant land cover types.</span>
<span id="cb24-244"><a href="#cb24-244"></a></span>
<span id="cb24-245"><a href="#cb24-245"></a><span class="in">```{r, fig.align='center'}</span></span>
<span id="cb24-246"><a href="#cb24-246"></a>x[<span class="fu">startsWith</span>(x<span class="sc">$</span>LC1, <span class="fu">c</span>(<span class="st">"B11"</span>, <span class="st">"B13"</span>, <span class="st">"B14"</span>, <span class="st">"B16"</span>)), <span class="fu">c</span>(<span class="st">"LC1"</span>,<span class="st">"t"</span>)] <span class="sc">|&gt;</span></span>
<span id="cb24-247"><a href="#cb24-247"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(LC1) <span class="sc">|&gt;</span></span>
<span id="cb24-248"><a href="#cb24-248"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="ot">-&gt;</span> training</span>
<span id="cb24-249"><a href="#cb24-249"></a></span>
<span id="cb24-250"><a href="#cb24-250"></a>names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B11"</span> <span class="ot">=</span> <span class="st">"Common Wheat"</span>,</span>
<span id="cb24-251"><a href="#cb24-251"></a>          <span class="st">"B13"</span> <span class="ot">=</span> <span class="st">"Barley"</span>,</span>
<span id="cb24-252"><a href="#cb24-252"></a>          <span class="st">"B14"</span> <span class="ot">=</span> <span class="st">"Rye"</span>,</span>
<span id="cb24-253"><a href="#cb24-253"></a>          <span class="st">"B16"</span> <span class="ot">=</span> <span class="st">"Maize"</span>)</span>
<span id="cb24-254"><a href="#cb24-254"></a></span>
<span id="cb24-255"><a href="#cb24-255"></a>training<span class="sc">$</span>LC1_NAME <span class="ot">=</span> names[training<span class="sc">$</span>LC1]</span>
<span id="cb24-256"><a href="#cb24-256"></a><span class="fu">table</span>(training<span class="sc">$</span>LC1_NAME)</span>
<span id="cb24-257"><a href="#cb24-257"></a><span class="fu">plot</span>(training[,<span class="st">"LC1_NAME"</span>], <span class="at">key.pos =</span> <span class="dv">1</span>)</span>
<span id="cb24-258"><a href="#cb24-258"></a><span class="in">```</span></span>
<span id="cb24-259"><a href="#cb24-259"></a></span>
<span id="cb24-260"><a href="#cb24-260"></a>The result contains 400 samples with observations at different dates. To add NDVI measurements to the data, we now request available Sentinel-2 images from the Sentinel-2 cloud-optimized GeoTIFF collection on AWS within the area and time of interest using <span class="in">`rstac`</span>.</span>
<span id="cb24-261"><a href="#cb24-261"></a></span>
<span id="cb24-262"><a href="#cb24-262"></a></span>
<span id="cb24-265"><a href="#cb24-265"></a><span class="in">```{r}</span></span>
<span id="cb24-266"><a href="#cb24-266"></a>bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(training) </span>
<span id="cb24-267"><a href="#cb24-267"></a>bbox</span>
<span id="cb24-268"><a href="#cb24-268"></a><span class="fu">library</span>(rstac)</span>
<span id="cb24-269"><a href="#cb24-269"></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb24-270"><a href="#cb24-270"></a>items <span class="ot">=</span> s <span class="sc">|&gt;</span></span>
<span id="cb24-271"><a href="#cb24-271"></a>  <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb24-272"><a href="#cb24-272"></a>              <span class="at">bbox =</span> <span class="fu">c</span>(bbox[<span class="st">"xmin"</span>],bbox[<span class="st">"ymin"</span>],</span>
<span id="cb24-273"><a href="#cb24-273"></a>                       bbox[<span class="st">"xmax"</span>],bbox[<span class="st">"ymax"</span>]), </span>
<span id="cb24-274"><a href="#cb24-274"></a>              <span class="at">datetime =</span> <span class="st">"2018-05-01/2018-09-30"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-275"><a href="#cb24-275"></a>  <span class="fu">post_request</span>() <span class="sc">|&gt;</span> <span class="fu">items_fetch</span>(<span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-276"><a href="#cb24-276"></a><span class="in">```</span></span>
<span id="cb24-277"><a href="#cb24-277"></a></span>
<span id="cb24-278"><a href="#cb24-278"></a>The result contains <span class="in">`r length(items$features)`</span> images. Next, we load the <span class="in">`gdalcubes`</span> package, create an image collection object from the STAC result and at the same time filter images by cloud cover. </span>
<span id="cb24-279"><a href="#cb24-279"></a></span>
<span id="cb24-282"><a href="#cb24-282"></a><span class="in">```{r}</span></span>
<span id="cb24-283"><a href="#cb24-283"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb24-284"><a href="#cb24-284"></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">10</span>})</span>
<span id="cb24-285"><a href="#cb24-285"></a><span class="in">```</span></span>
<span id="cb24-286"><a href="#cb24-286"></a></span>
<span id="cb24-287"><a href="#cb24-287"></a>The collection contains 2387 remaining images with less than 10% cloud cover. Now we create a data cube at original 10m spatial resolution and use the revisit time (5 days) as temporal resolution. We also derive NDVI measurements and drop unneeded bands on-the-fly.</span>
<span id="cb24-288"><a href="#cb24-288"></a></span>
<span id="cb24-289"><a href="#cb24-289"></a></span>
<span id="cb24-292"><a href="#cb24-292"></a><span class="in">```{r}</span></span>
<span id="cb24-293"><a href="#cb24-293"></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">extent=</span>s2_collection, <span class="at">dt=</span><span class="st">"P5D"</span>, <span class="at">dx=</span><span class="dv">10</span>, <span class="at">dy=</span><span class="dv">10</span>, <span class="at">srs=</span><span class="st">"EPSG:3857"</span>, </span>
<span id="cb24-294"><a href="#cb24-294"></a>              <span class="at">aggregation =</span> <span class="st">"median"</span>, <span class="at">resampling =</span> <span class="st">"nearest"</span>)</span>
<span id="cb24-295"><a href="#cb24-295"></a></span>
<span id="cb24-296"><a href="#cb24-296"></a><span class="fu">raster_cube</span>(s2_collection, v, <span class="at">chunking =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">512</span>,<span class="dv">512</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb24-297"><a href="#cb24-297"></a>  <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B04"</span>,<span class="st">"B08"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-298"><a href="#cb24-298"></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>) <span class="ot">-&gt;</span> cube</span>
<span id="cb24-299"><a href="#cb24-299"></a>cube</span>
<span id="cb24-300"><a href="#cb24-300"></a><span class="in">```</span></span>
<span id="cb24-301"><a href="#cb24-301"></a></span>
<span id="cb24-302"><a href="#cb24-302"></a>Notice that the selection of resolution here has some important implications:</span>
<span id="cb24-303"><a href="#cb24-303"></a></span>
<span id="cb24-304"><a href="#cb24-304"></a><span class="ss">1. </span>Spatially larger pixels increase the likelihood that the pixel corresponding with a point contains different land cover classes, a moderate increasement, however, may still be helpful to include a bit of spatial context and reduce noise.</span>
<span id="cb24-305"><a href="#cb24-305"></a></span>
<span id="cb24-306"><a href="#cb24-306"></a><span class="ss">2. </span>Using a lower temporal resolution (e.g. in a monthly aggregated cube) reduces the amount of missing data (e.g. due to clouds) but of course decreases the time accuracy of measurements.</span>
<span id="cb24-307"><a href="#cb24-307"></a></span>
<span id="cb24-308"><a href="#cb24-308"></a></span>
<span id="cb24-309"><a href="#cb24-309"></a>To extract the samples from the cube, we call <span class="in">`extract_geom()`</span>, provide the training data and the name of the time column.</span>
<span id="cb24-310"><a href="#cb24-310"></a>Please notice that we use quite a few parallel worker instances (even more than the number of cores of the machine) to make downloading the data a little faster. Although the extraction will only need to download smaller patches of images that intersect (in space and time) with the points, it is still the most time consuming part of the extraction when working locally (not on AWS, where the data is stored). As a result, the extraction might take a few minutes on your local machine. </span>
<span id="cb24-311"><a href="#cb24-311"></a></span>
<span id="cb24-314"><a href="#cb24-314"></a><span class="in">```{r}</span></span>
<span id="cb24-315"><a href="#cb24-315"></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">12</span>)</span>
<span id="cb24-316"><a href="#cb24-316"></a>cubex <span class="ot">&lt;-</span> <span class="fu">extract_geom</span>(cube,training, <span class="at">time_column =</span> <span class="st">"t"</span>)</span>
<span id="cb24-317"><a href="#cb24-317"></a><span class="fu">nrow</span>(cubex)</span>
<span id="cb24-318"><a href="#cb24-318"></a><span class="in">```</span></span>
<span id="cb24-319"><a href="#cb24-319"></a></span>
<span id="cb24-320"><a href="#cb24-320"></a>Once available, notice that the number of results is smaller than the number of selected sample points simply because for some points there was no (cloud-free) image available. We can now merge the results with the point features and plot the NDVI by time for the different crop types.</span>
<span id="cb24-321"><a href="#cb24-321"></a></span>
<span id="cb24-322"><a href="#cb24-322"></a><span class="in">```{r, results='hide', warning=FALSE, fig.align='center'}</span></span>
<span id="cb24-323"><a href="#cb24-323"></a>sf <span class="ot">=</span> training</span>
<span id="cb24-324"><a href="#cb24-324"></a>sf<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(sf)</span>
<span id="cb24-325"><a href="#cb24-325"></a>df <span class="ot">=</span> <span class="fu">merge</span>(sf, cubex, <span class="at">by =</span> <span class="st">"FID"</span>)</span>
<span id="cb24-326"><a href="#cb24-326"></a></span>
<span id="cb24-327"><a href="#cb24-327"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-328"><a href="#cb24-328"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb24-329"><a href="#cb24-329"></a>p <span class="ot">=</span> <span class="fu">lapply</span>(names, <span class="cf">function</span>(x) {</span>
<span id="cb24-330"><a href="#cb24-330"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb24-331"><a href="#cb24-331"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(LC1_NAME <span class="sc">==</span> x) <span class="sc">|&gt;</span></span>
<span id="cb24-332"><a href="#cb24-332"></a>    <span class="fu">ggplot</span>( <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(t), <span class="at">y =</span> NDVI)) <span class="sc">+</span></span>
<span id="cb24-333"><a href="#cb24-333"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>) <span class="sc">+</span></span>
<span id="cb24-334"><a href="#cb24-334"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb24-335"><a href="#cb24-335"></a>    <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2018-05-01"</span>),<span class="fu">as.Date</span>(<span class="st">"2018-09-30"</span>))) <span class="sc">+</span> </span>
<span id="cb24-336"><a href="#cb24-336"></a>    <span class="fu">xlab</span>(<span class="st">"Time"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"NDVI"</span>)  <span class="sc">+</span> <span class="fu">ggtitle</span>(x)</span>
<span id="cb24-337"><a href="#cb24-337"></a>})</span>
<span id="cb24-338"><a href="#cb24-338"></a><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> p)</span>
<span id="cb24-339"><a href="#cb24-339"></a><span class="in">```</span></span>
<span id="cb24-340"><a href="#cb24-340"></a></span>
<span id="cb24-341"><a href="#cb24-341"></a></span>
<span id="cb24-342"><a href="#cb24-342"></a><span class="fu">## Further options to extract data</span></span>
<span id="cb24-343"><a href="#cb24-343"></a></span>
<span id="cb24-344"><a href="#cb24-344"></a>Notice that extraction with <span class="in">`extract_geom()`</span> is not the only possible way to extract pixels or time series from data cubes. For smaller amounts of samples, extraction can be performed entirely using the available operations <span class="in">`crop()`</span>, <span class="in">`slice_time()`</span>, <span class="in">`slice_space()`</span>, or the general selection operator <span class="in">`[`</span>. For example, extraction of a few spatiotetemporal points on the LUCAS data (see last example) can also achieved by iterating over all samples and extracting a single point using <span class="in">`cube[x$geometry, x$t]`</span>.</span>
<span id="cb24-345"><a href="#cb24-345"></a></span>
<span id="cb24-346"><a href="#cb24-346"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb24-347"><a href="#cb24-347"></a>NDVI <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb24-348"><a href="#cb24-348"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(training)) {</span>
<span id="cb24-349"><a href="#cb24-349"></a>  y <span class="ot">=</span> cube[x<span class="sc">$</span>geometry[i],x<span class="sc">$</span>t[i]]</span>
<span id="cb24-350"><a href="#cb24-350"></a>  ndvi_pixel <span class="ot">&lt;-</span> <span class="fu">as_array</span>(y)</span>
<span id="cb24-351"><a href="#cb24-351"></a>  NDVI <span class="ot">=</span> <span class="fu">c</span>(NDVI, <span class="fu">as.vector</span>(ndvi_pixel))</span>
<span id="cb24-352"><a href="#cb24-352"></a>}</span>
<span id="cb24-353"><a href="#cb24-353"></a><span class="in">```</span></span>
<span id="cb24-354"><a href="#cb24-354"></a></span>
<span id="cb24-355"><a href="#cb24-355"></a>There are of course other applications that require a different preparation of training data. As an example, gdalcubes can also be used for the creation of spatial (or even spatiotemporal) blocks in order to apply convolutional neural networks for object detection, or segmentation tasks. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
  2023 Marius Appel
  </li>  
</ul>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>